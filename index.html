<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å‚™å¿˜éŒ„</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4A90E2">

<style>
body{margin:0;font-family:-apple-system;background:#f5f5f5}

/* ===== Header ===== */
header{padding:14px 16px 6px;font-size:28px;font-weight:600}

/* ===== Search ===== */
#searchBox{width:calc(100% - 20px);margin:0 10px 10px;padding:10px;font-size:16px;border-radius:10px;border:1px solid #ddd}

/* ===== Notes ===== */
.section-title{padding:8px 14px;font-size:13px;color:#777}


/* ===== å·¦æ»‘åˆªé™¤ / å³æ»‘é‡˜é¸ï¼ˆiOS bar æ¢ï¼‰==== */
/* æ¯ä¸€åˆ—å›ºå®šé«˜åº¦ï¼Œé¿å… bar éœ²å‡º */
.note-item{
  position:relative;
  overflow:hidden;
  background:#fff;
}

/* ä¸»å…§å®¹ä¸€å®šè¦è“‹æ»¿ */
.note-main{
  position:relative;
  width:100%;
  padding:12px 14px;
  background:#fff;
  z-index:2;
  transition:transform .25s ease;
}

/* bar æ°¸é åœ¨åº•å±¤ */
.swipe-bg{
  position:absolute;
  top:0;
  bottom:0;
  width:120px;
  z-index:1;
}

.swipe-bg.delete{
  right:0;
  background:#ff3b30;
}

.swipe-bg.pin{
  left:0;
  background:#ffcc00;
  color:#333;
}
/* ======================================= */


.note-item.pinned{background:#fff8dc}

.note-title{
  font-size:16px;
  font-weight:500;
  display:-webkit-box;
  -webkit-line-clamp:1;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

.note-sub{
  font-size:12px;
  color:#888;
  display:-webkit-box;
  -webkit-line-clamp:1;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

.note-item{
  position:relative;
  background:white;
}
.note-item::after{
  content:"ğŸ—‘ åˆªé™¤";
  position:absolute;
  right:14px;
  top:50%;
  transform:translateY(-50%);
  font-size:18px;
  color:#d33;
  display:none;
}
.note-item.show-delete::after{
  display:block;
}



/* =====åˆ—è¡¨å¯ä¸Šä¸‹æ»‘    æ•´é«”ç•«é¢ä¸å¯å·¦å³æ»‘  ===== */
html, body {
  overscroll-behavior: none;
  touch-action: pan-y;
}

.note-item {
  touch-action: pan-y pinch-zoom;
}
/* ====================================== */


/* ===== FAB ===== */
#fab{position:fixed;right:18px;bottom:18px;width:56px;height:56px;border-radius:50%;font-size:32px}

/* ===== Context Menu ===== */
#contextMenu{position:fixed;background:#fff;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.25);display:none;z-index:9999}
#contextMenu div{padding:10px 14px;cursor:pointer}
#contextMenu div:hover{background:#f0f0f0}

/* ===== Editor ===== */
#editor{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#f5f5f5;flex-direction:column}
#editorHeader{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#4A90E2;color:white}
#editorToolbar{display:flex;padding:6px 10px;background:#eee;gap:6px;flex-wrap:wrap}
#editorToolbar button{padding:6px 10px;border:none;border-radius:6px;background:white;cursor:pointer;font-weight:bold;}
#editorToolbar button:hover{background:#ddd;}
#editorContent{flex:1;padding:10px;display:flex;flex-direction:column}
#editorContent input,#editorContent textarea{width:100%;padding:10px;margin-bottom:8px;font-size:16px;border-radius:10px;border:1px solid #ccc;resize:none;}
/* ===== Editor Swipe Hint ===== */
#editorSwipeHint{
  position:fixed;
  top:0;left:0;
  width:100%;height:100%;
  display:none;
  align-items:center;
  justify-content:flex-start;
  padding-left:20px;
  font-size:22px;
  font-weight:600;
  color:#4A90E2;
  background:rgba(245,245,245,.85);
  z-index:9998;
  pointer-events:none;
}

</style>
</head>

<body>

<header style="display:flex;justify-content:space-between;align-items:center;">
  <span>å‚™å¿˜éŒ„</span>
  <button onclick="toggleTopMenu(event)">â‹¯</button>
</header>

<input id="searchBox" placeholder="ğŸ” æœå°‹">

<div id="noteList"></div>
<button id="fab" onclick="newNote()">ï¼‹</button>
<div id="contextMenu"></div>

<!-- ===== Editor ===== -->
<div id="editor">
  <div id="editorHeader">
    <button onclick="closeEditor()">è¿”å›åˆ—è¡¨</button>
    <button onclick="saveEditor()">å­˜æª”</button>
  </div>
  <div id="editorToolbar">
    <button onclick="formatText('bold')">B</button>
    <button onclick="formatText('italic')">I</button>
    <button onclick="formatText('underline')">U</button>
    <button onclick="insertTable()">è¡¨æ ¼</button>
    <button onclick="insertImage()">åœ–ç‰‡</button>
    <button onclick="insertVideo()">å½±ç‰‡</button>
  </div>
<div id="editorContent">
  <div id="content" contenteditable="true" style="flex:1; padding:10px; border:1px solid #ccc; border-radius:10px; overflow:auto;" placeholder="é–‹å§‹è¼¸å…¥â€¦"></div>
</div>

</div>

<!-- âœ… å°±æ”¾åœ¨é€™è£¡ -->
<div id="editorSwipeHint">â¬… è¿”å›åˆ—è¡¨</div>


<div id="topMenu" style="
  position:fixed;
  top:60px;
  right:10px;
  background:#fff;
  border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,.25);
  display:none;
  z-index:9999;">
</div>




<input type="file" id="backupFile" style="display:none" accept=".json">

<input type="file" id="imgPicker" accept="image/*" hidden>


<script>
/* ========= IndexedDB ========= */
const DB_NAME="notesDB",STORE="notes";
let db,currentId=null;

function openDB(){return new Promise(r=>{const q=indexedDB.open(DB_NAME,1);q.onupgradeneeded=e=>{e.target.result.createObjectStore(STORE,{keyPath:"id"});};q.onsuccess=e=>{db=e.target.result;r();};});}
function tx(m){return db.transaction(STORE,m).objectStore(STORE);}
function save(n){tx("readwrite").put(n);}
function all(){return new Promise(r=>{const q=tx("readonly").getAll();q.onsuccess=()=>r(q.result);});}

/* ========= Crypto ========= */
async function keyFromPassword(pw,salt){
 const enc=new TextEncoder();
 const base=await crypto.subtle.importKey("raw",enc.encode(pw),"PBKDF2",false,["deriveKey"]);
 return crypto.subtle.deriveKey({name:"PBKDF2",salt,iterations:100000,hash:"SHA-256"},base,{name:"AES-GCM",length:256},false,["encrypt","decrypt"]);
}
function rand(n){return crypto.getRandomValues(new Uint8Array(n));}
async function encryptText(t,pw){
 const iv=rand(12),salt=rand(16);
 const key=await keyFromPassword(pw,salt);
 const buf=await crypto.subtle.encrypt({name:"AES-GCM",iv},key,new TextEncoder().encode(t));
 return{iv:[...iv],salt:[...salt],data:[...new Uint8Array(buf)]};
}
async function decryptText(o,pw){
 const key=await keyFromPassword(pw,new Uint8Array(o.salt));
 const buf=await crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(o.iv)},key,new Uint8Array(o.data));
 return new TextDecoder().decode(buf);
}


/* ========= 
âœ… iOS å…©è¡Œé¡¯ç¤º

âœ… å·¦æ»‘åˆªé™¤

âœ… å³æ»‘é‡˜é¸

âœ… å³éµé¸å–®ï¼ˆæ¡Œæ©Ÿå¥½ç”¨ï¼‰

âŒ ä¸æ”¾æ‹–æ›³ï¼ˆå¯å†åŠ ï¼‰

========= */

/* ========= Render ========= */
const list=document.getElementById("noteList");


// å…¨åŸŸæœå°‹æ¡†
const searchInput = document.getElementById("searchBox");

// é«˜äº®å‡½å¼
function highlight(text, keyword){
  if(!keyword) return text;
  const re = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`, "gi");
  return text.replace(re, '<mark>$1</mark>');
}

// åˆ·æ–°åˆ—è¡¨æ™‚ï¼Œå°‡é—œéµå­—å¸¶å…¥
async function refresh(){
  const q = searchInput.value.trim().toLowerCase();
  const ns = await all();
  list.innerHTML = "";
  const pinned = ns.filter(n => n.pinned);
  const normal = ns.filter(n => !n.pinned);
  if(pinned.length){
    list.innerHTML += `<div class="section-title">å·²é‡˜é¸</div>`;
    pinned.forEach(n => renderNote(n, q));
  }
  normal.forEach(n => renderNote(n, q));
}


// renderNote æ”¹æˆæ¥æ”¶é—œéµå­—
function renderNote(n, keyword = ""){
  if(!n.timestamp) n.timestamp = Date.now();

  const text = typeof n.content === "string" ? n.content : "";
  const date = new Date(n.timestamp).toLocaleDateString();

  let first = text.replace(/\n/g," ");
  let display1 = first.slice(0, 20);
  let display2 = first.slice(20);

  // é«˜äº®é—œéµå­—
  display1 = highlight(display1, keyword);
  display2 = highlight(display2, keyword);

  const d = document.createElement("div");
  d.className = "note-item" + (n.pinned ? " pinned" : "");

  d.innerHTML = `
    <div class="swipe-bg delete">ğŸ—‘</div>
    <div class="swipe-bg pin">ğŸ“Œ</div>
    <div class="note-main">
      <div class="note-title">${display1 || "ç„¡å…§å®¹"}</div>
      <div class="note-sub">${date} ${display2}</div>
    </div>
  `;

  d.onclick = () => openEditor(n);

  d.oncontextmenu = e=>{
    e.preventDefault();
    currentId = n.id;
    showMenu(e.pageX, e.pageY);
  };

  list.appendChild(d);
  addSwipeListeners(d,n);
}





/* ========= Editor ========= */
const editor=document.getElementById("editor");
const contentI=document.getElementById("content");


/* ========= æ‰“é–‹ç·¨è¼¯å™¨æ™‚åªé¡¯ç¤ºå…§å®¹ ========= */
function openEditor(n){
  currentId = n.id;
  if(n.encrypted){
    contentI.innerHTML = "ğŸ”’ å·²åŠ å¯†ï¼Œè«‹è§£å¯†";
    contentI.contentEditable = false;
  } else {
    contentI.innerHTML = n.content || "";
    contentI.contentEditable = true;
  }

  document.getElementById("noteList").style.display = "none";
  document.getElementById("fab").style.display = "none";
  document.getElementById("searchBox").style.display = "none";

  editor.style.display = "flex";
}



function closeEditor(){
 editor.style.display = "none";

 // ğŸ”¥ å›åˆ°åˆ—è¡¨
 document.getElementById("noteList").style.display = "";
 document.getElementById("fab").style.display = "";
 document.getElementById("searchBox").style.display = "";
}


/* ========= å­˜æª”æ™‚è‡ªå‹•æ‹†ç¬¬ä¸€è¡Œç•¶æ¨™é¡Œ ========= */
function saveEditor(){
  if(!currentId) return;

  all().then(ns=>{
    const n = ns.find(x=>x.id===currentId);
    if(!n || n.encrypted) return;

    const html = contentI.innerHTML;  // âœ… æŠ“å– contenteditable HTML
    const text = contentI.innerText.trim(); // å¯æ‹†ç¬¬ä¸€è¡Œç•¶æ¨™é¡Œ
    const lines = text.split("\n");

    n.title = lines[0] || "";
    n.content = html;  // âœ… å­˜ HTML è€Œä¸æ˜¯ value

    save(n);
    refresh();
  });
}



/* ========= New ========= */
function newNote(){
 const n={id:Date.now().toString(),title:"",content:"",encrypted:false,pinned:false,timestamp:Date.now()};
 save(n);openEditor(n);
}

/* ========= Context / Top Menu å…±ç”¨å…§å®¹ ========= */
const menuHTML = `
<div onclick="ctxEncrypt()">ğŸ” åŠ å¯†</div>
<div onclick="ctxDecrypt(false)">ğŸ”“ è§£å¯†ï¼ˆæš«æ™‚ï¼‰</div>
<div onclick="ctxDecrypt(true)">ğŸ”“ è§£å¯†ä¸¦è§£é™¤</div>
<div onclick="exportSingleNote()">ğŸ“¤ åŒ¯å‡ºå–®ç­†</div>
<div onclick="exportAllNotes()">ğŸ“¦ åŒ¯å‡ºå…¨éƒ¨</div>
<div onclick="document.getElementById('backupFile').click()">ğŸ“¥ åŒ¯å…¥</div>
<div onclick="deleteCurrent()">ğŸ—‘ åˆªé™¤</div>
`;


/* ========= Context Menu ========= */
const menu = document.getElementById("contextMenu");
const topMenu = document.getElementById("topMenu");

menu.innerHTML = menuHTML;
topMenu.innerHTML = menuHTML;


function showMenu(x,y){
  menu.style.left = x + "px";
  menu.style.top  = y + "px";
  menu.style.display = "block";
}

function toggleTopMenu(e){
  e.stopPropagation(); // ğŸ”¥ é—œéµ
  topMenu.style.display =
    topMenu.style.display === "block" ? "none" : "block";
}



document.body.addEventListener('click', e=>{
  const clickInContextMenu = e.target.closest('#contextMenu');
  const clickInTopMenu     = e.target.closest('#topMenu');
  const clickInHeader      = e.target.closest('header');

  if(!clickInContextMenu && !clickInTopMenu && !clickInHeader){
    menu.style.display = "none";
    topMenu.style.display = "none";
  }
});

/* ========= Encrypt / Decrypt (prompt) ========= */
async function ctxEncrypt(){
 const pw=prompt("è«‹è¼¸å…¥åŠ å¯†å¯†ç¢¼"); if(!pw)return;
 const ns=await all(); const n=ns.find(x=>x.id===currentId);
 n.content=await encryptText(n.content,pw); n.encrypted=true; save(n); refresh();
}
async function ctxDecrypt(permanent){
 const pw=prompt("è«‹è¼¸å…¥è§£å¯†å¯†ç¢¼"); if(!pw)return;
 const ns=await all(); const n=ns.find(x=>x.id===currentId);
 try{
  const txt=await decryptText(n.content,pw);
  if(permanent){n.content=txt;n.encrypted=false;save(n);refresh();}
  else alert(txt);
 }catch{alert("âŒ è§£å¯†å¤±æ•—");}
}

/* ========= Delete ========= */
async function deleteCurrent(){
 const ns=await all(); const n=ns.find(x=>x.id===currentId);
 if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ"))return;
 tx("readwrite").delete(n.id); refresh();
}

/* ========= Export / Import ========= */
function downloadFile(c,f){
 const b=new Blob([c],{type:"application/json"});
 const u=URL.createObjectURL(b);
 const a=document.createElement("a");a.href=u;a.download=f;
 document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);
}

async function exportSingleNote(){
 const ns=await all(); const n=ns.find(x=>x.id===currentId);
 let txt=n.content;
 if(n.encrypted){const pw=prompt("è¼¸å…¥åŸå¯†ç¢¼");txt=await decryptText(n.content,pw);}
 const bpw=prompt("å‚™ä»½å¯†ç¢¼"); if(!bpw)return;
 const enc=await encryptText(txt,bpw);
 downloadFile(JSON.stringify({title:n.title,content:"enc:"+JSON.stringify(enc)},null,2),`${n.title||"note"}.json`);
}

async function exportAllNotes(){
 const ns=await all();
 const upw=prompt("è¼¸å…¥åŸè§£å¯†å¯†ç¢¼"); const bpw=prompt("å‚™ä»½å¯†ç¢¼");
 const out={};
 for(const n of ns){
  let txt=n.content;
  if(n.encrypted) txt=await decryptText(n.content,upw);
  out[n.id]={title:n.title,content:"enc:"+JSON.stringify(await encryptText(txt,bpw)),timestamp:n.timestamp};
 }
 downloadFile(JSON.stringify(out,null,2),`notes-backup.json`);
}

document.getElementById("backupFile").onchange=async e=>{
 const f=e.target.files[0]; if(!f)return;
 const pw=prompt("è¼¸å…¥å‚™ä»½å¯†ç¢¼"); if(!pw)return;
 const data=JSON.parse(await f.text());
 if(data.content){
  const t=await decryptText(JSON.parse(data.content.slice(4)),pw);
  save({id:Date.now().toString(),title:data.title,content:t,encrypted:false,timestamp:Date.now()});
 }else{
  for(const k in data){
   const t=await decryptText(JSON.parse(data[k].content.slice(4)),pw);
   save({id:k,title:data[k].title,content:t,encrypted:false,timestamp:data[k].timestamp});
  }
 }
 refresh();
};

/* ========= Editor Toolbar Functions ========= */
function formatText(cmd){
  document.execCommand(cmd, false, null);
}



function insertTable(){
  const textarea = contentI;
  const table = `|  |  |\n|--|--|\n|  |  |\n`;
  const pos = textarea.selectionStart;
  textarea.setRangeText(table, pos, pos, 'end');
}




/* ========= æ’å…¥åœ–ç‰‡ ========= */
function insertImage(){
  document.getElementById("imgPicker").click();
}

imgPicker.onchange = e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    const img = document.createElement("img");
    img.src = reader.result;
    img.style.maxWidth = "100%";
    img.style.display = "block";
    img.style.margin = "5px 0";

    const sel = window.getSelection();
    if(!sel.rangeCount) return;
    const range = sel.getRangeAt(0);
    range.insertNode(img);
    range.collapse(false);

    const br = document.createElement("br");
    range.insertNode(br);
  };
  reader.readAsDataURL(file);
};



/* ========= æ’å…¥å½±ç‰‡ ========= */
function insertVideo(){
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "video/*";
  input.click();

  input.onchange = e => {
    const file = e.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      const video = document.createElement("video");
      video.src = reader.result;
      video.controls = true;
      video.style.maxWidth = "100%";
      video.style.display = "block";
      video.style.margin = "5px 0";

      const sel = window.getSelection();
      if(!sel.rangeCount) return;

      const range = sel.getRangeAt(0);
      range.insertNode(video);
      range.collapse(false);

      const br = document.createElement("br");
      range.insertNode(br);
    };
    reader.readAsDataURL(file);
  };
}


/* ========= å·¦å³æ»‘å®Œæ•´é‚è¼¯ ========= */
function addSwipeListeners(item, note){
  let sx = null, dx = 0;
  const main = item.querySelector(".note-main");
  const deleteBtn = item.querySelector(".swipe-bg.delete");
  const pinBtn = item.querySelector(".swipe-bg.pin");

  // ç¦æ­¢æ»‘å‹•é»æ“Šå†’æ³¡
  function stopClick(e){ e.stopPropagation(); }

  item.addEventListener("pointerdown", e => {
    sx = e.clientX;
    item.setPointerCapture(e.pointerId);
    main.style.transition = "none";
  });

  item.addEventListener("pointermove", e => {
    if(sx === null) return;
    dx = e.clientX - sx;

    // é˜»æ­¢å·¦å³èª¤è§¸é»æ“Šæ‰“é–‹ç·¨è¼¯å™¨
    if(Math.abs(dx) > 5) main.dataset.dragging = true;

    // å·¦å³æ»‘å‹•
    if(dx < 0){ // å·¦æ»‘ â†’ é¡¯ç¤ºåˆªé™¤
      main.style.transform = `translateX(${Math.max(dx, -120)}px)`;
    } else { // å³æ»‘ â†’ é¡¯ç¤ºé‡˜é¸
      main.style.transform = `translateX(${Math.min(dx, 120)}px)`;
    }
  });

  item.addEventListener("pointerup", e => {
    item.releasePointerCapture(e.pointerId);
    main.style.transition = "transform .25s ease";

    if(dx < -60){ // å·¦æ»‘è¶…éé–¾å€¼ â†’ å®šä½
      main.style.transform = "translateX(-120px)";
    } else if(dx > 60){ // å³æ»‘è¶…éé–¾å€¼ â†’ å®šä½
      main.style.transform = "translateX(120px)";
    } else { // å›å½ˆ
      main.style.transform = "translateX(0)";
    }

    // é‡ç½®æ‹–æ›³æ¨™è¨˜
    setTimeout(()=>{ delete main.dataset.dragging; }, 50);

    sx = null; dx = 0;
  });

  // é»æ“Šåˆªé™¤æŒ‰éˆ•
  deleteBtn.addEventListener("click", e => {
    e.stopPropagation();
    tx("readwrite").delete(note.id);
    refresh();
  });

  // é»æ“Šé‡˜é¸æŒ‰éˆ•
  pinBtn.addEventListener("click", e => {
    e.stopPropagation();
    note.pinned = !note.pinned;
    save(note);
    refresh();
  });

  // é»æ“Šä¸»å…§å®¹æ‰é–‹ç·¨è¼¯å™¨
  main.addEventListener("click", e => {
    if(main.dataset.dragging) return; // æ‹–æ›³ä¸æ‰“é–‹
    openEditor(note);
  });
}



/* ========= Editor Swipe Back (Safe Version) ========= */
(()=>{
  let sx=null, dx=0;
  const hint=document.getElementById("editorSwipeHint");
  const TH=120;
  const EDGE=20; // ğŸ”¥ åªæœ‰å·¦é‚Š 20px æ‰å•Ÿå‹•è¿”å›

  editor.addEventListener("pointerdown",e=>{
    // âŒ é»åœ¨æŒ‰éˆ• / input / textarea ä¸è™•ç†
    if(e.target.closest("button,input,textarea")) return;

    // âŒ ä¸æ˜¯å¾å·¦é‚Šç·£é–‹å§‹ï¼Œä¸è™•ç†
    if(e.clientX > EDGE) return;

    sx=e.clientX;
    dx=0;
    editor.setPointerCapture(e.pointerId);
  });

  editor.addEventListener("pointermove",e=>{
    if(sx===null) return;
    dx=e.clientX-sx;

    if(dx>30){
      hint.style.display="flex";
      e.preventDefault();
    }
  });

  editor.addEventListener("pointerup",e=>{
    if(sx!==null){
      editor.releasePointerCapture(e.pointerId);
    }

    hint.style.display="none";

    if(dx>TH){
      closeEditor();
    }

    sx=null;
    dx=0;
  });

})();



/* ========= Search ========= */
document.getElementById("searchBox").addEventListener("input", async e=>{
  const q = e.target.value.toLowerCase();
  const ns = await all();
  list.innerHTML = "";
  ns.filter(n =>
    typeof n.content === "string" &&
    n.content.toLowerCase().includes(q)
  ).forEach(renderNote);
});


// ğŸ”¹ åˆå§‹åŒ–æ™‚ç¶ä¸€æ¬¡æœå°‹äº‹ä»¶
searchInput.addEventListener("input", refresh);

// ğŸ”¹ æœ€å¾Œå•Ÿå‹• DB ä¸¦åˆ·æ–°åˆ—è¡¨
openDB().then(refresh);

</script>

</body>
</html>
