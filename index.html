æœ‰é—œæ‰‹æ©Ÿä»‹é¢æ’å…¥è¡¨æ ¼å¾Œï¼Œ ğŸ‘‰ ç„¡æ³•æ‰‹æŒ‡æ‹–æ›³ï¼šExcel å¼é€£çºŒé¸å– ğŸ‘‰ ç„¡æ³•åœä½ 0.5 ç§’ä¸å‹•ï¼šè¡¨æ ¼åŠŸèƒ½é¸å–®è·³å‡ºï¼Œå¯ä»¥å¹«æˆ‘ä¿®æ­£


<script>



/* ========= Context / Top Menu å…±ç”¨å…§å®¹ ========= */
const menuHTML = `
<div onclick="ctxEncrypt()">ğŸ” åŠ å¯†</div>
<div onclick="ctxDecrypt(false)">ğŸ”“ è§£å¯†ï¼ˆæš«æ™‚ï¼‰</div>
<div onclick="ctxDecrypt(true)">ğŸ”“ è§£å¯†ä¸¦è§£é™¤</div>
<div onclick="exportSingleNote()">ğŸ“¤ åŒ¯å‡ºå–®ç­†</div>
<div onclick="exportAllNotes()">ğŸ“¦ åŒ¯å‡ºå…¨éƒ¨</div>
<div onclick="document.getElementById('backupFile').click()">ğŸ“¥ åŒ¯å…¥</div>
<div onclick="deleteCurrent()">ğŸ—‘ åˆªé™¤</div>
 <div onclick="confirmPasswordAndDelete()">ğŸ—‘ å…¨éƒ¨åˆªé™¤</div> <!-- æ–°å¢ã€Œå…¨éƒ¨åˆªé™¤ã€é¸é … -->
`;


/* ========= Context Menu ========= */
const menu = document.getElementById("contextMenu");

  // é¡¯ç¤ºå³éµèœå–®
  function showMenu(event, note) {
    event.preventDefault(); // é˜»æ­¢å³éµèœå–®çš„é»˜èªè¡Œç‚º
    menu.innerHTML = menuHTML; // ç¢ºä¿èœå–®å…§å®¹æ˜¯æœ€æ–°çš„

    // è¨­ç½®èœå–®çš„ä½ç½®
    menu.style.left = `${event.clientX}px`;
    menu.style.top = `${event.clientY}px`;
    menu.style.display = "block";

    // ç‚ºæ¯å€‹èœå–®é …ç¶å®šå°æ‡‰çš„åŠŸèƒ½
    menu.querySelector("div[onclick='ctxEncrypt()']").onclick = () => ctxEncrypt(note);
    menu.querySelector("div[onclick='ctxDecrypt(false)']").onclick = () => ctxDecrypt(false, note);
    menu.querySelector("div[onclick='ctxDecrypt(true)']").onclick = () => ctxDecrypt(true, note);
    menu.querySelector("div[onclick='exportSingleNote()']").onclick = () => exportSingleNote(note);
    menu.querySelector("div[onclick='deleteCurrent()']").onclick = () => deleteCurrent(note);
    
    // éš±è—åŸåˆ—è¡¨å€å³ä¸Šè§’çš„åŠŸèƒ½
    document.getElementById("topMenu").style.display = "none";
  }

  // è¨»å†Šå³éµäº‹ä»¶
  function addContextMenuToNoteItem(noteItem, note) {
    noteItem.addEventListener('contextmenu', (event) => showMenu(event, note));
  }


/* ========= Encrypt / Decrypt (prompt) ========= */
 // åœ¨ä¿å­˜ç­†è¨˜æ™‚è¨˜éŒ„é¸æ“‡çš„ ID
  async function ctxEncrypt(note) {
    const pw = prompt("è«‹è¼¸å…¥åŠ å¯†å¯†ç¢¼");
    if (!pw) return;

    note.content = await encryptText(note.content, pw);
    note.encrypted = true;
    save(note);
    refresh();
  }

  async function ctxDecrypt(permanent, note) {
    const pw = prompt("è«‹è¼¸å…¥è§£å¯†å¯†ç¢¼");
    if (!pw) return;

    try {
      const txt = await decryptText(note.content, pw);
      if (permanent) {
        note.content = txt;
        note.encrypted = false;
        save(note);
        refresh();
      } else {
        alert(txt);
      }
    } catch {
      alert("è§£å¯†å¤±æ•—");
    }
  }

async function exportSingleNote(note) {
  let txt = note.content;

  if (note.encrypted) {
    const pw = prompt("è¼¸å…¥åŸå¯†ç¢¼");
    if (!pw) return;
    txt = await decryptText(note.content, pw);
  }

  const bpw = prompt("å‚™ä»½å¯†ç¢¼");
  if (!bpw) return;

  const enc = await encryptText(txt, bpw);

  downloadFile(
    JSON.stringify({
      title: note.title,
      content: "enc:" + JSON.stringify(enc),
      timestamp: note.timestamp
    }, null, 2),
    `${note.title || "note"}.json`
  );
}

/* ========= æ–°å¢ã€Œå…¨éƒ¨åˆªé™¤ã€é¸é …  ========= */

// åˆªé™¤æ‰€æœ‰ç­†è¨˜çš„æ“ä½œ
async function deleteAllNotes() {
    const notes = await all();
    const txObject = tx("readwrite");
    notes.forEach(note => txObject.delete(note.id));  // åˆªé™¤æ‰€æœ‰ç­†è¨˜
    alert("æ‰€æœ‰ç­†è¨˜å·²æˆåŠŸåˆªé™¤ï¼");
    refresh();  // é‡æ–°æ•´ç†åˆ—è¡¨
}



//==== 2. è¡¨æ ¼è¨­ç½®ï¼Œä¸¦åŠ å…¥åˆä½µ/åˆ†å‰²åŠŸèƒ½====å®Œå…¨ç¬¦åˆ Excel å¼çš„è¡¨æ ¼çµæ§‹

function insertTable(rows = 5, cols = 5) {
  const table = document.createElement("table");
  table.className = "note-table";
  table.setAttribute("contenteditable", "false");
  table.style.borderCollapse = "collapse";
  table.style.margin = "8px 0";

  for (let r = 0; r <= rows; r++) {
    const tr = document.createElement("tr");

    for (let c = 0; c <= cols; c++) {
      const td = document.createElement("td");
      td.style.border = "1px solid #ccc";
      td.style.minWidth = "80px";
      td.style.height = "32px";

      // â”€â”€â”€â”€â”€ å·¦ä¸Šè§’ï¼ˆç©ºç™½ï¼‰â”€â”€â”€â”€â”€
      if (r === 0 && c === 0) {
        td.className = "corner-cell";
        td.contentEditable = "false";
        td.innerHTML = "";
      }

      // â”€â”€â”€â”€â”€ æ¬„æ¨™é¡Œ A B C â”€â”€â”€â”€â”€
      else if (r === 0) {
        td.className = "col-header";
        td.contentEditable = "false";
        td.innerHTML = String.fromCharCode(64 + c); // A B C
      }

      // â”€â”€â”€â”€â”€ åˆ—æ¨™é¡Œ 1 2 3 â”€â”€â”€â”€â”€
      else if (c === 0) {
        td.className = "row-header";
        td.contentEditable = "false";
        td.innerHTML = r;
      }

      // â”€â”€â”€â”€â”€ çœŸæ­£è³‡æ–™æ ¼ï¼ˆA1 é–‹å§‹ï¼‰â”€â”€â”€â”€â”€
      else {
        td.className = "data-cell";
        td.contentEditable = "true";
        td.innerHTML = "\u200B"; // é›¶å¯¬å­—
      }

      tr.appendChild(td);
    }

    table.appendChild(tr);
  }

  insertNodeAtCursor(table);

  // æ¸¸æ¨™æ”¾åœ¨ A1
  const firstDataCell = table.querySelector(".data-cell");
  placeCaretInsideCell(firstDataCell);

  enableExcelSelection(table);
  addColumnResizers(table);
  addRowResizers(table);

  contentI.dispatchEvent(new Event("input"));
}



// ===== å•Ÿç”¨è¡¨æ ¼é¸å–åŠŸèƒ½ =====
let anchorCell = null;
let isDragging = false;
let dragStartCell = null;

function resetTableSelectionState() {
  anchorCell = null;
  dragStartCell = null;
  isDragging = false;
  clearCellSelection();
}


contentI.addEventListener("focus", () => {
  resetTableSelectionState();
});



let longPressTimer = null;
const LONG_PRESS_TIME = 500; // ms


function startLongPress(e, td) {
  cancelLongPress();

  longPressTimer = setTimeout(() => {
    // â­ åªæœ‰ã€Œæ²’æœ‰æ‹–å‹•ã€æ‰çœŸçš„ç®—é•·æŒ‰
    if (!mobileHasMoved) {
      handleTableContextMenu(e, td);
    }
  }, LONG_PRESS_TIME);
}

function cancelLongPress() {
  if (longPressTimer) {
    clearTimeout(longPressTimer);
    longPressTimer = null;
  }
}


let mobileSelecting = false;
let mobileStartCell = null;
let mobileHasMoved = false;


contentI.addEventListener("touchstart", e => {
  const td = e.target.closest("td.data-cell");
  if (!td) return;

  mobileSelecting = true;
  mobileHasMoved = false;
  mobileStartCell = td;

  clearCellSelection();
  td.classList.add("selected");

  anchorCell = td;
  activeCell = td;

  // â­ å•Ÿå‹•é•·æŒ‰ï¼ˆä½†å…ˆä¸è¦ preventDefaultï¼‰
  startLongPress(e, td);
});


contentI.addEventListener("touchmove", e => {
  if (!mobileSelecting) return;

  mobileHasMoved = true;
  cancelLongPress();

  const touch = e.touches[0];
  const td = getCellFromTouch(touch);
  if (!td) return;

  clearCellSelection();
  selectRect(mobileStartCell, td);

  // â­ åªæœ‰çœŸçš„æ‹–å‹•ï¼Œæ‰é˜»æ­¢ç•«é¢
  e.preventDefault();
}, { passive: false });



function endMobileSelection() {
  mobileSelecting = false;
  mobileStartCell = null;
}

contentI.addEventListener("touchend", endMobileSelection);
contentI.addEventListener("touchcancel", endMobileSelection);


//  touchendï¼ˆåˆ†æµã€Œæ‹–æ›³ã€vsã€Œé•·æŒ‰ã€ï¼‰
contentI.addEventListener("touchend", e => {
  if (!mobileSelecting) return;

  // âŒ æœ‰æ‹–å‹• â†’ ä¸ç®—é•·æŒ‰
  if (mobileHasMoved) {
    cancelLongPress();
  }

  mobileSelecting = false;
  mobileStartCell = null;
});


contentI.addEventListener("touchend", () => {
  cancelLongPress();

  mobileSelecting = false;
  mobileStartCell = null;
});


function handleTableContextMenu(e, td) {
  e.preventDefault();

  activeTable = td.closest("table");
  activeMedia = null;

  const selected = getSelectedDataCells();

  // æ²’æœ‰ selection æ‰é¸å–é€™ä¸€æ ¼
  if (selected.length === 0) {
    clearCellSelection();
    td.classList.add("selected");
    anchorCell = td;
  }

  activeCell = getSelectedDataCells()[0] || td;

  const menu = document.getElementById("tableMenu");

  const x = e.touches ? e.touches[0].clientX : e.clientX;
  const y = e.touches ? e.touches[0].clientY : e.clientY;

  menu.style.left = x + "px";
  menu.style.top = y + "px";
  menu.style.display = "block";

  document.getElementById("mediaMenu").style.display = "none";
}

contentI.addEventListener("contextmenu", e => {
  const td = e.target.closest("td.data-cell");
  const media = e.target.closest("img, video");

  if (td) {
    e.preventDefault();
    e.stopPropagation();
    handleTableContextMenu(e, td);
    return;
  }

  if (media) {
    e.preventDefault();
    activeMedia = media;
    activeCell = null;
    activeTable = null;

    const menu = document.getElementById("mediaMenu");
    menu.style.left = e.clientX + "px";
    menu.style.top = e.clientY + "px";
    menu.style.display = "block";

    document.getElementById("tableMenu").style.display = "none";
  }
});


function selectRect(cellA, cellB) {
  const table = cellA.closest("table");

  const r1 = cellA.parentElement.rowIndex;
  const c1 = cellA.cellIndex;
  const r2 = cellB.parentElement.rowIndex;
  const c2 = cellB.cellIndex;

  const rMin = Math.min(r1, r2);
  const rMax = Math.max(r1, r2);
  const cMin = Math.min(c1, c2);
  const cMax = Math.max(c1, c2);

  for (let r = rMin; r <= rMax; r++) {
    for (let c = cMin; c <= cMax; c++) {
      const cell = table.rows[r]?.cells[c];
      if (cell && cell.classList.contains("data-cell")) {
        cell.classList.add("selected");
      }
    }
  }
}

contentI.addEventListener("pointerdown", e => {
  // â­ æ‰‹æ©Ÿä¸èµ° pointer é¸å–
  if (e.pointerType === "touch") return;

  const td = e.target.closest("td.data-cell");
  if (!td) return;

  clearCellSelection();
  td.classList.add("selected");

  anchorCell = td;
  dragStartCell = td;
  isDragging = true;
});

contentI.addEventListener("pointermove", e => {
  if (!isDragging) return;

  const td = e.target.closest("td.data-cell");
  if (!td) return;

  clearCellSelection();
  selectRect(dragStartCell, td);
});


document.addEventListener("pointerup", () => {
  isDragging = false;
  dragStartCell = null;
});


function clearCellSelection() {
  document
    .querySelectorAll(".note-table td.selected")
    .forEach(td => td.classList.remove("selected"));
}


function addRowResizers(table) {
  table.querySelectorAll("tr").forEach(tr => {
    if (tr.querySelector(".row-resizer")) return;

    const grip = document.createElement("div");
    grip.className = "row-resizer";
    tr.style.position = "relative";
    tr.appendChild(grip);

    grip.addEventListener("pointerdown", e => {
      e.preventDefault();
      const startY = e.clientY;
      const startH = tr.offsetHeight;

      const move = ev => {
        tr.style.height = startH + (ev.clientY - startY) + "px";
      };

      const up = () => {
        document.removeEventListener("pointermove", move);
        document.removeEventListener("pointerup", up);
        contentI.dispatchEvent(new Event("input"));
      };

      document.addEventListener("pointermove", move);
      document.addEventListener("pointerup", up);
    });
  });
}


function placeCaretInsideCell(td) {
  td.focus();

  if (td.innerHTML === "") {
    td.innerHTML = "\u200B";
  }

  const range = document.createRange();
  const sel = window.getSelection();
  range.selectNodeContents(td);
  range.collapse(true);
  sel.removeAllRanges();
  sel.addRange(range);
}



let selectedCells = new Set();


contentI.addEventListener("mousedown", e => {

  // â­ æ‰‹æ©Ÿä¸è™•ç† mouse æµç¨‹
  if ("ontouchstart" in window) return;
  // ---------- 1ï¸âƒ£ æ•´å¼µè¡¨æ ¼é¸å– ----------
  const table = e.target.closest(".note-table");
  if (table && !e.target.closest("td")) {
    e.preventDefault();

    clearCellSelection();
    activeCell = null;
    activeTable = table;

    const range = document.createRange();
    range.selectNode(table);

    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
    return;
  }


  const td = e.target.closest("td");
  if (!td) return;
   if (e.button === 2) return;

  if (!e.ctrlKey && !e.metaKey) {
    clearCellSelection();
  }

  toggleCellSelection(td);
  activeCell = td;
  activeTable = td.closest("table");
});

function toggleCellSelection(td) {
  if (selectedCells.has(td)) {
    selectedCells.delete(td);
    td.classList.remove("cell-selected");
  } else {
    selectedCells.add(td);
    td.classList.add("cell-selected");
  }
}


function getSelectedDataCells() {
  return Array.from(
    document.querySelectorAll(".note-table td.selected.data-cell")
  );
}


function clearCellSelection() {
  document
    .querySelectorAll(".note-table td.selected")
    .forEach(td => td.classList.remove("selected"));
}

function mergeSelectedCells() {
  const cells = getSelectedDataCells();
  if (cells.length < 2) {
    alert("è«‹é¸å–å¤šå€‹å„²å­˜æ ¼");
    return;
  }

  const table = cells[0].closest("table");

  // å–å¾—æ‰€æœ‰ row / col index
  const rows = cells.map(c => c.parentElement.rowIndex);
  const cols = cells.map(c => c.cellIndex);

  const minRow = Math.min(...rows);
  const maxRow = Math.max(...rows);
  const minCol = Math.min(...cols);
  const maxCol = Math.max(...cols);

  // é©—è­‰æ˜¯å¦ç‚ºã€Œå®Œæ•´çŸ©å½¢ã€
  for (let r = minRow; r <= maxRow; r++) {
    for (let c = minCol; c <= maxCol; c++) {
      const cell = table.rows[r]?.cells[c];
      if (!cell || !cell.classList.contains("data-cell")) {
        alert("é¸å–ç¯„åœå¿…é ˆæ˜¯å®Œæ•´çŸ©å½¢");
        return;
      }
      if (!cell.classList.contains("selected")) {
        alert("é¸å–ç¯„åœå¿…é ˆæ˜¯å®Œæ•´çŸ©å½¢");
        return;
      }
    }
  }
  const master = table.rows[minRow].cells[minCol];
  master.rowSpan = maxRow - minRow + 1;
  master.colSpan = maxCol - minCol + 1;


  cells.forEach(cell => {
    if (cell !== master) {
      cell.remove();
    }
  });

  clearCellSelection();
}


function mergeSelectedCellsVertical() {
  if (selectedCells.size < 2) {
    alert("è«‹é¸å–å¤šå€‹å„²å­˜æ ¼");
    return;
  }

  const cells = Array.from(selectedCells);
  const colIndex = cells[0].cellIndex;

  // å¿…é ˆåŒä¸€æ¬„
  if (!cells.every(c => c.cellIndex === colIndex)) {
    alert("è«‹é¸å–åŒä¸€æ¬„ä½çš„å„²å­˜æ ¼");
    return;
  }

  // ä¾ rowIndex æ’åº
  cells.sort((a, b) => a.parentElement.rowIndex - b.parentElement.rowIndex);

  const first = cells[0];
  first.rowSpan = cells.length;

  cells.slice(1).forEach(c => c.remove());

  clearCellSelection();
}


function splitCell(cell) {
  const span = cell.colSpan || 1;
  if (span <= 1) return;

  cell.colSpan = 1;

  for (let i = 1; i < span; i++) {
    const td = document.createElement("td");
    td.contentEditable = "true";
    td.style.border = "1px solid #ccc";
    td.style.padding = "6px";
    cell.parentElement.insertBefore(td, cell.nextSibling);
  }
}


function deleteSelectedCells() {
  if (selectedCells.size === 0) return;

  selectedCells.forEach(td => td.remove());
  clearCellSelection();
}



// Enter / Tab è¡Œç‚ºï¼ˆåƒ Excelï¼‰
contentI.addEventListener("keydown", e => {

  if (e.ctrlKey || e.metaKey) {
    const key = e.key.toLowerCase();

    // Ctrl + Zï¼ˆUndoï¼‰
    if (key === "z" && !e.shiftKey) {
      e.preventDefault();
      if (!undoStack.length) return;

      redoStack.push(contentI.innerHTML);
      contentI.innerHTML = undoStack.pop();
      placeCaretAtEnd(contentI);
      return;
    }

    // Ctrl + Shift + Z / Ctrl + Yï¼ˆRedoï¼‰
    if (key === "y" || (key === "z" && e.shiftKey)) {
      e.preventDefault();
      if (!redoStack.length) return;

      undoStack.push(contentI.innerHTML);
      contentI.innerHTML = redoStack.pop();
      placeCaretAtEnd(contentI);
      return;
    }
  }


function placeCaretAtEnd(el) {
  el.focus();
  const range = document.createRange();
  range.selectNodeContents(el);
  range.collapse(false);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
}

  if (!activeCell) return;

  if (e.key === "Tab") {
    e.preventDefault();

    const next = activeCell.nextElementSibling;
    if (next) {
      placeCaretInsideCell(next);
      activeCell = next;
    }
    return;
  }
  if (e.key === "Enter") {
    e.preventDefault();

    const row = activeCell.parentElement;
    const idx = activeCell.cellIndex;
    const nextRow = row.nextElementSibling;

    if (nextRow && nextRow.cells[idx]) {
      const target = nextRow.cells[idx];
      placeCaretInsideCell(target);
      activeCell = target;
    }
    return;
  }
});


contentI.addEventListener("focusin", e => {
  // â­ æ‰‹æ©Ÿä¸åœ¨ focus æ™‚åšé¸å–
  if ("ontouchstart" in window) return;

  const td = e.target.closest("td.data-cell");
  if (!td) return;

  activeCell = td;
  activeTable = td.closest("table");
});

let undoStack = [];
let redoStack = [];
const MAX_HISTORY = 50;

function saveHistory() {
  const html = contentI.innerHTML;
  if (undoStack.length && undoStack[undoStack.length - 1] === html) return;

  undoStack.push(html);

  if (undoStack.length > MAX_HISTORY) {
    undoStack.shift();
  }
  redoStack.length = 0;
}


let historyTimer = null;

contentI.addEventListener("input", () => {
  // â­â­â­ é—œéµ 1ï¼šè¼¸å…¥ä¸­ç«‹åˆ»çµæŸä»»ä½•æ‹–æ›³ / é¸å–ç‹€æ…‹
  isDragging = false;
  dragStartCell = null;
  anchorCell = null;

  // â­â­â­ é—œéµ 2ï¼šä¸è¦åœ¨ input ç•¶ä¸‹æ¸… selectionï¼ˆé¿å…æ‰‹æ©Ÿ selection éœ‡ç›ªï¼‰
  // clearCellSelection(); âŒ çµ•å°ä¸è¦åœ¨é€™è£¡å‘¼å«

  // â­ åŸæœ¬çš„ debounce å„²å­˜é‚è¼¯
  clearTimeout(historyTimer);
  historyTimer = setTimeout(() => {
    saveHistory();
  }, 300);
});


function addColumnResizers(table) {
  table.querySelectorAll("td").forEach(td => {
    if (td.querySelector(".col-resizer")) return;

    const grip = document.createElement("div");
    grip.className = "col-resizer";
    td.appendChild(grip);

    grip.addEventListener("pointerdown", startResizeColumn);
  });
}

let resizingCol = null;
let startX = 0;
let startWidth = 0;

function startResizeColumn(e) {
  e.preventDefault();
  resizingCol = e.target.parentElement;
  startX = e.clientX;
  startWidth = resizingCol.offsetWidth;

  document.addEventListener("pointermove", resizeColumn);
  document.addEventListener("pointerup", stopResizeColumn);
}

function resizeColumn(e) {
  if (!resizingCol) return;
  const dx = e.clientX - startX;
  resizingCol.style.width = startWidth + dx + "px";
}

function stopResizeColumn() {
  document.removeEventListener("pointermove", resizeColumn);
  document.removeEventListener("pointerup", stopResizeColumn);
  resizingCol = null;

  contentI.dispatchEvent(new Event("input")); // ğŸ”¥ å­˜æ­·å²
}


function insertImage(){
  document.getElementById("imgPicker").click();
}

imgPicker.onchange = e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    const img = document.createElement("img");
    img.src = reader.result;
    img.style.maxWidth = "100%";
    img.style.display = "block";
    img.style.margin = "5px 0";
    insertNodeAtCursor(img);
// ğŸ”¥ å¼·åˆ¶è§¸ç™¼è‡ªå‹•å„²å­˜
contentI.dispatchEvent(new Event("input"));
  };
  reader.readAsDataURL(file);
};

// 3. æ’å…¥å½±ç‰‡æ™‚åˆå§‹ç¸®å°é¡¯ç¤º
// 3. æ’å…¥å½±ç‰‡æ™‚åˆå§‹ç¸®å°é¡¯ç¤ºï¼ˆæ”¾å¤§ç‰ˆï¼‰
function insertVideo(){
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "video/*";
  input.click();

  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      const video = document.createElement("video");
      video.src = reader.result;
      video.controls = true;
      video.muted = true;

      // âœ… åˆå§‹å°ºå¯¸ï¼ˆå†æ”¾å¤§ä¸€é»ï¼‰
video.style.width = "160px";
video.style.height = "auto";
video.style.maxHeight = "160px";
video.style.objectFit = "cover";


      video.style.display = "block";
      video.style.margin = "10px 0";

      // âœ… é¿å…æ¸¸æ¨™è·‘é€²å½±ç‰‡
      video.setAttribute("contenteditable", "false");

      // âœ… æ’å…¥åœ¨æ¸¸æ¨™ä½ç½®
      insertNodeAtCursor(video);
// ğŸ”¥ å¼·åˆ¶è§¸ç™¼è‡ªå‹•å„²å­˜
contentI.dispatchEvent(new Event("input"));
    };
    reader.readAsDataURL(file);
  };
}


//  è‡ªå‹•å„²å­˜æ”¹æˆã€Œç”¨ currentId å­˜ã€
let autoSaveTimer = null;

function bindAutoSave(editorEl) {
  editorEl.oninput = () => {
    if (!currentId) return;

    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(async () => {
      const notes = await all();
      const note = notes.find(n => n.id === currentId);
      if (!note || note.encrypted) return;

      note.content = editorEl.innerHTML;
      note.timestamp = Date.now();
      save(note);
      refresh();

      console.log("ğŸ“ è‡ªå‹•å„²å­˜", currentId);
    }, 600);
  };
}


// è¨­ç½®ç·¨è¼¯å€åŠŸèƒ½
function setupEditor() {
  initEditor(); // å•Ÿå‹•ç·¨è¼¯å€è‡ªå‹•å„²å­˜åŠŸèƒ½

  // æ’å…¥è¡¨æ ¼
  const insertTableButton = document.createElement('button');
  insertTableButton.innerText = 'æ’å…¥è¡¨æ ¼';
  insertTableButton.addEventListener('click', insertTable);
  document.body.appendChild(insertTableButton);


  // æ’å…¥å½±ç‰‡
  const insertVideoButton = document.createElement('button');
  insertVideoButton.innerText = 'æ’å…¥å½±ç‰‡';
  insertVideoButton.addEventListener('click', function() {
    const videoUrl = prompt('è«‹è¼¸å…¥å½±ç‰‡URLï¼š');
    insertVideo(videoUrl);
  });
  document.body.appendChild(insertVideoButton);
}

// åˆå§‹åŒ–ç·¨è¼¯å€
//setupEditor();


/* ========= å¾ç­†è¨˜å…§å®¹æŠ“ã€Œç¬¬ä¸€å€‹åª’é«”ã€ ========= */

function extractPreviewFromHTML(html){
  const div = document.createElement("div");
  div.innerHTML = html || "";

  const img = div.querySelector("img");
  if(img){
    return { type:"image", src: img.src };
  }

  const video = div.querySelector("video");
  if(video){
    return { type:"video", src: video.src };
  }

  const table = div.querySelector("table");
  if(table){
    return { type:"table" };
  }

  return null;
}



/* ========= åˆ—è¡¨åªä¾ã€Œæ–‡å­—æ®µè½ã€åˆ¤æ–·è¡Œæ•¸ ========= */
function extractTextLinesFromHTMLWithMedia(html){
  const div = document.createElement("div");
  div.innerHTML = html || "";

  const firstImage = div.querySelector("img");
  const firstVideo = div.querySelector("video");
  const firstTable = div.querySelector("table");

  let firstMedia = firstImage || firstVideo || firstTable || null;

  // ç§»é™¤ä¸è©²å½±éŸ¿è¡Œæ•¸çš„å…ƒç´ 
  div.querySelectorAll("img, video, table").forEach(el => el.remove());

  const lines = [];
  div.childNodes.forEach(node=>{
    let text = "";
    if(node.nodeType === Node.TEXT_NODE){
      text = node.textContent.trim();
    } else if(node.nodeType === Node.ELEMENT_NODE){
      text = node.innerText.trim();
    }
    if(text) lines.push(text);
  });

  return {
    lines,
    hasImage: !!firstImage,
    hasVideo: !!firstVideo,
    firstMedia
  };
}


/* ========= å·¥å…·å‡½å¼ ========= */
function insertHTMLAtCursor(html){
  const sel = window.getSelection();
  if(!sel.rangeCount) return;
  const range = sel.getRangeAt(0);
  range.deleteContents();
  const frag = document.createRange().createContextualFragment(html);
  range.insertNode(frag);
  range.collapse(false);
}

function insertNodeAtCursor(node) {
  const sel = window.getSelection();

  if (savedRange) {
    sel.removeAllRanges();
    sel.addRange(savedRange);
  }

  if (!sel.rangeCount) {
    contentI.appendChild(node);
    return;
  }

  const range = sel.getRangeAt(0);
  range.deleteContents();
  range.insertNode(node);

  // æ’å…¥å¾Œæ¸¸æ¨™ç§»åˆ°å…ƒç´ å¾Œé¢
  range.setStartAfter(node);
  range.collapse(true);
  sel.removeAllRanges();
  sel.addRange(range);

  // æ›´æ–° savedRange
  savedRange = range;
}


/* ========= å·¦å³æ»‘å®Œæ•´é‚è¼¯ ========= */
function addSwipeListeners(item, note){
  let sx = null, dx = 0;
  const main = item.querySelector(".note-main");
  const deleteBtn = item.querySelector(".swipe-bg.delete");
  const pinBtn = item.querySelector(".swipe-bg.pin");

  // ç¦æ­¢æ»‘å‹•é»æ“Šå†’æ³¡
  function stopClick(e){ e.stopPropagation(); }

  item.addEventListener("pointerdown", e => {
    sx = e.clientX;
    item.setPointerCapture(e.pointerId);
    main.style.transition = "none";
  });

  item.addEventListener("pointermove", e => {
    if(sx === null) return;
    dx = e.clientX - sx;

    // é˜»æ­¢å·¦å³èª¤è§¸é»æ“Šæ‰“é–‹ç·¨è¼¯å™¨
    if(Math.abs(dx) > 5) main.dataset.dragging = true;

    // å·¦å³æ»‘å‹•
    if(dx < 0){ // å·¦æ»‘ â†’ é¡¯ç¤ºåˆªé™¤
      main.style.transform = `translateX(${Math.max(dx, -120)}px)`;
    } else { // å³æ»‘ â†’ é¡¯ç¤ºé‡˜é¸
      main.style.transform = `translateX(${Math.min(dx, 120)}px)`;
    }
  });

  item.addEventListener("pointerup", e => {
    item.releasePointerCapture(e.pointerId);
    main.style.transition = "transform .25s ease";

    if(dx < -60){ // å·¦æ»‘è¶…éé–¾å€¼ â†’ å®šä½
      main.style.transform = "translateX(-120px)";
    } else if(dx > 60){ // å³æ»‘è¶…éé–¾å€¼ â†’ å®šä½
      main.style.transform = "translateX(120px)";
    } else { // å›å½ˆ
      main.style.transform = "translateX(0)";
    }

    // é‡ç½®æ‹–æ›³æ¨™è¨˜
    setTimeout(()=>{ delete main.dataset.dragging; }, 50);

    sx = null; dx = 0;
  });

  // é»æ“Šåˆªé™¤æŒ‰éˆ•
  deleteBtn.addEventListener("click", e => {
    e.stopPropagation();
    tx("readwrite").delete(note.id);
    refresh();
  });

  // é»æ“Šé‡˜é¸æŒ‰éˆ•
  pinBtn.addEventListener("click", e => {
    e.stopPropagation();
    note.pinned = !note.pinned;
    save(note);
    refresh();
  });

  // é»æ“Šä¸»å…§å®¹æ‰é–‹ç·¨è¼¯å™¨
  main.addEventListener("click", e => {
    if(main.dataset.dragging) return; // æ‹–æ›³ä¸æ‰“é–‹
    openEditor(note);
  });
}


/* ========= Editor Swipe Back (Safe Version) ========= */
(()=>{
  let sx=null, dx=0;
  const hint=document.getElementById("editorSwipeHint");
  const TH=120;
  const EDGE=20; // ğŸ”¥ åªæœ‰å·¦é‚Š 20px æ‰å•Ÿå‹•è¿”å›

  editor.addEventListener("pointerdown",e=>{
    // âŒ é»åœ¨æŒ‰éˆ• / input / textarea ä¸è™•ç†
    if(e.target.closest("button,input,textarea")) return;

    // âŒ ä¸æ˜¯å¾å·¦é‚Šç·£é–‹å§‹ï¼Œä¸è™•ç†
    if(e.clientX > EDGE) return;

    sx=e.clientX;
    dx=0;
    editor.setPointerCapture(e.pointerId);
  });

  editor.addEventListener("pointermove",e=>{
    if(sx===null) return;
    dx=e.clientX-sx;

    if(dx>30){
      hint.style.display="flex";
      e.preventDefault();
    }
  });

  editor.addEventListener("pointerup",e=>{
    if(sx!==null){
      editor.releasePointerCapture(e.pointerId);
    }

    hint.style.display="none";

    if(dx>TH){
      closeEditor();
    }

    sx=null;
    dx=0;
  });

})();

function closeEditor(){
  // ğŸ”¹ éš±è—ç·¨è¼¯å™¨
  editor.style.display = "none";

  // ğŸ”¹ é¡¯ç¤ºåˆ—è¡¨ã€FABã€æœå°‹æ¡†
  document.getElementById("noteList").style.display = "";
  document.getElementById("fab").style.display = "";
  document.getElementById("searchBox").style.display = "";

  // ğŸ”¹ æ¸…ç©ºç·¨è¼¯å™¨å…§å®¹èˆ‡é¸å–ç¯„åœï¼ˆé¿å…ä¸Šä¸€æ¬¡é¸å–å½±éŸ¿ï¼‰
  // æ³¨æ„ï¼šä¸æ¸… contentI.valueï¼Œä¿ç•™åŸç­†è¨˜å…§å®¹
  window.getSelection().removeAllRanges();

  // ğŸ”¹ æ¸…ç©º contenteditable çš„è‡¨æ™‚æ’å…¥å…ƒç´ ï¼ˆåœ–ç‰‡ / å½±ç‰‡ï¼‰
  // å¦‚æœä½ ä½¿ç”¨ contenteditable divï¼Œå»ºè­°ä¸è¦ä¿ç•™ä¹‹å‰æ’å…¥çš„å…ƒç´ 
  const contentDiv = document.getElementById("content");
  if(contentDiv){
    // ä¿å­˜å…§å®¹åˆ°ç­†è¨˜å‰ï¼Œä¸æ¸…æ‰ï¼›åªæ˜¯åˆ‡æ›ç­†è¨˜æ™‚æ¸…æ‰
    contentDiv.innerHTML = "";
  }

  // ğŸ”¹ é‡ç½® global currentIdï¼Œé¿å…å½±éŸ¿ä¸‹ä¸€ç­†ç·¨è¼¯
  currentId = null;
}

/* ========= æ™‚é–“é¡¯ç¤ºå·¥å…·å‡½å¼ ========= */
function formatListTime(ts){
  const d = new Date(ts);
  const now = new Date();

  const sameDay = (a,b)=>
    a.getFullYear()===b.getFullYear() &&
    a.getMonth()===b.getMonth() &&
    a.getDate()===b.getDate();

  if(sameDay(d, now)){
    return d.toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"});
  }

  const y = new Date(now);
  y.setDate(now.getDate()-1);
  if(sameDay(d, y)){
    return d.toLocaleDateString("zh-TW");
  }

  const diff = Math.floor((now - d) / 86400000);
  if(diff < 7){
    return ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][d.getDay()];
  }

  return d.getFullYear()+"å¹´";
}



document.getElementById("mediaMenu").onclick = e => {
  if (!activeMedia) return;

  const act = e.target.dataset.act;
  const cur = activeMedia.offsetWidth;

  if (act === "zoomIn") {
    activeMedia.style.width = cur + 20 + "px";
  }

  if (act === "zoomOut") {
    activeMedia.style.width = Math.max(60, cur - 20) + "px";
  }

  if (act === "delete") {
    activeMedia.remove();
  }

  contentI.dispatchEvent(new Event("input"));
};


/* ========= Search ========= */

let isSearching = false;

let searchTimer = null;
const SEARCH_DELAY = 250; // msï¼Œå¯è‡ªè¡Œèª¿æ•´


searchInput.addEventListener("input", () => {
  clearTimeout(searchTimer);

  isSearching = searchInput.value.trim() !== "";

  searchTimer = setTimeout(() => {
    refresh();
  }, SEARCH_DELAY);
});


const fab = document.getElementById("fab");
let fabLock = false;

if (fab) {
  fab.addEventListener("pointerup", e => {
    // â­ åªè™•ç†æ‰‹æŒ‡ / æ»‘é¼ æ”¾é–‹
    e.stopPropagation();
    e.preventDefault();

    // â­ é˜²æ­¢ inline onclick + pointerup é€£çºŒè§¸ç™¼
    if (fabLock) return;
    fabLock = true;

    newNote();

    setTimeout(() => {
      fabLock = false;
    }, 300);
  });
}



// ğŸ”¹ æœ€å¾Œå•Ÿå‹• DB ä¸¦åˆ·æ–°åˆ—è¡¨
openDB().then(refresh);

</script>

