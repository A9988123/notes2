<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å‚™å¿˜éŒ„</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4A90E2">

<style>
body{margin:0;font-family:-apple-system;background:#f5f5f5}

/* ===== Header ===== */
header{padding:14px 16px 6px;font-size:28px;font-weight:600}

/* ===== Search ===== */
#searchBox{width:calc(100% - 20px);margin:0 10px 10px;padding:10px;font-size:16px;border-radius:10px;border:1px solid #ddd}

/* ===== Notes ===== */
.section-title{padding:8px 14px;font-size:13px;color:#777}
.note-item{background:#fff;padding:10px 14px;border-bottom:1px solid #eee;cursor:pointer;position:relative;touch-action:pan-y;}
.note-item.pinned{background:#fff8dc}
.note-title{font-size:16px;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden}
.note-sub{font-size:13px;color:#666;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden}

/* ===== FAB ===== */
#fab{position:fixed;right:18px;bottom:18px;width:56px;height:56px;border-radius:50%;font-size:32px}

/* ===== Context Menu ===== */
#contextMenu{position:fixed;background:#fff;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.25);display:none;z-index:9999}
#contextMenu div{padding:10px 14px;cursor:pointer}
#contextMenu div:hover{background:#f0f0f0}

/* ===== Editor ===== */
#editor{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#f5f5f5;flex-direction:column}
#editorHeader{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#4A90E2;color:white}
#editorToolbar{display:flex;padding:6px 10px;background:#eee;gap:6px;flex-wrap:wrap}
#editorToolbar button{padding:6px 10px;border:none;border-radius:6px;background:white;cursor:pointer;font-weight:bold;}
#editorToolbar button:hover{background:#ddd;}
#editorContent{flex:1;padding:10px;display:flex;flex-direction:column}
#editorContent input,#editorContent textarea{width:100%;padding:10px;margin-bottom:8px;font-size:16px;border-radius:10px;border:1px solid #ccc;resize:none;}
</style>
</head>

<body>

<header>å‚™å¿˜éŒ„</header>
<input id="searchBox" placeholder="ğŸ” æœå°‹">

<div id="noteList"></div>
<button id="fab" onclick="newNote()">ï¼‹</button>
<div id="contextMenu"></div>

<!-- ===== Editor ===== -->
<div id="editor">
  <div id="editorHeader">
    <button onclick="closeEditor()">è¿”å›åˆ—è¡¨</button>
    <button onclick="saveEditor()">å­˜æª”</button>
  </div>
  <div id="editorToolbar">
    <button onclick="formatText('bold')">B</button>
    <button onclick="formatText('italic')">I</button>
    <button onclick="formatText('underline')">U</button>
    <button onclick="insertTable()">è¡¨æ ¼</button>
    <button onclick="insertImage()">åœ–ç‰‡</button>
    <button onclick="insertVideo()">å½±ç‰‡</button>
  </div>
  <div id="editorContent">
    <input id="title" placeholder="æ¨™é¡Œ">
    <textarea id="content" rows="18" placeholder="å…§å®¹"></textarea>
  </div>
</div>

<input type="file" id="backupFile" style="display:none" accept=".json">

<script>
/* ========= IndexedDB ========= */
const DB_NAME="notesDB",STORE="notes";
let db,currentId=null;

function openDB(){return new Promise(r=>{const q=indexedDB.open(DB_NAME,1);q.onupgradeneeded=e=>{e.target.result.createObjectStore(STORE,{keyPath:"id"});};q.onsuccess=e=>{db=e.target.result;r();};});}
function tx(m){return db.transaction(STORE,m).objectStore(STORE);}
function save(n){tx("readwrite").put(n);}
function all(){return new Promise(r=>{const q=tx("readonly").getAll();q.onsuccess=()=>r(q.result);});}

/* ========= Crypto ========= */
async function keyFromPassword(pw,salt){
 const enc=new TextEncoder();
 const base=await crypto.subtle.importKey("raw",enc.encode(pw),"PBKDF2",false,["deriveKey"]);
 return crypto.subtle.deriveKey({name:"PBKDF2",salt,iterations:100000,hash:"SHA-256"},base,{name:"AES-GCM",length:256},false,["encrypt","decrypt"]);
}
function rand(n){return crypto.getRandomValues(new Uint8Array(n));}
async function encryptText(t,pw){
 const iv=rand(12),salt=rand(16);
 const key=await keyFromPassword(pw,salt);
 const buf=await crypto.subtle.encrypt({name:"AES-GCM",iv},key,new TextEncoder().encode(t));
 return{iv:[...iv],salt:[...salt],data:[...new Uint8Array(buf)]};
}
async function decryptText(o,pw){
 const key=await keyFromPassword(pw,new Uint8Array(o.salt));
 const buf=await crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(o.iv)},key,new Uint8Array(o.data));
 return new TextDecoder().decode(buf);
}

/* ========= Render ========= */
const list=document.getElementById("noteList");
async function refresh(){
 const ns=await all();
 list.innerHTML="";
 const pinned=ns.filter(n=>n.pinned),normal=ns.filter(n=>!n.pinned);
 if(pinned.length){list.innerHTML+=`<div class="section-title">å·²é‡˜é¸</div>`;pinned.forEach(renderNote);}
 normal.forEach(renderNote);
}

/* ========= Render with Drag & Drop ========= */
function renderNote(n){
 if(!n.timestamp)n.timestamp=Date.now();
 const lines=(typeof n.content==="string"?n.content:"").split("\n");
 const d=document.createElement("div");
 d.className="note-item"+(n.pinned?" pinned":"");
 d.draggable = true; // å•Ÿç”¨æ‹–æ›³
 d.innerHTML=`<div class="note-title">${n.title||lines[0]||"ç„¡å…§å®¹"}</div>
 <div class="note-sub">${new Date(n.timestamp).toLocaleString()} ${lines.slice(1).join(" ")}</div>`;
 d.onclick=()=>openEditor(n);
 d.onmousedown=e=>{if(e.button===1){e.preventDefault();n.pinned=!n.pinned;save(n);refresh();}};
 d.oncontextmenu=e=>{e.preventDefault();currentId=n.id;showMenu(e.pageX,e.pageY);};
 list.appendChild(d);

 addSwipeListeners(d,n); // å·¦å³æ»‘åŠŸèƒ½
 addDragListeners(d,n);   // æ‹–æ›³åŠŸèƒ½
}

/* ========= Drag & Drop ========= */
function addDragListeners(item,note){
  item.addEventListener('dragstart', e=>{
    e.dataTransfer.setData('text/plain', note.id);
    item.style.opacity = 0.5;
  });
  item.addEventListener('dragend', e=>{
    item.style.opacity = 1;
  });
  item.addEventListener('dragover', e=>{
    e.preventDefault(); // å…è¨± drop
  });
  item.addEventListener('drop', e=>{
    e.preventDefault();
    const draggedId = e.dataTransfer.getData('text/plain');
    if(draggedId === note.id) return;
    all().then(ns=>{
      const draggedNote = ns.find(x=>x.id===draggedId);
      if(!draggedNote) return;
      // ç§»å‹• draggedNote åˆ° note çš„å‰é¢
      const newOrder = ns.filter(x=>x.id!==draggedId);
      const index = newOrder.findIndex(x=>x.id===note.id);
      newOrder.splice(index,0,draggedNote);
      // ä¾é †åºé‡æ–°ä¿å­˜ timestampï¼Œä»¥æ§åˆ¶é¡¯ç¤ºé †åº
      newOrder.forEach((x,i)=>{ x.timestamp = Date.now() + i; save(x); });
      refresh();
    });
  });
}






/* ========= Editor ========= */
const editor=document.getElementById("editor");
const titleI=document.getElementById("title");
const contentI=document.getElementById("content");

function openEditor(n){
 currentId=n.id;
 titleI.value=n.title||"";
 contentI.value=n.encrypted?"ğŸ”’ å·²åŠ å¯†ï¼Œè«‹è§£å¯†":(n.content||"");
 contentI.disabled=!!n.encrypted;
 editor.style.display="flex";
}
function closeEditor(){editor.style.display="none";}
function saveEditor(){
 if(!currentId)return;
 all().then(ns=>{
  const n=ns.find(x=>x.id===currentId);
  if(!n||n.encrypted)return;
  n.title=titleI.value;
  n.content=contentI.value;
  save(n);refresh();
 });
}

/* ========= New ========= */
function newNote(){
 const n={id:Date.now().toString(),title:"",content:"",encrypted:false,pinned:false,timestamp:Date.now()};
 save(n);openEditor(n);
}

/* ========= Context Menu ========= */
const menu=document.getElementById("contextMenu");
menu.innerHTML=`
<div onclick="ctxEncrypt()">ğŸ” åŠ å¯†</div>
<div onclick="ctxDecrypt(false)">ğŸ”“ è§£å¯†ï¼ˆæš«æ™‚ï¼‰</div>
<div onclick="ctxDecrypt(true)">ğŸ”“ è§£å¯†ä¸¦è§£é™¤</div>
<div onclick="exportSingleNote()">ğŸ“¤ åŒ¯å‡ºå–®ç­†</div>
<div onclick="exportAllNotes()">ğŸ“¦ åŒ¯å‡ºå…¨éƒ¨</div>
<div onclick="document.getElementById('backupFile').click()">ğŸ“¥ åŒ¯å…¥</div>
<div onclick="deleteCurrent()">ğŸ—‘ åˆªé™¤</div>`;
function showMenu(x,y){menu.style.left=x+"px";menu.style.top=y+"px";menu.style.display="block";}
document.body.onclick=()=>menu.style.display="none";

/* ========= Encrypt / Decrypt (prompt) ========= */
async function ctxEncrypt(){
 const pw=prompt("è«‹è¼¸å…¥åŠ å¯†å¯†ç¢¼"); if(!pw)return;
 const ns=await all(); const n=ns.find(x=>x.id===currentId);
 n.content=await encryptText(n.content,pw); n.encrypted=true; save(n); refresh();
}
async function ctxDecrypt(permanent){
 const pw=prompt("è«‹è¼¸å…¥è§£å¯†å¯†ç¢¼"); if(!pw)return;
 const ns=await all(); const n=ns.find(x=>x.id===currentId);
 try{
  const txt=await decryptText(n.content,pw);
  if(permanent){n.content=txt;n.encrypted=false;save(n);refresh();}
  else alert(txt);
 }catch{alert("âŒ è§£å¯†å¤±æ•—");}
}

/* ========= Delete ========= */
async function deleteCurrent(){
 const ns=await all(); const n=ns.find(x=>x.id===currentId);
 if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ"))return;
 tx("readwrite").delete(n.id); refresh();
}

/* ========= Export / Import ========= */
function downloadFile(c,f){
 const b=new Blob([c],{type:"application/json"});
 const u=URL.createObjectURL(b);
 const a=document.createElement("a");a.href=u;a.download=f;
 document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);
}

async function exportSingleNote(){
 const ns=await all(); const n=ns.find(x=>x.id===currentId);
 let txt=n.content;
 if(n.encrypted){const pw=prompt("è¼¸å…¥åŸå¯†ç¢¼");txt=await decryptText(n.content,pw);}
 const bpw=prompt("å‚™ä»½å¯†ç¢¼"); if(!bpw)return;
 const enc=await encryptText(txt,bpw);
 downloadFile(JSON.stringify({title:n.title,content:"enc:"+JSON.stringify(enc)},null,2),`${n.title||"note"}.json`);
}

async function exportAllNotes(){
 const ns=await all();
 const upw=prompt("è¼¸å…¥åŸè§£å¯†å¯†ç¢¼"); const bpw=prompt("å‚™ä»½å¯†ç¢¼");
 const out={};
 for(const n of ns){
  let txt=n.content;
  if(n.encrypted) txt=await decryptText(n.content,upw);
  out[n.id]={title:n.title,content:"enc:"+JSON.stringify(await encryptText(txt,bpw)),timestamp:n.timestamp};
 }
 downloadFile(JSON.stringify(out,null,2),`notes-backup.json`);
}

document.getElementById("backupFile").onchange=async e=>{
 const f=e.target.files[0]; if(!f)return;
 const pw=prompt("è¼¸å…¥å‚™ä»½å¯†ç¢¼"); if(!pw)return;
 const data=JSON.parse(await f.text());
 if(data.content){
  const t=await decryptText(JSON.parse(data.content.slice(4)),pw);
  save({id:Date.now().toString(),title:data.title,content:t,encrypted:false,timestamp:Date.now()});
 }else{
  for(const k in data){
   const t=await decryptText(JSON.parse(data[k].content.slice(4)),pw);
   save({id:k,title:data[k].title,content:t,encrypted:false,timestamp:data[k].timestamp});
  }
 }
 refresh();
};

/* ========= Editor Toolbar Functions ========= */
function formatText(cmd){
  const textarea = contentI;
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const selected = textarea.value.slice(start, end);
  let wrapped;
  if(cmd === 'bold') wrapped = `**${selected}**`;
  else if(cmd === 'italic') wrapped = `*${selected}*`;
  else if(cmd === 'underline') wrapped = `__${selected}__`;
  textarea.setRangeText(wrapped, start, end, 'end');
}

function insertTable(){
  const textarea = contentI;
  const table = `|  |  |\n|--|--|\n|  |  |\n`;
  const pos = textarea.selectionStart;
  textarea.setRangeText(table, pos, pos, 'end');
}

function insertImage(){
  const url = prompt("è¼¸å…¥åœ–ç‰‡ URL");
  if(url) contentI.setRangeText(`![åœ–ç‰‡](${url})`, contentI.selectionStart, contentI.selectionEnd, 'end');
}

function insertVideo(){
  const url = prompt("è¼¸å…¥å½±ç‰‡ URL");
  if(url) contentI.setRangeText(`<video src="${url}" controls></video>`, contentI.selectionStart, contentI.selectionEnd, 'end');
}

/* ========= Swipe Gestures ========= */
function addSwipeListeners(item,note){
  let startX=null, moved=false;
  item.addEventListener('pointerdown', e=>{ startX=e.clientX; });
  item.addEventListener('pointermove', e=>{
    if(startX === null) return;
    const dx = e.clientX - startX;
    if(Math.abs(dx) > 50) moved=true;
  });
  item.addEventListener('pointerup', e=>{
    if(!moved) return;
    const dx = e.clientX - startX;
    if(dx < -50){ // å·¦æ»‘åˆªé™¤
      if(confirm("åˆªé™¤æ­¤ç­†å‚™å¿˜éŒ„ï¼Ÿ")){ tx('readwrite').delete(note.id); refresh(); }
    } else if(dx > 50){ // å³æ»‘é‡˜é¸/å–æ¶ˆ
      note.pinned = !note.pinned; save(note); refresh();
    }
    startX=null; moved=false;
  });
}

/* ========= Init ========= */
openDB().then(refresh);
</script>

</body>
</html>
