<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å‚™å¿˜éŒ„</title>
<style>
body {
    margin: 0;
    font-family: -apple-system, system-ui;
    background: #f5f5f5;
}
header {
    padding: 14px;
    font-size: 22px;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
}
#noteList { padding: 10px; }
.note-item {
    background: #fff;
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 10px;
}
.note-title { font-size: 16px; font-weight: 500; }
.note-sub { font-size: 12px; color: #888; }
#fab {
    position: fixed;
    right: 18px;
    bottom: 18px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #4a90e2;
    color: #fff;
    font-size: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}
#editor {
    position: fixed;
    inset: 0;
    background: #f5f5f5;
    display: none;
    flex-direction: column;
}
#editorHeader {
    background: #4a90e2;
    color: #fff;
    padding: 10px;
    display: flex;
    justify-content: space-between;
}
#content {
    flex: 1;
    padding: 12px;
    background: #fff;
    margin: 10px;
    border-radius: 10px;
    border: 1px solid #ccc;
}
.panel {
    position: fixed;
    inset: 0;
    background: #f5f5f5;
    display: none;
    flex-direction: column;
    z-index: 9999;
}
.panel-header {
    padding: 10px;
    background: #4a90e2;
    color: #fff;
}
</style>
</head>

<body>
<header>
    <span>å‚™å¿˜éŒ„</span>
    <div>
        <button id="exportBtn">åŠ å¯†åŒ¯å‡º</button>
        <button id="importBtn">åŒ¯å…¥</button>
        <button onclick="deleteAllNotes()">åˆªé™¤å…¨éƒ¨</button>
    </div>
</header>

<div id="noteList"></div>
<div id="fab" onclick="newNote()">ï¼‹</div>

<div id="editor">
    <div id="editorHeader">
        <button onclick="closeEditor()">è¿”å›</button>
        <button onclick="saveEditor()">å­˜æª”</button>
    </div>
    <div id="content" contenteditable="true"></div>
</div>

<!-- å¯†ç¢¼é¢æ¿ -->
<div id="passwordPanel" class="panel">
    <div class="panel-header">
        <button onclick="closePassword()">è¿”å›</button>
        <span style="margin-left:10px;" id="passwordTitle">è¼¸å…¥å¯†ç¢¼</span>
    </div>
    <div style="padding:20px;">
        <input id="passwordInput" type="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" style="width:100%;font-size:18px;padding:10px;">
        <button id="passwordConfirmBtn" style="margin-top:15px;width:100%;padding:12px;">ç¢ºèª</button>
    </div>
</div>

<!-- åŒ¯å‡ºé¡¯ç¤º -->
<div id="exportPanel" class="panel">
    <div class="panel-header">
        <button onclick="closeExport()">è¿”å›</button>
        <span style="margin-left:10px;">åŠ å¯†åŒ¯å‡ºå…§å®¹</span>
    </div>
    <textarea id="exportText" style="flex:1;margin:10px;border-radius:8px;"></textarea>
</div>

<input type="file" id="backupFile" hidden>

<script>
/* IndexedDB */
const DB_NAME = "memoDB";
const STORE = "notes";
let db, importFile = null, mode = "";

// æ‰“é–‹è³‡æ–™åº«
function openDB() {
    return new Promise(res => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = e => e.target.result.createObjectStore(STORE, { keyPath: "id" });
        req.onsuccess = e => { db = e.target.result; res(); };
    });
}
function save(note) { db.transaction(STORE,"readwrite").objectStore(STORE).put(note); }
function getAll() { 
    return new Promise(res => { 
        const r = db.transaction(STORE).objectStore(STORE).getAll(); 
        r.onsuccess = () => res(r.result || []); 
    }); 
}
function removeAll() { db.transaction(STORE,"readwrite").objectStore(STORE).clear(); }

/* AES-GCM åŠ è§£å¯† */
function str2ab(str){ return new TextEncoder().encode(str); }
function ab2str(buf){ return new TextDecoder().decode(buf); }
async function deriveKey(password,salt){
    const pwKey = await crypto.subtle.importKey("raw",str2ab(password),"PBKDF2",false,["deriveKey"]);
    return crypto.subtle.deriveKey({name:"PBKDF2",salt,iterations:100000,hash:"SHA-256"},pwKey,{name:"AES-GCM",length:256},false,["encrypt","decrypt"]);
}
async function aesEncrypt(plaintext,password){
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const key = await deriveKey(password,salt);
    const ct = await crypto.subtle.encrypt({name:"AES-GCM",iv},key,str2ab(plaintext));
    const combined = new Uint8Array(salt.length + iv.length + ct.byteLength);
    combined.set(salt,0);
    combined.set(iv,salt.length);
    combined.set(new Uint8Array(ct),salt.length+iv.length);
    return btoa(String.fromCharCode(...combined));
}
async function aesDecrypt(b64,password){
    const data = Uint8Array.from(atob(b64),c=>c.charCodeAt(0));
    const salt = data.slice(0,16);
    const iv = data.slice(16,28);
    const ct = data.slice(28);
    const key = await deriveKey(password,salt);
    try {
        const decrypted = await crypto.subtle.decrypt({name:"AES-GCM",iv},key,ct);
        return ab2str(decrypted);
    } catch(e){ throw new Error("å¯†ç¢¼éŒ¯èª¤æˆ–æª”æ¡ˆæå£"); }
}

/* åŒ¯å‡º */
function openExport() {
    mode="export";
    passwordTitle.textContent="è¼¸å…¥åŠ å¯†å¯†ç¢¼";
    passwordInput.value="";
    passwordConfirmBtn.onclick=confirmExport;
    passwordPanel.style.display="flex";
}
async function confirmExport(){
    const pwd = passwordInput.value;
    if(!pwd) return alert("è«‹è¼¸å…¥å¯†ç¢¼");
    const notes = await getAll();
    const encrypted = await aesEncrypt(JSON.stringify(notes),pwd);
    passwordPanel.style.display="none";

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;

    if(navigator.share && isIOS){
        try{
            const blob = new Blob([encrypted],{type:"text/plain"});
            const file = new File([blob],"notes.aes.txt",{type:"text/plain"});
            await navigator.share({files:[file],title:"å‚™ä»½åŠ å¯†æª”",text:"è«‹å¦¥å–„ä¿å­˜æ­¤æª”æ¡ˆ"});
            alert("âœ… åˆ†äº«æˆåŠŸï¼Œè«‹å­˜åˆ°æª”æ¡ˆæˆ–é›²ç«¯");
        }catch(err){
            console.error(err);
            exportPanel.style.display="flex";
            exportText.value = encrypted;
            exportText.select();
            exportText.setSelectionRange(0,encrypted.length);
            alert("ğŸ“„ åˆ†äº«å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½æ–‡å­—å‚™ä»½");
        }
    }else if(!isIOS){
        const blob = new Blob([encrypted],{type:"text/plain"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "notes.aes.txt";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert("âœ… åŠ å¯†æª”å·²ä¸‹è¼‰");
    }else{
        exportPanel.style.display="flex";
        exportText.value = encrypted;
        exportText.select();
        exportText.setSelectionRange(0,encrypted.length);
        alert("ğŸ“„ è«‹é•·æŒ‰è¤‡è£½æ–‡å­— â†’ å„²å­˜åˆ°æª”æ¡ˆï¼Œå®Œæˆå‚™ä»½");
    }
}

/* åŒ¯å…¥ */
function openImport(file){
    importFile=file;
    mode="import";
    passwordTitle.textContent="è¼¸å…¥è§£å¯†å¯†ç¢¼";
    passwordInput.value="";
    passwordConfirmBtn.onclick=confirmImport;
    passwordPanel.style.display="flex";
}
async function confirmImport(){
    const pwd = passwordInput.value;
    if(!pwd) return alert("è«‹è¼¸å…¥å¯†ç¢¼");
    try{
        const text = await importFile.text();
        const json = await aesDecrypt(text,pwd);
        JSON.parse(json).forEach(n=>save({...n,id:Date.now()+Math.random()}));
        refresh();
        alert("âœ… åŒ¯å…¥å®Œæˆ");
    }catch{
        alert("âŒ å¯†ç¢¼éŒ¯èª¤æˆ–æª”æ¡ˆæå£");
    }
    passwordPanel.style.display="none";
}

/* UI */
function closePassword(){ passwordPanel.style.display="none"; }
function closeExport(){ exportPanel.style.display="none"; }

async function refresh(){
    noteList.innerHTML="";
    (await getAll()).sort((a,b)=>b.timestamp-a.timestamp).forEach(n=>{
        const d=document.createElement("div");
        d.className="note-item";
        d.innerHTML=`<div class="note-title">${n.title}</div>
                     <div class="note-sub">${new Date(n.timestamp).toLocaleString()}</div>`;
        d.onclick=()=>openEditor(n.id);
        noteList.appendChild(d);
    });
}

let currentId=null;
function newNote(){ currentId=null; content.innerHTML=""; openEditor(); }
async function openEditor(id){
    currentId=id;
    if(id){
        const n=(await getAll()).find(x=>x.id===id);
        content.innerHTML=n?.content||"";
    }
    editor.style.display="flex";
    noteList.style.display=fab.style.display="none";
}
function closeEditor(){ editor.style.display="none"; noteList.style.display=fab.style.display=""; refresh(); }
function saveEditor(){
    save({id:currentId||Date.now(),title:content.innerText.slice(0,20),content:content.innerHTML,timestamp:Date.now()});
    closeEditor();
}
function deleteAllNotes(){ if(confirm("ç¢ºå®šåˆªé™¤å…¨éƒ¨ï¼Ÿ")){ removeAll(); refresh(); }}

/* å•Ÿå‹• */
window.onload = async ()=>{
    await openDB();
    refresh();
    exportBtn.onclick=openExport;
    importBtn.onclick=()=>backupFile.click();
    backupFile.onchange=()=>openImport(backupFile.files[0]);
};
</script>
</body>
</html>
