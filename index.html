<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>備忘錄</title>

<style>
body{
  margin:0;
  font-family:-apple-system,system-ui;
  background:#f5f5f5;
}
header{
  padding:14px;
  font-size:22px;
  font-weight:600;
  display:flex;
  justify-content:space-between;
}
#noteList{
  padding:10px;
}
.note-item{
  background:#fff;
  border-radius:10px;
  padding:12px;
  margin-bottom:10px;
}
.note-title{
  font-size:16px;
  font-weight:500;
}
.note-sub{
  font-size:12px;
  color:#888;
}
#fab{
  position:fixed;
  right:18px;
  bottom:18px;
  width:56px;
  height:56px;
  border-radius:50%;
  background:#4a90e2;
  color:#fff;
  font-size:32px;
  display:flex;
  align-items:center;
  justify-content:center;
}
#editor{
  position:fixed;
  inset:0;
  background:#f5f5f5;
  display:none;
  flex-direction:column;
}
#editorHeader{
  background:#4a90e2;
  color:#fff;
  padding:10px;
  display:flex;
  justify-content:space-between;
}
#content{
  flex:1;
  padding:12px;
  background:#fff;
  margin:10px;
  border-radius:10px;
  border:1px solid #ccc;
  overflow:auto;
}
#topBar button{
  margin-left:6px;
}
</style>
</head>

<body>

<header id="topBar">
  <span>備忘錄</span>
  <div>
    <button onclick="exportNotes()">匯出</button>
    <button onclick="backupFile.click()">匯入</button>
  </div>
</header>

<div id="noteList"></div>
<div id="fab" onclick="newNote()">＋</div>

<!-- Editor -->
<div id="editor">
  <div id="editorHeader">
    <button onclick="closeEditor()">返回</button>
    <button onclick="saveEditor()">存檔</button>
  </div>
  <div id="content" contenteditable="true"></div>
</div>

<input type="file" id="backupFile" accept=".json" hidden />

<script>
/* ================= IndexedDB ================= */

const DB_NAME = "memoDB";
const STORE = "notes";
let db = null;
let currentId = null;

function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME,1);

    req.onupgradeneeded = e=>{
      const _db = e.target.result;
      if(!_db.objectStoreNames.contains(STORE)){
        _db.createObjectStore(STORE,{ keyPath:"id" });
      }
    };

    req.onsuccess = e=>{
      db = e.target.result;
      resolve();
    };

    req.onerror = e=>reject(e);
  });
}

function save(note){
  const tx = db.transaction(STORE,"readwrite");
  tx.objectStore(STORE).put(note);
}

function getAll(){
  return new Promise(resolve=>{
    const tx = db.transaction(STORE,"readonly");
    const req = tx.objectStore(STORE).getAll();
    req.onsuccess = ()=>resolve(req.result||[]);
  });
}

function remove(id){
  const tx = db.transaction(STORE,"readwrite");
  tx.objectStore(STORE).delete(id);
}

/* ================= List ================= */

async function refresh(){
  const list = document.getElementById("noteList");
  list.innerHTML = "";

  const notes = await getAll();

  notes
    .sort((a,b)=>b.timestamp-a.timestamp)
    .forEach(n=>{
      const div = document.createElement("div");
      div.className = "note-item";
      div.innerHTML = `
        <div class="note-title">${n.title||"（無標題）"}</div>
        <div class="note-sub">${new Date(n.timestamp).toLocaleString()}</div>
      `;
      div.onclick = ()=>openEditor(n.id);
      list.appendChild(div);
    });
}

/* ================= Editor ================= */

async function openEditor(id){
  currentId = id;
  const notes = await getAll();
  const note = notes.find(n=>n.id===id);

  content.innerHTML = note?.content || "";

  editor.style.display = "flex";
  noteList.style.display = "none";
  fab.style.display = "none";
}

function closeEditor(){
  editor.style.display = "none";
  noteList.style.display = "";
  fab.style.display = "";
  currentId = null;
  refresh();
}

function saveEditor(){
  const text = content.innerText.trim();

  save({
    id: currentId || Date.now().toString(),
    title: text.slice(0,20),
    content: content.innerHTML,
    encrypted:false,
    timestamp: Date.now()
  });

  closeEditor();
}

function newNote(){
  currentId = null;
  content.innerHTML = "";
  openEditor(null);
}

/* ================= Export ================= */

async function exportNotes(){
  const notes = await getAll();
  const blob = new Blob(
    [JSON.stringify(notes,null,2)],
    {type:"application/json"}
  );
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "notes_backup.json";
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ================= Import ================= */

backupFile.onchange = e=>{
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = async ()=>{
    const data = JSON.parse(reader.result);
    if(!Array.isArray(data)){
      alert("格式錯誤");
      return;
    }
    data.forEach(n=>{
      save({
        ...n,
        id: Date.now().toString()+Math.random().toString(36).slice(2)
      });
    });
    refresh();
    alert("匯入完成");
  };
  reader.readAsText(file);
};

/* ================= Init ================= */

window.addEventListener("load",async()=>{
  await openDB();
  refresh();
});
</script>

</body>
</html>
