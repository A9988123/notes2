<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>å‚™å¿˜éŒ„</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4A90E2">
<meta name="format-detection" content="telephone=no,email=no,address=no,url=no">


<style>


/* ç·¨è¼¯å€æ•´é«” */
#contentI {
  -webkit-user-select: text;
  user-select: text;
  -webkit-touch-callout: none; /* é—œæ‰é•·æŒ‰æµ®å±¤ */
}



/* ç¦æ­¢ body / html çš„æ»¾å‹•*/
html, body {
  overflow: hidden;          /* é˜»æ­¢æ•´å€‹é é¢æ»¾å‹• */
  height: 100%;              /* ç¢ºä¿ body æ»¿ç‰ˆ */
  touch-action: none;        /* é˜»æ­¢æ‰‹å‹¢æ»‘å‹• */
}


body {
  margin: 0;
  font-family: -apple-system, system-ui;
  background: #f5f5f5;
}

/* ===== Header ===== */
header {
  padding: 14px 16px 6px;
  font-size: 28px;
  font-weight: 600;
}

/* ===== Search ===== */
#searchBox {
  width: calc(100% - 20px);
  margin: 0 10px 10px;
  padding: 10px;
  font-size: 16px;
  border-radius: 10px;
  border: 1px solid #ddd;
}

/* ===== Section Title ===== */
.section-title {
  padding: 8px 14px;
  font-size: 13px;
  color: #777;
}


.row-resizer {
  position: absolute;
  bottom: -3px;
  left: 0;
  height: 6px;
  width: 100%;
  cursor: row-resize;
}




/* ===== Notes List ===== */
.note-item {
  position: relative;
  overflow: hidden;
  background: #fff;
  touch-action: pan-y pinch-zoom;
}

.note-item.pinned {
  background: #fff8dc;
}

/* swipe èƒŒæ™¯ bar */
.swipe-bg {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 120px;
  z-index: 1;
}

.swipe-bg.delete {
  right: 0;
  background: #ff3b30;
}

.swipe-bg.pin {
  left: 0;
  background: #ffcc00;
  color: #333;
}

/* ä¸»å…§å®¹å€å¡Š */
.note-main {
  position: relative;
  width: 100%;
  padding: 12px 14px;
  background: #fff;
  z-index: 2;
  transition: transform 0.25s ease;
  display: flex;
  justify-content: space-between;
  align-items: center; /* è®“ç¸®åœ–å‚ç›´ç½®ä¸­ */
}

/* æ–‡å­—å®¹å™¨ */
.note-main > div:first-child {
  flex: 1;
  min-width: 0; /* æ–‡å­—æˆªæ–·æœ‰æ•ˆ */
}

/* æ¨™é¡Œèˆ‡å‰¯æ¨™é¡Œæ–‡å­—æˆªæ–· */
.note-title {
  font-size: 16px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.note-sub {
  font-size: 12px;
  color: #888;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* åˆªé™¤æç¤ºï¼ˆæµ®åœ¨å³å´ï¼‰ */
.note-item::after {
  content: "ğŸ—‘ åˆªé™¤";
  position: absolute;
  right: 14px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 18px;
  color: #d33;
  display: none;
}

.note-item.show-delete::after {
  display: block;
}


#tableMenu div{
  padding:8px 14px;
  cursor:pointer;
}
#tableMenu div:hover{
  background:#f0f0f0;
}



/* ğŸ”¥ æ‰‹æ©Ÿ Excel æ‹–æ›³é¸å–çš„é—œéµ */
.note-table {
  touch-action: none;                 /* é—œæ‰ç€è¦½å™¨åŸç”Ÿæ‰‹å‹¢ */
}

/* é è¨­ï¼šæ‰€æœ‰ td éƒ½ä¸å¯è¢«ç€è¦½å™¨é¸å– */
.note-table td {
  user-select: none;
  -webkit-user-select: none;
}

/* âœ… çœŸæ­£è³‡æ–™æ ¼ï¼šå…è¨±è¼¸å…¥æ–‡å­— */
.note-table td.data-cell {
  user-select: text;                  /* æ¡Œæ©Ÿ / å·²é¸å®šå¾Œå¯ç·¨è¼¯ */
  -webkit-user-select: text;
}

/* è¡Œåˆ—æ¨™é ­ç¶­æŒåŸæ¨£ */
.note-table .col-header,
.note-table .row-header {
  background: #f2f2f2;
  color: #666;
  font-weight: bold;
  text-align: center;
}

/* é¸å–é«˜äº® */
.note-table td.selected {
  background: #cce5ff;
}



.col-resizer {
  position: absolute;
  top: 0;
  right: -3px;
  width: 6px;
  height: 100%;
  cursor: col-resize;
  z-index: 10;
}



td.selected {
  background-color: rgba(0, 128, 255, 0.3); /* æ•´æ¬„/æ•´åˆ—é¸ä¸­æ•ˆæœ */
}

td.col-header:hover,
td.row-header:hover {
  cursor: pointer;
  background-color: rgba(0, 128, 255, 0.1);
}




/* ===== FAB æ–°å¢æŒ‰éˆ• ===== */
#fab {
  position: fixed;
  right: 18px;
  bottom: 18px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  font-size: 32px;
  background: #4a90e2;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  cursor: pointer;
}

/* ===== Context Menu ===== */
#contextMenu {
  position: fixed;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
  display: none;
  z-index: 9999;
}

#contextMenu div {
  padding: 10px 14px;
  cursor: pointer;
}

#contextMenu div:hover {
  background: #f0f0f0;
}

/* ===== Editor ===== */
#editor {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #f5f5f5;
  flex-direction: column;
}

#editorHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  background: #4a90e2;
  color: white;
}

#editorToolbar {
  display: flex;
  padding: 6px 10px;
  background: #eee;
  gap: 6px;
  flex-wrap: wrap;
}

#editorToolbar button {
  padding: 6px 10px;
  border: none;
  border-radius: 6px;
  background: white;
  cursor: pointer;
  font-weight: bold;
}

#editorToolbar button:hover {
  background: #ddd;
}

#editorContent {
  flex: 1;
  padding: 10px;
  display: flex;
  flex-direction: column;
}

/* #noteList æˆ– #editorContent ä»éœ€è¦å‚ç›´æ»‘å‹•ï¼š */
#noteList, #editorContent {
  overflow-y: auto;          /* å…è¨±å‚ç›´æ»¾å‹• */
  -webkit-overflow-scrolling: touch; /* iOS å¹³æ»‘æ»¾å‹• */
  touch-action: pan-y;       /* åªå…è¨±ç¸±å‘æ»‘å‹• */
}



#editorContent input,
#editorContent textarea {
  width: 100%;
  padding: 10px;
  margin-bottom: 8px;
  font-size: 16px;
  border-radius: 10px;
  border: 1px solid #ccc;
  resize: none;
}

/* Editor Swipe Hint */
#editorSwipeHint {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: none;
  align-items: center;
  justify-content: flex-start;
  padding-left: 20px;
  font-size: 22px;
  font-weight: 600;
  color: #4a90e2;
  background: rgba(245, 245, 245, 0.85);
  z-index: 9998;
  pointer-events: none;
}

/* ===== iOS å‚™å¿˜éŒ„åˆ—è¡¨å³å´ç¸®åœ– ===== */
.note-preview {
  flex-shrink: 0;
  width: 44px;
  height: 44px;
  border-radius: 6px;
  overflow: hidden;
  background: #eee;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 10px; /* èˆ‡æ–‡å­—é–“éš” */
}

/* åœ–ç‰‡ç¸®åœ– */
.note-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  border-radius: 6px;
}

/* å½±ç‰‡ç¸®åœ– */
.note-preview video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  border-radius: 6px;
}

/* è¡¨æ ¼ç¸®åœ–ï¼ˆç°¡åŒ–ï¼‰ */
.note-preview.table {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  color: #666;
  background: #f2f2f2;
}


.cell-selected {
  background: #cce5ff;
}


.note-thumb {
  width: 56px;
  height: 56px;
  flex-shrink: 0;
  overflow: hidden;
  border-radius: 6px;
  margin-left: 6px;
}

#noteList {
  touch-action: pan-x;          /* â­ é˜»æ­¢æ‰‹å‹¢æ»‘å‹• */
  overscroll-behavior: contain;
}



</style>
</head>

<body>

<header style="display:flex;justify-content:space-between;align-items:center;">
  <span>å‚™å¿˜éŒ„</span>
  <button onclick="toggleTopMenu(event)">â‹¯</button>
</header>

<input id="searchBox" placeholder="ğŸ” æœå°‹">
<div id="searchResultInfo" class="section-title" style="display:none;"></div>


<div id="noteList"></div>
<button id="fab" onclick="newNote()">ï¼‹</button>
<div id="contextMenu"></div>

<!-- ===== Editor ===== -->
<div id="editor">
  <div id="editorHeader">
    <button onclick="closeEditor()">è¿”å›åˆ—è¡¨</button>
    <button onclick="saveEditor()">å­˜æª”</button>
  </div>
  <div id="editorToolbar">
  <button onclick="changeFontSize(true)">ğŸ”¼</button> <!-- å­—é«”æ”¾å¤§ -->
  <button onclick="changeFontSize(false)">ğŸ”½</button> <!-- å­—é«”ç¸®å° -->
    <button onclick="formatText('bold')">B</button>
    <button onclick="formatText('italic')">I</button>
    <button onclick="formatText('underline')">U</button>
    <button onclick="insertTable()">è¡¨æ ¼</button>
    <button onclick="insertImage()">åœ–ç‰‡</button>
    <button onclick="insertVideo()">å½±ç‰‡</button>
  </div>
<div id="editorContent">
  <div id="content" contenteditable="true" style="flex:1; padding:10px; border:1px solid #ccc; border-radius:10px; overflow:auto;" placeholder="é–‹å§‹è¼¸å…¥â€¦"></div>
</div>

</div>

</div>

<!-- âœ… å°±æ”¾åœ¨é€™è£¡ -->
<div id="editorSwipeHint">â¬… è¿”å›åˆ—è¡¨</div>


<div id="topMenu" style="
  position:fixed;
  top:60px;
  right:10px;
  background:#fff;
  border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,.25);
  display:none;
  z-index:9999;">
</div>

<input type="file" id="backupFile" style="display:none" accept=".json">

<input type="file" id="imgPicker" accept="image/*" hidden>


<div id="tableMenu" style="
  position:fixed;
  display:none;
  background:#fff;
  border:1px solid #ccc;
  border-radius:6px;
  box-shadow:0 4px 10px rgba(0,0,0,.15);
  z-index:9999;
">
  <div data-act="merge">åˆä½µå„²å­˜æ ¼</div>
<div data-act="merge-vertical">å‚ç›´åˆä½µ</div>
  <div data-act="split">åˆ†å‰²å„²å­˜æ ¼</div>
  <div data-act="delete">åˆªé™¤è¡¨æ ¼</div>
<div data-act="add-col-left">â¬… æ’å…¥æ¬„</div>
<div data-act="add-col-right">â¡ æ’å…¥æ¬„</div>
<div data-act="add-row-up">â¬† æ’å…¥åˆ—</div>
<div data-act="add-row-down">â¬‡ æ’å…¥åˆ—</div>

</div>



<div id="mediaMenu" style="
  position:fixed;
  display:none;
  background:#fff;
  border:1px solid #ccc;
  border-radius:6px;
  box-shadow:0 4px 10px rgba(0,0,0,.15);
  z-index:9999;
">
  <div data-act="zoomIn">æ”¾å¤§</div>
  <div data-act="zoomOut">ç¸®å°</div>
  <div data-act="delete">åˆªé™¤</div>
</div>






<script>

/* ========= IndexedDB ========= */
const DB_NAME="notesDB",STORE="notes";
let db,currentId=null;

function openDB(){return new Promise(r=>{const q=indexedDB.open(DB_NAME,1);q.onupgradeneeded=e=>{e.target.result.createObjectStore(STORE,{keyPath:"id"});};q.onsuccess=e=>{db=e.target.result;r();};});}
function tx(m){return db.transaction(STORE,m).objectStore(STORE);}
function save(n){tx("readwrite").put(n);}
function all(){return new Promise(r=>{const q=tx("readonly").getAll();q.onsuccess=()=>r(q.result);});}

/* ========= Crypto ========= */
async function keyFromPassword(pw,salt){
 const enc=new TextEncoder();
 const base=await crypto.subtle.importKey("raw",enc.encode(pw),"PBKDF2",false,["deriveKey"]);
 return crypto.subtle.deriveKey({name:"PBKDF2",salt,iterations:100000,hash:"SHA-256"},base,{name:"AES-GCM",length:256},false,["encrypt","decrypt"]);
}
function rand(n){return crypto.getRandomValues(new Uint8Array(n));}
async function encryptText(t,pw){
 const iv=rand(12),salt=rand(16);
 const key=await keyFromPassword(pw,salt);
 const buf=await crypto.subtle.encrypt({name:"AES-GCM",iv},key,new TextEncoder().encode(t));
 return{iv:[...iv],salt:[...salt],data:[...new Uint8Array(buf)]};
}
async function decryptText(o,pw){
 const key=await keyFromPassword(pw,new Uint8Array(o.salt));
 const buf=await crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(o.iv)},key,new Uint8Array(o.data));
 return new TextDecoder().decode(buf);
}

/* ========= 
âœ… iOS å…©è¡Œé¡¯ç¤º

âœ… å·¦æ»‘åˆªé™¤

âœ… å³æ»‘é‡˜é¸

âœ… å³éµé¸å–®ï¼ˆæ¡Œæ©Ÿå¥½ç”¨ï¼‰

âŒ ä¸æ”¾æ‹–æ›³ï¼ˆå¯å†åŠ ï¼‰

========= */

/* ========= Render ========= */
const list=document.getElementById("noteList");


// å…¨åŸŸæœå°‹æ¡†
const searchInput = document.getElementById("searchBox");

// é«˜äº®å‡½å¼
function highlight(text, keyword){
  if(!keyword) return text;
  const re = new RegExp(`(${keyword.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`, "gi");
  return text.replace(re, '<mark>$1</mark>');
}


// åˆ·æ–°åˆ—è¡¨æ™‚ï¼Œå°‡é—œéµå­—å¸¶å…¥ï¼ˆå«æœå°‹é–å®šï¼‰
async function refresh() {
  const q = searchInput.value.trim().toLowerCase();
  const info = document.getElementById("searchResultInfo");

  if (isSearching && !q) return;

  const ns = (await all()).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

  const filtered = ns.filter(n => {
    if (!q) return true;
    if (typeof n.content !== "string") return false;
    return n.content.toLowerCase().includes(q);
  });

  if (q) {
    info.style.display = "block";
    info.textContent = filtered.length
      ? `æ‰¾åˆ° ${filtered.length} ç­†çµæœ`
      : "æ²’æœ‰ç¬¦åˆçš„å‚™å¿˜éŒ„";
  } else {
    info.style.display = "none";
  }

  list.innerHTML = "";

  const pinned = filtered.filter(n => n.pinned);
  const normal = filtered.filter(n => !n.pinned);

  function renderWithContext(note) {
    renderNote(note, q); // renderNote æœ¬èº«å°± append åˆ° list
    const noteItems = list.querySelectorAll(".note-item"); 
    const lastItem = noteItems[noteItems.length - 1]; // å–å¾—å‰› render å‡ºä¾†çš„é‚£å€‹
    addContextMenuToNoteItem(lastItem, note); // ç¶å®šå³éµ
  }

  if (pinned.length) {
    list.innerHTML += `<div class="section-title">å·²é‡˜é¸</div>`;
    pinned.forEach(renderWithContext);
  }

  normal.forEach(renderWithContext);
}


/* =============================renderNote æ”¹æˆæ¥æ”¶é—œéµå­—=========================================== */

function renderNote(n, keyword="") {
  if (!n.timestamp) n.timestamp = Date.now();

  const { lines, firstMedia } = extractTextLinesFromHTMLWithMedia(n.content || "");

  let line1 = lines[0] || "ç„¡å…§å®¹";
  if (line1.length > 30) line1 = line1.slice(0, 30) + "...";

  let line2Text = lines[1] || "";
  if (keyword) {
    const hitLine = lines.find(
      (l, i) => i !== 0 && l.toLowerCase().includes(keyword)
    );
    if (hitLine) line2Text = hitLine;
  }

  if (line2Text.length > 40) line2Text = line2Text.slice(0, 40) + "...";

  const timeText = formatListTime(n.timestamp);
  let line2 = `${timeText} ${line2Text}`;

  if (keyword) {
    line1 = highlight(line1, keyword);
    line2 = highlight(line2, keyword);
  }

  const d = document.createElement("div");
  d.className = "note-item" + (n.pinned ? " pinned" : "");

  d.innerHTML = `
    <div class="swipe-bg delete"></div>
    <div class="swipe-bg pin"></div>
    <div class="note-main" style="display:flex; justify-content:space-between; align-items:center;">
      <div style="flex:1; min-width:0;">
        <div class="note-title">${line1}</div>
        <div class="note-sub">${line2}</div>
      </div>
      <div class="note-thumb" style="margin-left:-12px; position:relative; width: 60px; height: 60px; overflow: hidden; border-radius: 4px; background-color: #f0f0f0;">
        <!-- ç¸®åœ–æ”¾ç½®å€ -->
      </div>
    </div>
  `;

// æ”¾ç½®ç¸®åœ–ï¼ˆåœ–ç‰‡ / å½±ç‰‡ / è¡¨æ ¼ï¼‰
const thumb = d.querySelector(".note-thumb");

if (firstMedia) {
  if (firstMedia.tagName === "IMG") {
    const img = document.createElement("img");
    img.src = firstMedia.src;
    img.style.width = "100%";
    img.style.height = "100%";
    img.style.objectFit = "cover";   // âœ… å¡«æ»¿ï¼Œä¸ç•™ç™½
    img.style.borderRadius = "6px";
    thumb.appendChild(img);

  } else if (firstMedia.tagName === "VIDEO") {
    const vid = document.createElement("video");
    vid.src = firstMedia.src;
    vid.muted = true;
    vid.playsInline = true;
    vid.style.width = "100%";
    vid.style.height = "100%";
    vid.style.objectFit = "cover";   // âœ… ä¸ä¿æŒæ¯”ä¾‹
    thumb.appendChild(vid);

  } else if (firstMedia.tagName === "TABLE") {
    const table = document.createElement("table");
    table.style.width = "100%";
    table.style.height = "100%";
    table.style.borderCollapse = "collapse";
    table.style.fontSize = "7px";
    table.style.tableLayout = "fixed";
    table.style.transform = "scale(0.9)"; // âœ… é¿å…è¢«è£
    table.style.transformOrigin = "top left";

    const rows = firstMedia.rows;
    for (let r = 0; r < Math.min(2, rows.length); r++) {
      const tr = document.createElement("tr");
      for (let c = 0; c < Math.min(2, rows[r].cells.length); c++) {
        const td = document.createElement("td");
        td.style.border = "1px solid #ccc";
        td.style.padding = "0";
        tr.appendChild(td);
      }
      table.appendChild(tr);
    }
    thumb.appendChild(table);
  }
}


  d.onclick = () => openEditor(n);
  addSwipeListeners(d, n);
  list.appendChild(d);
}








/* ========= Editor ================================================================================= */
const editor=document.getElementById("editor");
const contentI=document.getElementById("content");


/* ========= æ‰“é–‹ç·¨è¼¯å™¨ ========= */
function openEditor(n){
  currentId = n.id;

  if(n.encrypted){
    contentI.innerHTML = "ğŸ”’ å·²åŠ å¯†ï¼Œè«‹è§£å¯†";
    contentI.contentEditable = false;
  } else {
    contentI.innerHTML = n.content || "";
    contentI.contentEditable = true;

    // âœ… æ–°å¢ï¼šç¶å®šè‡ªå‹•å„²å­˜ï¼ˆåªåœ¨æœªåŠ å¯†æ™‚ï¼‰
    bindAutoSave(contentI, n);
  }

  document.getElementById("noteList").style.display = "none";
  document.getElementById("fab").style.display = "none";
  document.getElementById("searchBox").style.display = "none";
  editor.style.display = "flex";
}

/* ========= å­˜æª” ========= */
function saveEditor(){
  if(!currentId) return;

  all().then(ns=>{
    const n = ns.find(x=>x.id===currentId);
    if(!n || n.encrypted) return;

    const html = contentI.innerHTML; // HTML
    const text = contentI.innerText.trim(); // ç”¨æ–‡å­—ç¬¬ä¸€è¡Œä½œæ¨™é¡Œ
    const lines = text.split("\n");

n.content = html;
n.title = lines[0] || "";
n.timestamp = Date.now(); // ğŸ”¥ é—œéµ
save(n);

    refresh();
  });
}

/* ========= æ–°å¢ç­†è¨˜ ========= */
function newNote(){
  const n = {
  id: Date.now().toString(),
  title: "",
  content: "",
  encrypted: false,
  pinned: false,
  timestamp: Date.now() // ğŸ”¥
};
  save(n);
  contentI.innerHTML = ""; // æ¸…ç©ºç·¨è¼¯å™¨
  openEditor(n);
}


/* ========= Context / Top Menu å…±ç”¨å…§å®¹ ========= */
const menuHTML = `
<div onclick="ctxEncrypt()">ğŸ” åŠ å¯†</div>
<div onclick="ctxDecrypt(false)">ğŸ”“ è§£å¯†ï¼ˆæš«æ™‚ï¼‰</div>
<div onclick="ctxDecrypt(true)">ğŸ”“ è§£å¯†ä¸¦è§£é™¤</div>
<div onclick="exportSingleNote()">ğŸ“¤ åŒ¯å‡ºå–®ç­†</div>
<div onclick="exportAllNotes()">ğŸ“¦ åŒ¯å‡ºå…¨éƒ¨</div>
<div onclick="document.getElementById('backupFile').click()">ğŸ“¥ åŒ¯å…¥</div>
<div onclick="deleteCurrent()">ğŸ—‘ åˆªé™¤</div>
 <div onclick="confirmPasswordAndDelete()">ğŸ—‘ å…¨éƒ¨åˆªé™¤</div> <!-- æ–°å¢ã€Œå…¨éƒ¨åˆªé™¤ã€é¸é … -->
`;


/* ========= Context Menu ========= */
const menu = document.getElementById("contextMenu");

  // é¡¯ç¤ºå³éµèœå–®
  function showMenu(event, note) {
    event.preventDefault(); // é˜»æ­¢å³éµèœå–®çš„é»˜èªè¡Œç‚º
    menu.innerHTML = menuHTML; // ç¢ºä¿èœå–®å…§å®¹æ˜¯æœ€æ–°çš„

    // è¨­ç½®èœå–®çš„ä½ç½®
    menu.style.left = `${event.clientX}px`;
    menu.style.top = `${event.clientY}px`;
    menu.style.display = "block";

    // ç‚ºæ¯å€‹èœå–®é …ç¶å®šå°æ‡‰çš„åŠŸèƒ½
    menu.querySelector("div[onclick='ctxEncrypt()']").onclick = () => ctxEncrypt(note);
    menu.querySelector("div[onclick='ctxDecrypt(false)']").onclick = () => ctxDecrypt(false, note);
    menu.querySelector("div[onclick='ctxDecrypt(true)']").onclick = () => ctxDecrypt(true, note);
    menu.querySelector("div[onclick='exportSingleNote()']").onclick = () => exportSingleNote(note);
    menu.querySelector("div[onclick='deleteCurrent()']").onclick = () => deleteCurrent(note);
    
    // éš±è—åŸåˆ—è¡¨å€å³ä¸Šè§’çš„åŠŸèƒ½
    document.getElementById("topMenu").style.display = "none";
  }

  // è¨»å†Šå³éµäº‹ä»¶
  function addContextMenuToNoteItem(noteItem, note) {
    noteItem.addEventListener('contextmenu', (event) => showMenu(event, note));
  }


/* ========= Encrypt / Decrypt (prompt) ========= */
 // åœ¨ä¿å­˜ç­†è¨˜æ™‚è¨˜éŒ„é¸æ“‡çš„ ID
  async function ctxEncrypt(note) {
    const pw = prompt("è«‹è¼¸å…¥åŠ å¯†å¯†ç¢¼");
    if (!pw) return;

    note.content = await encryptText(note.content, pw);
    note.encrypted = true;
    save(note);
    refresh();
  }

  async function ctxDecrypt(permanent, note) {
    const pw = prompt("è«‹è¼¸å…¥è§£å¯†å¯†ç¢¼");
    if (!pw) return;

    try {
      const txt = await decryptText(note.content, pw);
      if (permanent) {
        note.content = txt;
        note.encrypted = false;
        save(note);
        refresh();
      } else {
        alert(txt);
      }
    } catch {
      alert("è§£å¯†å¤±æ•—");
    }
  }

async function exportSingleNote(note) {
  let txt = note.content;

  if (note.encrypted) {
    const pw = prompt("è¼¸å…¥åŸå¯†ç¢¼");
    if (!pw) return;
    txt = await decryptText(note.content, pw);
  }

  const bpw = prompt("å‚™ä»½å¯†ç¢¼");
  if (!bpw) return;

  const enc = await encryptText(txt, bpw);

  downloadFile(
    JSON.stringify({
      title: note.title,
      content: "enc:" + JSON.stringify(enc),
      timestamp: note.timestamp
    }, null, 2),
    `${note.title || "note"}.json`
  );
}

/* ========= æ–°å¢ã€Œå…¨éƒ¨åˆªé™¤ã€é¸é …  ========= */

// åˆªé™¤æ‰€æœ‰ç­†è¨˜çš„æ“ä½œ
async function deleteAllNotes() {
    const notes = await all();
    const txObject = tx("readwrite");
    notes.forEach(note => txObject.delete(note.id));  // åˆªé™¤æ‰€æœ‰ç­†è¨˜
    alert("æ‰€æœ‰ç­†è¨˜å·²æˆåŠŸåˆªé™¤ï¼");
    refresh();  // é‡æ–°æ•´ç†åˆ—è¡¨
}


/* ========= è¨­ç½®å¯†ç¢¼ (é¦–æ¬¡è¨­ç½®)  ========= */


// å¯†ç¢¼åŠ å¯†
async function encryptPassword(password) {
    const salt = new Uint8Array(16);  // ä½ å¯ä»¥é¸æ“‡éš¨æ©Ÿç”Ÿæˆsalt
    crypto.getRandomValues(salt);  // éš¨æ©Ÿç”Ÿæˆ salt

    const enc = new TextEncoder();
    const baseKey = await crypto.subtle.importKey(
        "raw",
        enc.encode(password), 
        "PBKDF2", 
        false, 
        ["deriveKey"]
    );

    // ä½¿ç”¨ PBKDF2 æ´¾ç”Ÿå‡º AES å¯†é‘°
    const key = await crypto.subtle.deriveKey(
        { name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256" },
        baseKey,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
    );

    // ç”¨ AES-GCM åŠ å¯† password å­—ä¸²
    const iv = crypto.getRandomValues(new Uint8Array(12));  // éš¨æ©Ÿåˆå§‹åŒ–å‘é‡
    const encrypted = await crypto.subtle.encrypt(
        { name: "AES-GCM", iv },
        key,
        enc.encode(password)
    );

    return { iv: Array.from(iv), salt: Array.from(salt), data: Array.from(new Uint8Array(encrypted)) };
}


// è¨­ç½®å¯†ç¢¼ä¸¦åŠ å¯†å­˜å„²
async function setPassword(password) {
    const key = await encryptPassword(password); // åŠ å¯†å¯†ç¢¼
    const encryptedPassword = JSON.stringify(key); // å¯ä»¥æ ¹æ“šéœ€æ±‚å°å¯†é‘°é€²è¡Œåºåˆ—åŒ–
    localStorage.setItem("encryptedPassword", encryptedPassword); // å­˜å„²åŠ å¯†å¯†é‘°
    alert("å¯†ç¢¼å·²è¨­ç½®ï¼");
}

// è¨­ç½®å¯†ç¢¼çš„ç•Œé¢
function setupPassword() {
    const password = prompt("è«‹è¨­ç½®å¯†ç¢¼");
    if (password) {
        setPassword(password);
    }
}



/* ========= å¯†ç¢¼ç¢ºèªï¼ˆåˆªé™¤æ‰€æœ‰ç­†è¨˜ï¼‰  ========= */

// å¯†ç¢¼è§£å¯†å‡½å¼
async function decryptPassword(encryptedPassword, inputPassword) {
    const enc = new TextEncoder();
    const salt = new Uint8Array(encryptedPassword.salt);
    const baseKey = await crypto.subtle.importKey("raw", enc.encode(inputPassword), "PBKDF2", false, ["deriveKey"]);
    
    // æ´¾ç”Ÿ AES å¯†é‘°
    const key = await crypto.subtle.deriveKey(
        { name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256" },
        baseKey,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
    );

    // è§£å¯†å¯†ç¢¼
    const iv = new Uint8Array(encryptedPassword.iv);
    const data = new Uint8Array(encryptedPassword.data);
    try {
        const decryptedBuffer = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, data);
        const decryptedPassword = new TextDecoder().decode(decryptedBuffer);
        return decryptedPassword === inputPassword;  // æ¯”å°è§£å¯†å¾Œçš„å¯†ç¢¼
    } catch (e) {
        return false;  // å¯†ç¢¼éŒ¯èª¤
    }
}


// å¯†ç¢¼ç¢ºèªå¾ŒåŸ·è¡Œåˆªé™¤
async function confirmPasswordAndDelete() {
    const encryptedPassword = JSON.parse(localStorage.getItem("encryptedPassword"));
    if (!encryptedPassword) {
        // å¯†ç¢¼å°šæœªè¨­ç½®ï¼Œæç¤ºç”¨æˆ¶è¨­ç½®å¯†ç¢¼
        const newPassword = prompt("å¯†ç¢¼å°šæœªè¨­ç½®ï¼Œè«‹è¨­ç½®æ–°å¯†ç¢¼ã€‚");

        if (newPassword) {
            const encrypted = await encryptPassword(newPassword);  // å°‡å¯†ç¢¼åŠ å¯†
            localStorage.setItem("encryptedPassword", JSON.stringify(encrypted));  // å„²å­˜åŠ å¯†å¾Œçš„å¯†ç¢¼
            alert("å¯†ç¢¼è¨­ç½®æˆåŠŸï¼è«‹å†æ¬¡æ“ä½œã€Œå…¨éƒ¨åˆªé™¤ã€ã€‚");
        } else {
            alert("å¯†ç¢¼è¨­ç½®å¤±æ•—ï¼Œè«‹é‡æ–°è¨­ç½®ï¼");
        }

        return;  // è·³éå¾ŒçºŒçš„åˆªé™¤æ“ä½œ
    }

    const password = prompt("è«‹è¼¸å…¥å¯†ç¢¼é€²è¡Œç¢ºèª");

    if (password) {
        const isValid = await decryptPassword(encryptedPassword, password);
        if (isValid) {
            if (confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ç­†è¨˜å—ï¼Ÿé€™å€‹æ“ä½œç„¡æ³•æ¢å¾©ï¼")) {
                deleteAllNotes(); // åŸ·è¡Œåˆªé™¤æ“ä½œ
            }
        } else {
            alert("å¯†ç¢¼éŒ¯èª¤ï¼Œæ“ä½œå–æ¶ˆï¼");
        }
    }
}


// åˆªé™¤æ‰€æœ‰ç­†è¨˜
async function deleteAllNotes() {
    if (!confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ç­†è¨˜å—ï¼Ÿé€™å€‹æ“ä½œç„¡æ³•æ¢å¾©ï¼")) return;

    // åˆªé™¤æ‰€æœ‰ç­†è¨˜
    const notes = await all();
    const txObject = tx("readwrite");
    notes.forEach(note => txObject.delete(note.id));  // åˆªé™¤æ‰€æœ‰ç­†è¨˜
    alert("æ‰€æœ‰ç­†è¨˜å·²æˆåŠŸåˆªé™¤ï¼");
    refresh();  // é‡æ–°æ•´ç†åˆ—è¡¨
}





//====================================================

  async function deleteCurrent(note) {
    if (!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
    tx("readwrite").delete(note.id);
    refresh();
  }


document.body.addEventListener('click', e => {
  const clickInContextMenu = e.target.closest('#contextMenu');
  const clickInTopMenu     = e.target.closest('#topMenu');
  const clickInHeader      = e.target.closest('header');

  if (!clickInContextMenu && !clickInTopMenu && !clickInHeader) {
    menu.style.display = "none";
    topMenu.style.display = "none"; // å¦‚æœä½ æƒ³åœ¨é»ç©ºç™½æ™‚åŒæ™‚éš±è—ä¸Šæ–¹åŠŸèƒ½
  }
});

/* ========= Export / Import ========= */
function downloadFile(c,f){
 const b=new Blob([c],{type:"application/json"});
 const u=URL.createObjectURL(b);
 const a=document.createElement("a");a.href=u;a.download=f;
 document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(u);
}



async function exportAllNotes() {
    const ns = await all();
    const upw = prompt("è¼¸å…¥åŸè§£å¯†å¯†ç¢¼ï¼ˆè‹¥æœ‰åŠ å¯†ï¼‰");
    if (upw === null) return;
    const bpw = prompt("è¼¸å…¥å‚™ä»½å¯†ç¢¼");
    if (!bpw) return;

    const out = {};

    for (const n of ns) {
        try {
            let txt = (n.content ?? "").toString(); // ç¢ºä¿æ˜¯å­—ä¸²

            // å…ˆè§£å¯†ï¼ˆå¦‚æœæ˜¯åŠ å¯†ç­†è¨˜ï¼‰
            if (n.encrypted) {
                txt = await decryptText(n.content, upw);
            }

            // ğŸ”¹ é¿å…è¶…å¤§å½±ç‰‡æˆ–åœ–ç‰‡é€ æˆåŠ å¯†å¤±æ•—
            const div = document.createElement("div");
            div.innerHTML = txt;

            // ç§»é™¤å½±ç‰‡ï¼ˆé¿å…å¤§æª”æ¡ˆï¼‰
            div.querySelectorAll("video").forEach(v => v.remove());

            // ç§»é™¤éå¤§çš„åœ–ç‰‡ï¼ˆä¾‹å¦‚ base64 è¶…é 100 KB å¯èª¿æ•´ï¼‰
            div.querySelectorAll("img").forEach(img => {
                if (img.src.length > 100000) img.remove();
            });

            txt = div.innerHTML;

            // åŠ å¯†ç­†è¨˜å…§å®¹
            const enc = await encryptText(txt, bpw);

            out[n.id] = {
                title: n.title || "",
                timestamp: n.timestamp,
                content: "enc:" + JSON.stringify(enc)
            };
        } catch (e) {
            console.warn(`ç­†è¨˜ã€Œ${n.title || n.id}ã€åŒ¯å‡ºå¤±æ•—ï¼Œå·²è·³é`, e);
            continue; // é‡åˆ°å•é¡Œç­†è¨˜ç•¥éï¼Œä¸ä¸­æ­¢æ•´å€‹åŒ¯å‡º
        }
    }

    if (Object.keys(out).length === 0) {
        alert("æ²’æœ‰ç­†è¨˜æˆåŠŸåŒ¯å‡ºï¼");
        return;
    }

    downloadFile(JSON.stringify(out, null, 2), "notes-backup.json");
    alert("åŒ¯å‡ºå®Œæˆï¼å¤§æª”å½±ç‰‡å·²è‡ªå‹•æ’é™¤ï¼Œæ–‡å­—èˆ‡å°åœ–ç‰‡å·²å‚™ä»½ã€‚");
}




document.getElementById("backupFile").onchange=async e=>{
 const f=e.target.files[0]; if(!f)return;
 const pw=prompt("è¼¸å…¥å‚™ä»½å¯†ç¢¼"); if(!pw)return;
 const data=JSON.parse(await f.text());
 if(data.content){
  const t=await decryptText(JSON.parse(data.content.slice(4)),pw);
  save({id:Date.now().toString(),title:data.title,content:t,encrypted:false,timestamp:Date.now()});
 }else{
  for(const k in data){
   const t=await decryptText(JSON.parse(data[k].content.slice(4)),pw);
   save({id:k,title:data[k].title,content:t,encrypted:false,timestamp:data[k].timestamp});
  }
 }
 refresh();
};



/* =========è¨˜éŒ„æ¸¸æ¨™ä½ç½®ï¼ˆä»»ä½•è¼¸å…¥æ™‚ï¼‰ ========= */
contentI.addEventListener("keyup", saveSelection);
contentI.addEventListener("mouseup", saveSelection);

function saveSelection() {
  const sel = window.getSelection();
  if (sel.rangeCount > 0) {
    savedRange = sel.getRangeAt(0);
  }
}



/* =========æ–°å¢ã€Œç”¨ touch åº§æ¨™æ‰¾ tdã€çš„å·¥å…·å‡½å¼========= */

function getCellFromTouch(touch) {
  const el = document.elementFromPoint(
    touch.clientX,
    touch.clientY
  );
  if (!el) return null;
  return el.closest("td.data-cell");
}



/* =========JSï¼ˆè¡¨æ ¼å³éµï¼‰ ========= */

let activeCell = null;
let activeTable = null;
let activeMedia = null;

contentI.addEventListener("contextmenu", e => {
  const td = e.target.closest("td.data-cell");
  const media = e.target.closest("img, video");

  // ================= è¡¨æ ¼å³éµ =================
  if (td) {
    // â­ å®Œå…¨æ¥ç®¡å³éµè¡Œç‚º
    e.preventDefault();
    e.stopPropagation();

    activeTable = td.closest("table");
    activeMedia = null;

    const selected = getSelectedDataCells();

    // ğŸ‘‰ å¦‚æœç›®å‰æ²’æœ‰ä»»ä½•é¸å–ï¼Œæ‰é¸å–å³éµé‚£æ ¼
    if (selected.length === 0) {
      clearCellSelection();
      td.classList.add("selected");
      anchorCell = td;
    }

    // ğŸ‘‰ activeCell æ°¸é æŒ‡å‘ selection çš„å·¦ä¸Šè§’ï¼ˆç©©å®šï¼‰
    const cells = getSelectedDataCells();
    if (cells.length > 0) {
      activeCell = cells[0];
    }

    // é¡¯ç¤ºè¡¨æ ¼å³éµé¸å–®
    const menu = document.getElementById("tableMenu");
    menu.style.left = e.clientX + "px";
    menu.style.top = e.clientY + "px";
    menu.style.display = "block";

    // éš±è— media menu
    document.getElementById("mediaMenu").style.display = "none";
    return;
  }

  // ================= åœ–ç‰‡ / å½±ç‰‡å³éµ =================
  if (media) {
    e.preventDefault();
    e.stopPropagation();

    activeMedia = media;
    activeCell = null;
    activeTable = null;

    const menu = document.getElementById("mediaMenu");
    menu.style.left = e.clientX + "px";
    menu.style.top = e.clientY + "px";
    menu.style.display = "block";

    document.getElementById("tableMenu").style.display = "none";
    return;
  }
});


// é»ç©ºç™½è™•é—œé–‰æ‰€æœ‰é¸å–®
document.addEventListener("click", () => {
  document.getElementById("tableMenu").style.display = "none";
  document.getElementById("mediaMenu").style.display = "none";
});



/* ========= è¡¨æ ¼å³éµï¼šåˆä½µ / åˆ†å‰² / åˆªé™¤ / æ’å…¥åˆ—æ¬„ ========= */
document.getElementById("tableMenu").onclick = e => {
  const act = e.target.dataset.act;
  if (!act) return;

  let didAction = false;

  // ğŸ‘‰ åˆä½µï¼ˆä½¿ç”¨ selected cellsï¼‰
  if (act === "merge") {
    mergeSelectedCells();
    didAction = true;
  }

  // ğŸ‘‰ åˆ†å‰²ï¼ˆä»ä»¥ activeCell ç‚ºä¸»ï¼‰
  if (act === "split") {
    if (activeCell) {
      splitCell(activeCell);
      didAction = true;
    }
  }

  // ğŸ‘‰ åˆªé™¤ï¼ˆselected ç‚ºä¸»ï¼‰
  if (act === "delete") {
    deleteSelectedCells();
    didAction = true;
  }

  // ---------- æ’å…¥åˆ— / æ¬„ï¼ˆéœ€è¦ activeCellï¼‰ ----------
  if (
    act === "add-col-left" ||
    act === "add-col-right" ||
    act === "add-row-up" ||
    act === "add-row-down"
  ) {
    if (!activeCell) return;

    const table = activeCell.closest("table");
    const col = activeCell.cellIndex;
    const row = activeCell.parentElement.rowIndex;

    if (act === "add-col-left") addColumn(table, col);
    if (act === "add-col-right") addColumn(table, col + 1);
    if (act === "add-row-up") addRow(table, row);
    if (act === "add-row-down") addRow(table, row + 1);

    addColumnResizers(table);
    addRowResizers(table);

    didAction = true;
  }

  // â­ åªæœ‰çœŸçš„ã€Œæ”¹å‹•è¡¨æ ¼ã€æ‰ reset
  if (didAction) {
    resetTableSelectionState();
    contentI.dispatchEvent(new Event("input"));
  }
};




// æ–°å¢ä¸€åˆ—ï¼ˆRowï¼‰

function addRow(table, index = null) {
  const row = table.rows[0];
  const tr = document.createElement("tr");

  for (let i = 0; i < row.cells.length; i++) {
    const td = document.createElement("td");
    td.contentEditable = "true";
    td.style.border = "1px solid #ccc";
    td.style.padding = "6px 8px";
    tr.appendChild(td);
  }

  if (index === null) table.appendChild(tr);
  else table.insertBefore(tr, table.rows[index]);
}



// æ–°å¢ä¸€æ¬„ï¼ˆColumnï¼‰

function addColumn(table, index = null) {
  Array.from(table.rows).forEach(row => {
    const td = document.createElement("td");
    td.contentEditable = "true";
    td.style.border = "1px solid #ccc";
    td.style.padding = "6px 8px";

    if (index === null) row.appendChild(td);
    else row.insertBefore(td, row.cells[index]);
  });
}




/* ========= Editor Toolbar Functions ========= */
/* ========= ç·¨è¼¯å™¨ Toolbar åŠŸèƒ½ ========= */

function formatText(cmd){
  document.execCommand(cmd, false, null);
}

function changeFontSize(increase=true){
  const sel = window.getSelection();
  if(!sel.rangeCount) return;

  // execCommand("fontSize") ç¯„åœ 1~7
  // 3 æ˜¯é è¨­ï¼Œ5 å¤§ï¼Œ7 æ›´å¤§
  document.execCommand("fontSize", false, increase ? "5" : "3");
}


//==== 2. è¡¨æ ¼è¨­ç½®ï¼Œä¸¦åŠ å…¥åˆä½µ/åˆ†å‰²åŠŸèƒ½====å®Œå…¨ç¬¦åˆ Excel å¼çš„è¡¨æ ¼çµæ§‹

function insertTable(rows = 5, cols = 5) {
  const table = document.createElement("table");
  table.className = "note-table";
  table.setAttribute("contenteditable", "false");
  table.style.borderCollapse = "collapse";
  table.style.margin = "8px 0";

  for (let r = 0; r <= rows; r++) {
    const tr = document.createElement("tr");

    for (let c = 0; c <= cols; c++) {
      const td = document.createElement("td");
      td.style.border = "1px solid #ccc";
      td.style.minWidth = "80px";
      td.style.height = "32px";

      // â”€â”€â”€â”€â”€ å·¦ä¸Šè§’ï¼ˆç©ºç™½ï¼‰â”€â”€â”€â”€â”€
      if (r === 0 && c === 0) {
        td.className = "corner-cell";
        td.contentEditable = "false";
        td.innerHTML = "";
      }

      // â”€â”€â”€â”€â”€ æ¬„æ¨™é¡Œ A B C â”€â”€â”€â”€â”€
      else if (r === 0) {
        td.className = "col-header";
        td.contentEditable = "false";
        td.innerHTML = String.fromCharCode(64 + c); // A B C
      }

      // â”€â”€â”€â”€â”€ åˆ—æ¨™é¡Œ 1 2 3 â”€â”€â”€â”€â”€
      else if (c === 0) {
        td.className = "row-header";
        td.contentEditable = "false";
        td.innerHTML = r;
      }

      // â”€â”€â”€â”€â”€ çœŸæ­£è³‡æ–™æ ¼ï¼ˆA1 é–‹å§‹ï¼‰â”€â”€â”€â”€â”€
      else {
        td.className = "data-cell";
        td.contentEditable = "true";
        td.innerHTML = "\u200B"; // é›¶å¯¬å­—
      }

      tr.appendChild(td);
    }

    table.appendChild(tr);
  }

  insertNodeAtCursor(table);

  // æ¸¸æ¨™æ”¾åœ¨ A1
  const firstDataCell = table.querySelector(".data-cell");
  placeCaretInsideCell(firstDataCell);

  enableExcelSelection(table);
  addColumnResizers(table);
  addRowResizers(table);

  contentI.dispatchEvent(new Event("input"));
}



// ===== å•Ÿç”¨è¡¨æ ¼é¸å–åŠŸèƒ½ =====
let anchorCell = null;
let isDragging = false;
let dragStartCell = null;

function resetTableSelectionState() {
  anchorCell = null;
  dragStartCell = null;
  isDragging = false;
  clearCellSelection();
}


contentI.addEventListener("focus", () => {
  resetTableSelectionState();
});



// ========æ‰‹æ©Ÿç‰ˆæœ¬åŠŸèƒ½========== é—œéµæ”¹æ³•:åŠ å…¥ã€Œé•·æŒ‰ = å³éµã€======================
// ===== æ–°å¢ã€Œé•·æŒ‰åµæ¸¬ã€ (åªçµ¦æ‰‹æ©Ÿç”¨)=====
// ===== åŠ åœ¨JSå…¨åŸŸ (åªè¦ä¸€æ¬¡)=====



function startLongPress(e, td) {
  cancelLongPress();

  longPressTimer = setTimeout(() => {
    // â­ åªæœ‰ã€Œæ²’æœ‰æ‹–å‹•ã€æ‰çœŸçš„ç®—é•·æŒ‰
    if (!mobileHasMoved) {
      handleTableContextMenu(e, td);
    }
  }, LONG_PRESS_TIME);
}

function cancelLongPress() {
  if (longPressTimer) {
    clearTimeout(longPressTimer);
    longPressTimer = null;
  }
}




// =========================== æ‰‹æ©Ÿæ‹–æ›³é¸å–é‚è¼¯ =================================================================================


let mobileSelecting = false;
let mobileStartCell = null;
let mobileHasMoved = false;
let longPressTimer = null;


// ===================== çµ±ä¸€é¡¯ç¤ºå³éµå‡½æ•¸ =========================
function showContextMenu(cell) {
  if (!cell) return;
  const rect = cell.getBoundingClientRect();

  const fakeEvent = {
    clientX: rect.left + rect.width / 2,
    clientY: rect.top + rect.height / 2,
    touches: [{ clientX: rect.left + rect.width / 2, clientY: rect.top + rect.height / 2 }],
    target: cell,
    type: "touch",
    preventDefault: () => {},
    stopPropagation: () => {}
  };

  handleTableContextMenu(fakeEvent, cell);
}

// ===== touchstart =====
contentI.addEventListener("touchstart", e => {
  const td = e.target.closest("td.data-cell");
  if (!td) return;

  e.preventDefault();

  mobileSelecting = true;
  mobileHasMoved = false;
  mobileStartCell = td;

  clearCellSelection();
  td.classList.add("selected");

  longPressTimer = setTimeout(() => {
    if (!mobileHasMoved && mobileStartCell) {
      showContextMenu(mobileStartCell);
    }
  }, 500);
}, { passive: false });

// ===== touchmove =====
contentI.addEventListener("touchmove", e => {
  if (!mobileSelecting) return;
  e.preventDefault();

  const touch = e.touches[0];
  const td = document.elementFromPoint(touch.clientX, touch.clientY)?.closest("td.data-cell");
  if (!td) return;

  mobileHasMoved = true;
  clearCellSelection();
  selectRect(mobileStartCell, td);

  clearTimeout(longPressTimer);
}, { passive: false });

// ===== touchend =====
contentI.addEventListener("touchend", e => {
  clearTimeout(longPressTimer);

  if (!mobileStartCell) return;

  const selectedCells = getSelectedDataCells();
  if (selectedCells.length) {
    // æ‹–æ›³å¤šé¸æˆ–å–®æ ¼é•·æŒ‰æ”¾æ‰‹å¾Œï¼Œéƒ½é¡¯ç¤ºå³éµ
    const lastCell = selectedCells[selectedCells.length - 1];
    showContextMenu(lastCell);
  }

  mobileSelecting = false;
  mobileStartCell = null;
  mobileHasMoved = false;
});





// ===== touchcancel =====
contentI.addEventListener("touchcancel", () => {
  clearTimeout(longPressTimer);
  mobileSelecting = false;
  mobileStartCell = null;
  mobileHasMoved = false;
});



// =============================================================================================================================== 



// ===== æŠŠã€Œå³éµé‚è¼¯ã€æŠ½æˆå…±ç”¨function=====
// =====æ–°å¢é€™å€‹function (æ¡Œæ©Ÿ/æ‰‹æ©Ÿå…±ç”¨)=====

function handleTableContextMenu(e, td) {
  e.preventDefault();

  activeTable = td.closest("table");
  activeMedia = null;

  const selected = getSelectedDataCells();

  // æ²’æœ‰ selection æ‰é¸å–é€™ä¸€æ ¼
  if (selected.length === 0) {
    clearCellSelection();
    td.classList.add("selected");
    anchorCell = td;
  }

  activeCell = getSelectedDataCells()[0] || td;

  const menu = document.getElementById("tableMenu");

  const x = e.touches ? e.touches[0].clientX : e.clientX;
  const y = e.touches ? e.touches[0].clientY : e.clientY;

  menu.style.left = x + "px";
  menu.style.top = y + "px";
  menu.style.display = "block";

  document.getElementById("mediaMenu").style.display = "none";
}

// ===== æ¡Œæ©Ÿçš„contextmenu æ”¹æˆã€Œå‘¼å«å…±å‡½å¼ã€=====
// =====æ›´æ–°ä½ çš„contextmenu (é‡é»)=====

contentI.addEventListener("contextmenu", e => {
  const td = e.target.closest("td.data-cell");
  const media = e.target.closest("img, video");

  if (td) {
    e.preventDefault();
    e.stopPropagation();
    handleTableContextMenu(e, td);
    return;
  }

  if (media) {
    e.preventDefault();
    activeMedia = media;
    activeCell = null;
    activeTable = null;

    const menu = document.getElementById("mediaMenu");
    menu.style.left = e.clientX + "px";
    menu.style.top = e.clientY + "px";
    menu.style.display = "block";

    document.getElementById("tableMenu").style.display = "none";
  }
});


//==========================================================================================







//  çŸ©å½¢é¸å–çš„æ ¸å¿ƒé‚è¼¯
function selectRect(cellA, cellB) {
  const table = cellA.closest("table");

  const r1 = cellA.parentElement.rowIndex;
  const c1 = cellA.cellIndex;
  const r2 = cellB.parentElement.rowIndex;
  const c2 = cellB.cellIndex;

  const rMin = Math.min(r1, r2);
  const rMax = Math.max(r1, r2);
  const cMin = Math.min(c1, c2);
  const cMax = Math.max(c1, c2);

  for (let r = rMin; r <= rMax; r++) {
    for (let c = cMin; c <= cMax; c++) {
      const cell = table.rows[r]?.cells[c];
      if (cell && cell.classList.contains("data-cell")) {
        cell.classList.add("selected");
      }
    }
  }
}



contentI.addEventListener("pointerdown", e => {
  // â­ æ‰‹æ©Ÿä¸èµ° pointer é¸å–
  if (e.pointerType === "touch") return;

  const td = e.target.closest("td.data-cell");
  if (!td) return;

  clearCellSelection();
  td.classList.add("selected");

  anchorCell = td;
  dragStartCell = td;
  isDragging = true;
});





contentI.addEventListener("pointermove", e => {
  if (!isDragging) return;

  const td = e.target.closest("td.data-cell");
  if (!td) return;

  clearCellSelection();
  selectRect(dragStartCell, td);
});


document.addEventListener("pointerup", () => {
  isDragging = false;
  dragStartCell = null;
});








// ===== æ¸…é™¤æ‰€æœ‰é¸å– =====
function clearCellSelection() {
  document
    .querySelectorAll(".note-table td.selected")
    .forEach(td => td.classList.remove("selected"));
}




//==========================================================================





function addRowResizers(table) {
  table.querySelectorAll("tr").forEach(tr => {
    if (tr.querySelector(".row-resizer")) return;

    const grip = document.createElement("div");
    grip.className = "row-resizer";
    tr.style.position = "relative";
    tr.appendChild(grip);

    grip.addEventListener("pointerdown", e => {
      e.preventDefault();
      const startY = e.clientY;
      const startH = tr.offsetHeight;

      const move = ev => {
        tr.style.height = startH + (ev.clientY - startY) + "px";
      };

      const up = () => {
        document.removeEventListener("pointermove", move);
        document.removeEventListener("pointerup", up);
        contentI.dispatchEvent(new Event("input"));
      };

      document.addEventListener("pointermove", move);
      document.addEventListener("pointerup", up);
    });
  });
}




function placeCaretInsideCell(td) {
  td.focus();

  if (td.innerHTML === "") {
    td.innerHTML = "\u200B";
  }

  const range = document.createRange();
  const sel = window.getSelection();
  range.selectNodeContents(td);
  range.collapse(true);
  sel.removeAllRanges();
  sel.addRange(range);
}



//   åƒ Excel ä¸€æ¨£ã€Œé¸å–å¤šå€‹å„²å­˜æ ¼å†åˆä½µ / åˆ†å‰²ã€ ===============================

let selectedCells = new Set();

// ===== æ»‘é¼ é¸å–ï¼ˆå„²å­˜æ ¼ / æ•´è¡¨ï¼‰=====
contentI.addEventListener("mousedown", e => {

  // â­ æ‰‹æ©Ÿä¸è™•ç† mouse æµç¨‹
  if ("ontouchstart" in window) return;
  // ---------- 1ï¸âƒ£ æ•´å¼µè¡¨æ ¼é¸å– ----------
  const table = e.target.closest(".note-table");
  if (table && !e.target.closest("td")) {
    e.preventDefault();

    clearCellSelection();
    activeCell = null;
    activeTable = table;

    const range = document.createRange();
    range.selectNode(table);

    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
    return;
  }

  // ---------- 2ï¸âƒ£ å„²å­˜æ ¼é¸å–ï¼ˆä½ åŸæœ¬çš„é‚è¼¯ï¼‰ ----------
  const td = e.target.closest("td");
  if (!td) return;

  // å³éµä¸è™•ç†ï¼ˆéå¸¸é‡è¦ï¼‰
  if (e.button === 2) return;

  if (!e.ctrlKey && !e.metaKey) {
    clearCellSelection();
  }

  toggleCellSelection(td);
  activeCell = td;
  activeTable = td.closest("table");
});




function toggleCellSelection(td) {
  if (selectedCells.has(td)) {
    selectedCells.delete(td);
    td.classList.remove("cell-selected");
  } else {
    selectedCells.add(td);
    td.classList.add("cell-selected");
  }
}



// å–å¾—ç›®å‰é¸å–çš„ã€Œè³‡æ–™æ ¼ã€
function getSelectedDataCells() {
  return Array.from(
    document.querySelectorAll(".note-table td.selected.data-cell")
  );
}

// æ¸…é™¤æ‰€æœ‰é¸å–
function clearCellSelection() {
  document
    .querySelectorAll(".note-table td.selected")
    .forEach(td => td.classList.remove("selected"));
}





// æ°´å¹³åˆä½µï¼ˆåŒä¸€åˆ—ï¼‰
function mergeSelectedCells() {
  buildCellMatrix();

  const selectedCells = getSelectedDataCells();
  if (!selectedCells || selectedCells.length < 2) {
    alert("è«‹é¸å–å¤šå€‹å„²å­˜æ ¼");
    return;
  }

  let minRow = Infinity, maxRow = -1;
  let minCol = Infinity, maxCol = -1;

  selectedCells.forEach(td => {
    const pos = findCellPosition(td);
    if (!pos) return;
    minRow = Math.min(minRow, pos.row);
    maxRow = Math.max(maxRow, pos.row);
    minCol = Math.min(minCol, pos.col);
    maxCol = Math.max(maxCol, pos.col);
  });

  const rowSpan = maxRow - minRow + 1;
  const colSpan = maxCol - minCol + 1;

  const topLeftCell = cellMatrix[minRow][minCol];
  topLeftCell.rowSpan = rowSpan;
  topLeftCell.colSpan = colSpan;

  // ğŸ”¥ ä¸ removeï¼Œåªéš±è—
  for (let r = minRow; r <= maxRow; r++) {
    for (let c = minCol; c <= maxCol; c++) {
      const td = cellMatrix[r][c];
      if (td !== topLeftCell) {
        td.style.display = "none";
        td.dataset.merged = "true";
      }
    }
  }

  clearCellSelection();
  topLeftCell.classList.add("selected");
  buildCellMatrix();
}




// å‚ç›´åˆä½µï¼ˆæœ€å°å¯ç”¨ç‰ˆæœ¬ï¼‰
function mergeSelectedCellsVertical() {
  if (selectedCells.size < 2) {
    alert("è«‹é¸å–å¤šå€‹å„²å­˜æ ¼");
    return;
  }

  const cells = Array.from(selectedCells);
  const colIndex = cells[0].cellIndex;

  // å¿…é ˆåŒä¸€æ¬„
  if (!cells.every(c => c.cellIndex === colIndex)) {
    alert("è«‹é¸å–åŒä¸€æ¬„ä½çš„å„²å­˜æ ¼");
    return;
  }

  // ä¾ rowIndex æ’åº
  cells.sort((a, b) => a.parentElement.rowIndex - b.parentElement.rowIndex);

  const first = cells[0];
  first.rowSpan = cells.length;

  cells.slice(1).forEach(c => c.remove());

  clearCellSelection();
}





// åˆ†å‰²ï¼ˆé‡å° activeCellï¼‰
function splitCell(cell) {
  const span = cell.colSpan || 1;
  if (span <= 1) return;

  cell.colSpan = 1;

  for (let i = 1; i < span; i++) {
    const td = document.createElement("td");
    td.contentEditable = "true";
    td.style.border = "1px solid #ccc";
    td.style.padding = "6px";
    cell.parentElement.insertBefore(td, cell.nextSibling);
  }
}


function deleteSelectedCells() {
  if (selectedCells.size === 0) return;

  selectedCells.forEach(td => td.remove());
  clearCellSelection();
}



// Enter / Tab è¡Œç‚ºï¼ˆåƒ Excelï¼‰
contentI.addEventListener("keydown", e => {

  /* ================= Undo / Redoï¼ˆæœ€é«˜å„ªå…ˆï¼‰ ================= */
  if (e.ctrlKey || e.metaKey) {
    const key = e.key.toLowerCase();

    // Ctrl + Zï¼ˆUndoï¼‰
    if (key === "z" && !e.shiftKey) {
      e.preventDefault();
      if (!undoStack.length) return;

      redoStack.push(contentI.innerHTML);
      contentI.innerHTML = undoStack.pop();
      placeCaretAtEnd(contentI);
      return;
    }

    // Ctrl + Shift + Z / Ctrl + Yï¼ˆRedoï¼‰
    if (key === "y" || (key === "z" && e.shiftKey)) {
      e.preventDefault();
      if (!redoStack.length) return;

      undoStack.push(contentI.innerHTML);
      contentI.innerHTML = redoStack.pop();
      placeCaretAtEnd(contentI);
      return;
    }
  }


function placeCaretAtEnd(el) {
  el.focus();
  const range = document.createRange();
  range.selectNodeContents(el);
  range.collapse(false);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
}


  /* ================= è¡¨æ ¼å¿«æ·ï¼ˆæ¬¡å„ªå…ˆï¼‰ ================= */
  if (!activeCell) return;

  // ---------- Tabï¼šåŒåˆ—å¾€å³ ----------
  if (e.key === "Tab") {
    e.preventDefault();

    const next = activeCell.nextElementSibling;
    if (next) {
      placeCaretInsideCell(next);
      activeCell = next;
    }
    return;
  }

  // ---------- Enterï¼šåŒæ¬„å¾€ä¸‹ ----------
  if (e.key === "Enter") {
    e.preventDefault();

    const row = activeCell.parentElement;
    const idx = activeCell.cellIndex;
    const nextRow = row.nextElementSibling;

    if (nextRow && nextRow.cells[idx]) {
      const target = nextRow.cells[idx];
      placeCaretInsideCell(target);
      activeCell = target;
    }
    return;
  }
});



// åœ¨ã€Œé»æ“Š tdã€æ™‚åŒæ­¥ activeCell
contentI.addEventListener("focusin", e => {
  // â­ æ‰‹æ©Ÿä¸åœ¨ focus æ™‚åšé¸å–
  if ("ontouchstart" in window) return;

  const td = e.target.closest("td.data-cell");
  if (!td) return;

  activeCell = td;
  activeTable = td.closest("table");
});


// =================================================================

//åŠ å…¥Undo / Redoï¼ˆCtrl + Zï¼‰ 
//åŠ å…¥å¯ä»¥ç”¨é¼ æ¨™è¡¨æ ¼æ•´é«”é¸å–/ è¤‡è£½ / 
//åŠ å…¥æ‹–æ›³æ¬„ç·šèª¿æ•´æ¬„å¯¬ / åˆ—é«˜

let undoStack = [];
let redoStack = [];
const MAX_HISTORY = 50;

function saveHistory() {
  const html = contentI.innerHTML;
  if (undoStack.length && undoStack[undoStack.length - 1] === html) return;

  undoStack.push(html);

  if (undoStack.length > MAX_HISTORY) {
    undoStack.shift();
  }
  redoStack.length = 0;
}


let historyTimer = null;

contentI.addEventListener("input", () => {
  // â­â­â­ é—œéµ 1ï¼šè¼¸å…¥ä¸­ç«‹åˆ»çµæŸä»»ä½•æ‹–æ›³ / é¸å–ç‹€æ…‹
  isDragging = false;
  dragStartCell = null;
  anchorCell = null;

  // â­â­â­ é—œéµ 2ï¼šä¸è¦åœ¨ input ç•¶ä¸‹æ¸… selectionï¼ˆé¿å…æ‰‹æ©Ÿ selection éœ‡ç›ªï¼‰
  // clearCellSelection(); âŒ çµ•å°ä¸è¦åœ¨é€™è£¡å‘¼å«

  // â­ åŸæœ¬çš„ debounce å„²å­˜é‚è¼¯
  clearTimeout(historyTimer);
  historyTimer = setTimeout(() => {
    saveHistory();
  }, 300);
});


function addColumnResizers(table) {
  table.querySelectorAll("td").forEach(td => {
    if (td.querySelector(".col-resizer")) return;

    const grip = document.createElement("div");
    grip.className = "col-resizer";
    td.appendChild(grip);

    grip.addEventListener("pointerdown", startResizeColumn);
  });
}

let resizingCol = null;
let startX = 0;
let startWidth = 0;

function startResizeColumn(e) {
  e.preventDefault();
  resizingCol = e.target.parentElement;
  startX = e.clientX;
  startWidth = resizingCol.offsetWidth;

  document.addEventListener("pointermove", resizeColumn);
  document.addEventListener("pointerup", stopResizeColumn);
}

function resizeColumn(e) {
  if (!resizingCol) return;
  const dx = e.clientX - startX;
  resizingCol.style.width = startWidth + dx + "px";
}

function stopResizeColumn() {
  document.removeEventListener("pointermove", resizeColumn);
  document.removeEventListener("pointerup", stopResizeColumn);
  resizingCol = null;

  contentI.dispatchEvent(new Event("input")); // ğŸ”¥ å­˜æ­·å²
}



// =================================================================



function insertImage(){
  document.getElementById("imgPicker").click();
}

imgPicker.onchange = e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    const img = document.createElement("img");
    img.src = reader.result;
    img.style.maxWidth = "100%";
    img.style.display = "block";
    img.style.margin = "5px 0";
    insertNodeAtCursor(img);
// ğŸ”¥ å¼·åˆ¶è§¸ç™¼è‡ªå‹•å„²å­˜
contentI.dispatchEvent(new Event("input"));
  };
  reader.readAsDataURL(file);
};

// 3. æ’å…¥å½±ç‰‡æ™‚åˆå§‹ç¸®å°é¡¯ç¤º
// 3. æ’å…¥å½±ç‰‡æ™‚åˆå§‹ç¸®å°é¡¯ç¤ºï¼ˆæ”¾å¤§ç‰ˆï¼‰
function insertVideo(){
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "video/*";
  input.click();

  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      const video = document.createElement("video");
      video.src = reader.result;
      video.controls = true;
      video.muted = true;

      // âœ… åˆå§‹å°ºå¯¸ï¼ˆå†æ”¾å¤§ä¸€é»ï¼‰
video.style.width = "160px";
video.style.height = "auto";
video.style.maxHeight = "160px";
video.style.objectFit = "cover";


      video.style.display = "block";
      video.style.margin = "10px 0";

      // âœ… é¿å…æ¸¸æ¨™è·‘é€²å½±ç‰‡
      video.setAttribute("contenteditable", "false");

      // âœ… æ’å…¥åœ¨æ¸¸æ¨™ä½ç½®
      insertNodeAtCursor(video);
// ğŸ”¥ å¼·åˆ¶è§¸ç™¼è‡ªå‹•å„²å­˜
contentI.dispatchEvent(new Event("input"));
    };
    reader.readAsDataURL(file);
  };
}





//  è‡ªå‹•å„²å­˜æ”¹æˆã€Œç”¨ currentId å­˜ã€
let autoSaveTimer = null;

function bindAutoSave(editorEl) {
  editorEl.oninput = () => {
    if (!currentId) return;

    clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(async () => {
      const notes = await all();
      const note = notes.find(n => n.id === currentId);
      if (!note || note.encrypted) return;

      note.content = editorEl.innerHTML;
      note.timestamp = Date.now();
      save(note);
      refresh();

      console.log("ğŸ“ è‡ªå‹•å„²å­˜", currentId);
    }, 600);
  };
}






// è¨­ç½®ç·¨è¼¯å€åŠŸèƒ½
function setupEditor() {
  initEditor(); // å•Ÿå‹•ç·¨è¼¯å€è‡ªå‹•å„²å­˜åŠŸèƒ½

  // æ’å…¥è¡¨æ ¼
  const insertTableButton = document.createElement('button');
  insertTableButton.innerText = 'æ’å…¥è¡¨æ ¼';
  insertTableButton.addEventListener('click', insertTable);
  document.body.appendChild(insertTableButton);


  // æ’å…¥å½±ç‰‡
  const insertVideoButton = document.createElement('button');
  insertVideoButton.innerText = 'æ’å…¥å½±ç‰‡';
  insertVideoButton.addEventListener('click', function() {
    const videoUrl = prompt('è«‹è¼¸å…¥å½±ç‰‡URLï¼š');
    insertVideo(videoUrl);
  });
  document.body.appendChild(insertVideoButton);
}

// åˆå§‹åŒ–ç·¨è¼¯å€
//setupEditor();


/* ========= å¾ç­†è¨˜å…§å®¹æŠ“ã€Œç¬¬ä¸€å€‹åª’é«”ã€ ========= */

function extractPreviewFromHTML(html){
  const div = document.createElement("div");
  div.innerHTML = html || "";

  const img = div.querySelector("img");
  if(img){
    return { type:"image", src: img.src };
  }

  const video = div.querySelector("video");
  if(video){
    return { type:"video", src: video.src };
  }

  const table = div.querySelector("table");
  if(table){
    return { type:"table" };
  }

  return null;
}





/* ========= åˆ—è¡¨åªä¾ã€Œæ–‡å­—æ®µè½ã€åˆ¤æ–·è¡Œæ•¸ ========= */
function extractTextLinesFromHTMLWithMedia(html){
  const div = document.createElement("div");
  div.innerHTML = html || "";

  const firstImage = div.querySelector("img");
  const firstVideo = div.querySelector("video");
  const firstTable = div.querySelector("table");

  let firstMedia = firstImage || firstVideo || firstTable || null;

  // ç§»é™¤ä¸è©²å½±éŸ¿è¡Œæ•¸çš„å…ƒç´ 
  div.querySelectorAll("img, video, table").forEach(el => el.remove());

  const lines = [];
  div.childNodes.forEach(node=>{
    let text = "";
    if(node.nodeType === Node.TEXT_NODE){
      text = node.textContent.trim();
    } else if(node.nodeType === Node.ELEMENT_NODE){
      text = node.innerText.trim();
    }
    if(text) lines.push(text);
  });

  return {
    lines,
    hasImage: !!firstImage,
    hasVideo: !!firstVideo,
    firstMedia
  };
}




/* ========= å·¥å…·å‡½å¼ ========= */
function insertHTMLAtCursor(html){
  const sel = window.getSelection();
  if(!sel.rangeCount) return;
  const range = sel.getRangeAt(0);
  range.deleteContents();
  const frag = document.createRange().createContextualFragment(html);
  range.insertNode(frag);
  range.collapse(false);
}

function insertNodeAtCursor(node) {
  const sel = window.getSelection();

  if (savedRange) {
    sel.removeAllRanges();
    sel.addRange(savedRange);
  }

  if (!sel.rangeCount) {
    contentI.appendChild(node);
    return;
  }

  const range = sel.getRangeAt(0);
  range.deleteContents();
  range.insertNode(node);

  // æ’å…¥å¾Œæ¸¸æ¨™ç§»åˆ°å…ƒç´ å¾Œé¢
  range.setStartAfter(node);
  range.collapse(true);
  sel.removeAllRanges();
  sel.addRange(range);

  // æ›´æ–° savedRange
  savedRange = range;
}


/* ========= å·¦å³æ»‘å®Œæ•´é‚è¼¯ ========= */
function addSwipeListeners(item, note){
  let sx = null, dx = 0;
  const main = item.querySelector(".note-main");
  const deleteBtn = item.querySelector(".swipe-bg.delete");
  const pinBtn = item.querySelector(".swipe-bg.pin");

  // ç¦æ­¢æ»‘å‹•é»æ“Šå†’æ³¡
  function stopClick(e){ e.stopPropagation(); }

  item.addEventListener("pointerdown", e => {
    sx = e.clientX;
    item.setPointerCapture(e.pointerId);
    main.style.transition = "none";
  });

  item.addEventListener("pointermove", e => {
    if(sx === null) return;
    dx = e.clientX - sx;

    // é˜»æ­¢å·¦å³èª¤è§¸é»æ“Šæ‰“é–‹ç·¨è¼¯å™¨
    if(Math.abs(dx) > 5) main.dataset.dragging = true;

    // å·¦å³æ»‘å‹•
    if(dx < 0){ // å·¦æ»‘ â†’ é¡¯ç¤ºåˆªé™¤
      main.style.transform = `translateX(${Math.max(dx, -120)}px)`;
    } else { // å³æ»‘ â†’ é¡¯ç¤ºé‡˜é¸
      main.style.transform = `translateX(${Math.min(dx, 120)}px)`;
    }
  });

  item.addEventListener("pointerup", e => {
    item.releasePointerCapture(e.pointerId);
    main.style.transition = "transform .25s ease";

    if(dx < -60){ // å·¦æ»‘è¶…éé–¾å€¼ â†’ å®šä½
      main.style.transform = "translateX(-120px)";
    } else if(dx > 60){ // å³æ»‘è¶…éé–¾å€¼ â†’ å®šä½
      main.style.transform = "translateX(120px)";
    } else { // å›å½ˆ
      main.style.transform = "translateX(0)";
    }

    // é‡ç½®æ‹–æ›³æ¨™è¨˜
    setTimeout(()=>{ delete main.dataset.dragging; }, 50);

    sx = null; dx = 0;
  });

  // é»æ“Šåˆªé™¤æŒ‰éˆ•
  deleteBtn.addEventListener("click", e => {
    e.stopPropagation();
    tx("readwrite").delete(note.id);
    refresh();
  });

  // é»æ“Šé‡˜é¸æŒ‰éˆ•
  pinBtn.addEventListener("click", e => {
    e.stopPropagation();
    note.pinned = !note.pinned;
    save(note);
    refresh();
  });

  // é»æ“Šä¸»å…§å®¹æ‰é–‹ç·¨è¼¯å™¨
  main.addEventListener("click", e => {
    if(main.dataset.dragging) return; // æ‹–æ›³ä¸æ‰“é–‹
    openEditor(note);
  });
}



/* ========= Editor Swipe Back (Safe Version) ========= */
(()=>{
  let sx=null, dx=0;
  const hint=document.getElementById("editorSwipeHint");
  const TH=120;
  const EDGE=20; // ğŸ”¥ åªæœ‰å·¦é‚Š 20px æ‰å•Ÿå‹•è¿”å›

  editor.addEventListener("pointerdown",e=>{
    // âŒ é»åœ¨æŒ‰éˆ• / input / textarea ä¸è™•ç†
    if(e.target.closest("button,input,textarea")) return;

    // âŒ ä¸æ˜¯å¾å·¦é‚Šç·£é–‹å§‹ï¼Œä¸è™•ç†
    if(e.clientX > EDGE) return;

    sx=e.clientX;
    dx=0;
    editor.setPointerCapture(e.pointerId);
  });

  editor.addEventListener("pointermove",e=>{
    if(sx===null) return;
    dx=e.clientX-sx;

    if(dx>30){
      hint.style.display="flex";
      e.preventDefault();
    }
  });

  editor.addEventListener("pointerup",e=>{
    if(sx!==null){
      editor.releasePointerCapture(e.pointerId);
    }

    hint.style.display="none";

    if(dx>TH){
      closeEditor();
    }

    sx=null;
    dx=0;
  });

})();

function closeEditor(){
  // ğŸ”¹ éš±è—ç·¨è¼¯å™¨
  editor.style.display = "none";

  // ğŸ”¹ é¡¯ç¤ºåˆ—è¡¨ã€FABã€æœå°‹æ¡†
  document.getElementById("noteList").style.display = "";
  document.getElementById("fab").style.display = "";
  document.getElementById("searchBox").style.display = "";

  // ğŸ”¹ æ¸…ç©ºç·¨è¼¯å™¨å…§å®¹èˆ‡é¸å–ç¯„åœï¼ˆé¿å…ä¸Šä¸€æ¬¡é¸å–å½±éŸ¿ï¼‰
  // æ³¨æ„ï¼šä¸æ¸… contentI.valueï¼Œä¿ç•™åŸç­†è¨˜å…§å®¹
  window.getSelection().removeAllRanges();

  // ğŸ”¹ æ¸…ç©º contenteditable çš„è‡¨æ™‚æ’å…¥å…ƒç´ ï¼ˆåœ–ç‰‡ / å½±ç‰‡ï¼‰
  // å¦‚æœä½ ä½¿ç”¨ contenteditable divï¼Œå»ºè­°ä¸è¦ä¿ç•™ä¹‹å‰æ’å…¥çš„å…ƒç´ 
  const contentDiv = document.getElementById("content");
  if(contentDiv){
    // ä¿å­˜å…§å®¹åˆ°ç­†è¨˜å‰ï¼Œä¸æ¸…æ‰ï¼›åªæ˜¯åˆ‡æ›ç­†è¨˜æ™‚æ¸…æ‰
    contentDiv.innerHTML = "";
  }

  // ğŸ”¹ é‡ç½® global currentIdï¼Œé¿å…å½±éŸ¿ä¸‹ä¸€ç­†ç·¨è¼¯
  currentId = null;
}

/* ========= æ™‚é–“é¡¯ç¤ºå·¥å…·å‡½å¼ ========= */
function formatListTime(ts){
  const d = new Date(ts);
  const now = new Date();

  const sameDay = (a,b)=>
    a.getFullYear()===b.getFullYear() &&
    a.getMonth()===b.getMonth() &&
    a.getDate()===b.getDate();

  if(sameDay(d, now)){
    return d.toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit"});
  }

  const y = new Date(now);
  y.setDate(now.getDate()-1);
  if(sameDay(d, y)){
    return d.toLocaleDateString("zh-TW");
  }

  const diff = Math.floor((now - d) / 86400000);
  if(diff < 7){
    return ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][d.getDay()];
  }

  return d.getFullYear()+"å¹´";
}



document.getElementById("mediaMenu").onclick = e => {
  if (!activeMedia) return;

  const act = e.target.dataset.act;
  const cur = activeMedia.offsetWidth;

  if (act === "zoomIn") {
    activeMedia.style.width = cur + 20 + "px";
  }

  if (act === "zoomOut") {
    activeMedia.style.width = Math.max(60, cur - 20) + "px";
  }

  if (act === "delete") {
    activeMedia.remove();
  }

  contentI.dispatchEvent(new Event("input"));
};


/* ========= Search ========= */

let isSearching = false;

let searchTimer = null;
const SEARCH_DELAY = 250; // msï¼Œå¯è‡ªè¡Œèª¿æ•´


searchInput.addEventListener("input", () => {
  clearTimeout(searchTimer);

  isSearching = searchInput.value.trim() !== "";

  searchTimer = setTimeout(() => {
    refresh();
  }, SEARCH_DELAY);
});


const fab = document.getElementById("fab");
let fabLock = false;

if (fab) {
  fab.addEventListener("pointerup", e => {
    // â­ åªè™•ç†æ‰‹æŒ‡ / æ»‘é¼ æ”¾é–‹
    e.stopPropagation();
    e.preventDefault();

    // â­ é˜²æ­¢ inline onclick + pointerup é€£çºŒè§¸ç™¼
    if (fabLock) return;
    fabLock = true;

    newNote();

    setTimeout(() => {
      fabLock = false;
    }, 300);
  });
}



// ğŸ”¹ æœ€å¾Œå•Ÿå‹• DB ä¸¦åˆ·æ–°åˆ—è¡¨
openDB().then(refresh);

</script>

</body>
</html>
