<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>備忘錄</title>
<script src="./jszip.min.js"></script>
<script src="./crypto-js.min.js"></script>
</head>
<body>

<header>
  <span>備忘錄</span>
  <div>
    <button id="exportBtn">加密匯出</button>
    <button id="importBtn">匯入</button>
    <button id="undoBtn" style="display:none" onclick="undoDeleteAll()">復原</button>
    <button onclick="deleteAllNotes()">刪除所有備忘錄</button>
  </div>
</header>

<div id="noteList"></div>
<div id="fab" onclick="newNote()">＋</div>

<div id="editor">
  <div>
    <button onclick="closeEditor()">返回</button>
    <button onclick="saveEditor()">存檔</button>
  </div>
  <div id="content" contenteditable="true"></div>
</div>

<input type="file" id="backupFile" accept=".zip,.json" style="display:none">

<script>
/* ================= IndexedDB ================= */
const DB_NAME = "memoDB";
const STORE = "notes";
let db = null;

async function openDB() {
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME,1);
    req.onupgradeneeded = e => e.target.result.createObjectStore(STORE,{ keyPath:"id" });
    req.onsuccess = e => { db=e.target.result; resolve(); };
    req.onerror = reject;
  });
}

function save(note){ db.transaction(STORE,"readwrite").objectStore(STORE).put(note); }
function getAll(){ return new Promise(res=>{ const r=db.transaction(STORE).objectStore(STORE).getAll(); r.onsuccess=()=>res(r.result||[]); }); }
function removeAll(){ return new Promise((resolve,reject)=>{ const tx=db.transaction(STORE,"readwrite"); tx.objectStore(STORE).clear(); tx.oncomplete=()=>resolve(); tx.onerror=()=>reject(tx.error); }); }

/* ================= build zip ================= */
async function buildZipBlob(){
  const zip = new JSZip();
  const notes = await getAll();
  let html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>備忘錄</title></head><body>';
  notes.forEach(n => html += `<h2>${n.title||"（無標題）"}</h2><div>${n.content||""}</div><hr>`);
  html += '</body></html>';
  zip.file("index.html", html);
  return zip.generateAsync({type:"blob"});
}

/* ================= CryptoJS 安全跨平台加密/解密 ================= */
function arrayBufferToBase64(buffer) {
  let binary = '';
  const bytes = new Uint8Array(buffer);
  const len = bytes.byteLength;
  for (let i = 0; i < len; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}

function base64ToArrayBuffer(base64) {
  const binary = atob(base64);
  const len = binary.length;
  const buffer = new Uint8Array(len);
  for (let i = 0; i < len; i++) buffer[i] = binary.charCodeAt(i);
  return buffer.buffer;
}

async function encryptBlob(blob, password) {
  const arrayBuffer = await blob.arrayBuffer();
  const base64 = arrayBufferToBase64(arrayBuffer);
  const encrypted = CryptoJS.AES.encrypt(base64, password).toString();
  return new Blob([encrypted], { type: "application/octet-stream" });
}

async function decryptBlob(blob, password) {
  const encryptedText = await blob.text();
  const decrypted = CryptoJS.AES.decrypt(encryptedText, password);
  const base64 = decrypted.toString(CryptoJS.enc.Utf8);
  if (!base64) throw new Error("解密失敗");
  const arrayBuffer = base64ToArrayBuffer(base64);
  return new Blob([arrayBuffer], { type: "application/zip" });
}


/* ================= exportSecure ================= */
async function exportSecure(){
  const password = prompt("請輸入加密密碼");
  if(!password) return;
  try{
    const zipBlob = await buildZipBlob();
    const encryptedBlob = await encryptBlob(zipBlob,password);
    const file = new File([encryptedBlob],"notes.secure.zip",{type:"application/octet-stream"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(file);
    a.download=file.name;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  }catch(err){ console.error(err); alert("匯出失敗"); }
}

/* ================= importSecure ================= */
async function importSecure(file){
  const password = prompt("請輸入加密密碼");
  if(!password) return;
  try{
    const zipBlob = await decryptBlob(file,password);
    const zip = await JSZip.loadAsync(zipBlob);
    const html = await zip.file("index.html").async("text");
    const div = document.createElement("div");
    div.innerHTML = html;
    [...div.querySelectorAll("h2")].forEach((h,i)=>{
      save({id:Date.now()+"_"+i,title:h.textContent,content:h.nextElementSibling?.innerHTML||"",timestamp:Date.now()});
    });
    alert("匯入完成");
    refresh();
  }catch(err){ console.error(err); alert("解密失敗：密碼錯誤或檔案已損毀"); }
}

/* ================= refresh ================= */
async function refresh(){
  const list=document.getElementById("noteList");
  list.innerHTML="";
  const notes = await getAll();
  notes.sort((a,b)=>b.timestamp-a.timestamp).forEach(note=>{
    const div=document.createElement("div");
    div.className="note-item";
    div.innerHTML=`<div><div>${note.title||"（無標題）"}</div><div>${new Date(note.timestamp).toLocaleString()}</div></div><button class="delete-btn">刪除</button>`;
    div.onclick=()=>openEditor(note.id);
    div.querySelector(".delete-btn").onclick=e=>{ e.stopPropagation(); removeAll(); refresh(); };
    list.appendChild(div);
  });
}

/* ================= 新增/編輯 ================= */
let currentId=null;
function newNote(){ currentId=null; content.innerHTML=""; openEditor(null); }
async function openEditor(id){
  currentId=id;
  const notes = await getAll();
  const note = notes.find(n=>n.id===id);
  document.getElementById("content").innerHTML=note?.content||"";
  document.getElementById("editor").style.display="flex";
  document.getElementById("noteList").style.display="none";
  document.getElementById("fab").style.display="none";
}
function closeEditor(){ editor.style.display="none"; noteList.style.display=""; fab.style.display=""; refresh(); }
function saveEditor(){ save({id:currentId||Date.now().toString(),title:content.innerText.slice(0,20),content:content.innerHTML,timestamp:Date.now()}); closeEditor(); }

/* ================= 刪除全部 + Undo ================= */
let lastDeletedNotes=null;
let undoTimer=null;
async function deleteAllNotes(){
  if(!confirm("確定刪除所有備忘錄？")) return;
  lastDeletedNotes = await getAll();
  await removeAll();
  refresh();
  const undoBtn = document.getElementById("undoBtn");
  undoBtn.style.display="inline-block";
  clearTimeout(undoTimer);
  undoTimer = setTimeout(()=>{ lastDeletedNotes=null; undoBtn.style.display="none"; },10000);
  alert("已刪除，可於 10 秒內復原");
}
async function undoDeleteAll(){ if(!lastDeletedNotes) return; for(const note of lastDeletedNotes) save(note); lastDeletedNotes=null; undoBtn.style.display="none"; refresh(); alert("已復原"); }

/* ================= 啟動 ================= */
window.addEventListener("load", async ()=>{
  await openDB();
  refresh();
  document.getElementById("exportBtn").addEventListener("click", exportSecure);
  const importBtn=document.getElementById("importBtn");
  const backupFile=document.getElementById("backupFile");
  importBtn.addEventListener("click", ()=>{ backupFile.value=""; backupFile.click(); });
  backupFile.addEventListener("change", ()=>{ if(backupFile.files.length) importSecure(backupFile.files[0]); });
});
</script>

</body>
</html>
