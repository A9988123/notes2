<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>備忘錄</title>

<style>
body{
  margin:0;
  font-family:-apple-system,system-ui;
  background:#f5f5f5;
}
header{
  padding:14px;
  font-size:22px;
  font-weight:600;
  display:flex;
  justify-content:space-between;
}
#noteList{
  padding:10px;
}
.note-item{
  background:#fff;
  border-radius:10px;
  padding:12px;
  margin-bottom:10px;
}
.note-title{
  font-size:16px;
  font-weight:500;
}
.note-sub{
  font-size:12px;
  color:#888;
}
#fab{
  position:fixed;
  right:18px;
  bottom:18px;
  width:56px;
  height:56px;
  border-radius:50%;
  background:#4a90e2;
  color:#fff;
  font-size:32px;
  display:flex;
  align-items:center;
  justify-content:center;
}
#editor{
  position:fixed;
  inset:0;
  background:#f5f5f5;
  display:none;
  flex-direction:column;
}
#editorHeader{
  background:#4a90e2;
  color:#fff;
  padding:10px;
  display:flex;
  justify-content:space-between;
}
#content{
  flex:1;
  padding:12px;
  background:#fff;
  margin:10px;
  border-radius:10px;
  border:1px solid #ccc;
  overflow:auto;
}
#topBar button{
  margin-left:6px;
}
</style>
</head>

<body>

<header id="topBar">
  <span>備忘錄</span>
  <div>
    <button onclick="exportSecure()">加密匯出</button>
    <button onclick="backupFile.click()">匯入</button>
  </div>
</header>

<div id="noteList"></div>
<div id="fab" onclick="newNote()">＋</div>

<!-- Editor -->
<div id="editor">
  <div id="editorHeader">
    <button onclick="closeEditor()">返回</button>
    <button onclick="saveEditor()">存檔</button>
  </div>
  <div id="content" contenteditable="true"></div>
</div>

<input type="file" id="backupFile" accept=".json" hidden />

<script src="./jszip.min.js"></script>
<script src="./crypto-js.min.js"></script>

<script>
/* ================= IndexedDB ================= */
const DB_NAME = "memoDB";
const STORE = "notes";
let db = null;
let currentId = null;

function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME,1);
    req.onupgradeneeded = e=>{
      const _db = e.target.result;
      if(!_db.objectStoreNames.contains(STORE)){
        _db.createObjectStore(STORE,{ keyPath:"id" });
      }
    };
    req.onsuccess = e=>{
      db = e.target.result;
      resolve();
    };
    req.onerror = e=>reject(e);
  });
}

function save(note){
  const tx = db.transaction(STORE,"readwrite");
  tx.objectStore(STORE).put(note);
}

function getAll(){
  return new Promise(resolve=>{
    const tx = db.transaction(STORE,"readonly");
    const req = tx.objectStore(STORE).getAll();
    req.onsuccess = ()=>resolve(req.result||[]);
  });
}

function remove(id){
  const tx = db.transaction(STORE,"readwrite");
  tx.objectStore(STORE).delete(id);
}

/* ================= List ================= */
async function refresh(){
  const list = document.getElementById("noteList");
  list.innerHTML = "";
  const notes = await getAll();
  notes
    .sort((a,b)=>b.timestamp-a.timestamp)
    .forEach(n=>{
      const div = document.createElement("div");
      div.className = "note-item";
      div.innerHTML = `
        <div class="note-title">${n.title||"（無標題）"}</div>
        <div class="note-sub">${new Date(n.timestamp).toLocaleString()}</div>
      `;
      div.onclick = ()=>openEditor(n.id);
      list.appendChild(div);
    });
}

/* ================= Editor ================= */
async function openEditor(id){
  currentId = id;
  const notes = await getAll();
  const note = notes.find(n=>n.id===id);
  content.innerHTML = note?.content || "";
  editor.style.display = "flex";
  noteList.style.display = "none";
  fab.style.display = "none";
}

function closeEditor(){
  editor.style.display = "none";
  noteList.style.display = "";
  fab.style.display = "";
  currentId = null;
  refresh();
}

function saveEditor(){
  const text = content.innerText.trim();
  save({
    id: currentId || Date.now().toString(),
    title: text.slice(0,20),
    content: content.innerHTML,
    encrypted:false,
    timestamp: Date.now()
  });
  closeEditor();
}

function newNote(){
  currentId = null;
  content.innerHTML = "";
  openEditor(null);
}

/* ================= Import ================= */
backupFile.onchange = e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = async ()=>{
    const data = JSON.parse(reader.result);
    if(!Array.isArray(data)){
      alert("格式錯誤");
      return;
    }
    data.forEach(n=>{
      save({
        ...n,
        id: Date.now().toString()+Math.random().toString(36).slice(2)
      });
    });
    refresh();
    alert("匯入完成");
  };
  reader.readAsText(file);
}

/* ================= Utilities ================= */
function downloadBlob(blob, filename){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function canUseWebCrypto(){
  return (
    location.protocol === "https:" ||
    location.hostname === "localhost"
  ) && !!window.crypto?.subtle;
}

/* ================= Build ZIP ================= */
async function buildZipBlob(){
  const zip = new JSZip();
  const notes = await getAll();

  let html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>備忘錄</title></head><body>`;

  for (const n of notes){
    const div = document.createElement("div");
    div.innerHTML = n.content;

    for (const media of div.querySelectorAll("img,video")){
      if (!media.src.startsWith("data:")) continue;
      const res = await fetch(media.src);
      const blob = await res.blob();
      const ext = blob.type.split("/")[1];
      const name = `media/${crypto.randomUUID()}.${ext}`;
      zip.file(name, blob);
      media.src = name;
    }

    html += `<h2>${n.title}</h2>${div.innerHTML}<hr>`;
  }

  html += "</body></html>";
  zip.file("index.html", html);
  return zip.generateAsync({ type:"blob" });
}

/* ================= 加密 ================= */
async function encryptBlobWebCrypto(blob,password){
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const keyMaterial = await crypto.subtle.importKey(
    "raw",
    new TextEncoder().encode(password),
    "PBKDF2",
    false,
    ["deriveKey"]
  );
  const key = await crypto.subtle.deriveKey(
    { name:"PBKDF2", salt, iterations:100000, hash:"SHA-256" },
    keyMaterial,
    { name:"AES-GCM", length:256 },
    false,
    ["encrypt"]
  );
  const encrypted = await crypto.subtle.encrypt(
    { name:"AES-GCM", iv },
    key,
    await blob.arrayBuffer()
  );
  return new Blob([salt,iv,new Uint8Array(encrypted)],{ type:"application/octet-stream" });
}

async function encryptBlobFallback(blob,password){
  const buf = await blob.arrayBuffer();
  const wordArray = CryptoJS.lib.WordArray.create(buf);
  const encrypted = CryptoJS.AES.encrypt(wordArray,password).toString();
  return new Blob([encrypted],{ type:"application/octet-stream" });
}

async function encryptBlob(blob,password){
  if(canUseWebCrypto()){
    return encryptBlobWebCrypto(blob,password);
  } else {
    return encryptBlobFallback(blob,password);
  }
}

/* ================= Export Secure ================= */
async function exportSecure(){
  try {
    const password = prompt("請輸入加密密碼");
    if(!password) return;

    const zipBlob = await buildZipBlob();
    const encryptedBlob = await encryptBlob(zipBlob,password);
    const file = new File([encryptedBlob],"notes.secure",{ type:"application/octet-stream" });

    // iOS PWA / LocalSend 自動分享
    if (navigator.canShare && navigator.canShare({ files: [file] }) && !isFileProtocol) {
      await navigator.share({ files: [file], title: "備忘錄匯出" });
    } else if (location.protocol !== "file:") {
      // 直接打開 LocalSend 分享頁面
      const fileURL = URL.createObjectURL(file);
      const sendURL = `https://localsend.example.com/send?file=${encodeURIComponent(fileURL)}`;
      window.location.href = sendURL; // 使用 window.location.href 來直接觸發下載或分享
    } else {
      downloadBlob(file, file.name);
      alert("file:// 模式已下載備份，請透過瀏覽器或 PWA 使用 LocalSend 分享");
    }

  } catch (e) {
    console.error(e);
    alert("❌ 匯出失敗，請查看 Console");
  }
}

/* ================= Init ================= */
const isFileProtocol = location.protocol==="file:";
if(isFileProtocol){
  console.warn("目前為 file://，已自動停用 Service Worker / 分享限制");
}

window.addEventListener("load", async () => {
  await openDB();
  refresh();
});
</script>

</body>
</html>
