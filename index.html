<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>å‚™å¿˜éŒ„</title>
  <style>
    body { margin:0; font-family:-apple-system,system-ui; background:#f5f5f5; }
    header { padding:14px; font-size:22px; font-weight:600; display:flex; justify-content:space-between; }
    #noteList { padding:10px; }
    .note-item { background:#fff; border-radius:10px; padding:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }
    .note-title { font-size:16px; font-weight:500; }
    .note-sub { font-size:12px; color:#888; }
    .delete-btn { background:#ff4d4d; color:#fff; padding:6px 12px; border:none; border-radius:5px; cursor:pointer; font-size:12px; }
    #fab { position:fixed; right:18px; bottom:18px; width:56px; height:56px; border-radius:50%; background:#4a90e2; color:#fff; font-size:32px; display:flex; align-items:center; justify-content:center; }
    #editor { position:fixed; inset:0; background:#f5f5f5; display:none; flex-direction:column; }
    #editorHeader { background:#4a90e2; color:#fff; padding:10px; display:flex; justify-content:space-between; }
    #content { flex:1; padding:12px; background:#fff; margin:10px; border-radius:10px; border:1px solid #ccc; overflow:auto; }
    #topBar button { margin-left:6px; }
  </style>
</head>
<body>

<header id="topBar">
  <span>å‚™å¿˜éŒ„</span>
  <div>
    <button id="exportBtn">åŠ å¯†åŒ¯å‡º</button>
    <button id="importBtn">åŒ¯å…¥</button>
    <button id="undoBtn" style="display:none" onclick="undoDeleteAll()">å¾©åŸ</button>
    <button onclick="deleteAllNotes()">åˆªé™¤æ‰€æœ‰å‚™å¿˜éŒ„</button>
  </div>
</header>

<div id="noteList"></div>
<div id="fab" onclick="newNote()">ï¼‹</div>

<div id="editor">
  <div id="editorHeader">
    <button onclick="closeEditor()">è¿”å›</button>
    <button onclick="saveEditor()">å­˜æª”</button>
  </div>
  <div id="content" contenteditable="true"></div>
</div>

<input type="file" id="backupFile" style="display:none" />


<script src="./jszip.min.js"></script>
<script src="./crypto-js.min.js"></script>

<script>
/* ================= IndexedDB ================= */
const DB_NAME = "memoDB";
const STORE = "notes";
let db = null;

function openDB() {
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME,1);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if(!d.objectStoreNames.contains(STORE)) d.createObjectStore(STORE,{ keyPath:"id" });
    };
    req.onsuccess = e => { db = e.target.result; resolve(); };
    req.onerror = reject;
  });
}

function save(note){ db.transaction(STORE,"readwrite").objectStore(STORE).put(note); }
function getAll(){ return new Promise(res=>{ const r = db.transaction(STORE).objectStore(STORE).getAll(); r.onsuccess=()=>res(r.result||[]); }); }
function removeAll(){ return new Promise((resolve,reject)=>{ const tx=db.transaction(STORE,"readwrite"); tx.objectStore(STORE).clear(); tx.oncomplete=()=>resolve(); tx.onerror=()=>reject(tx.error); }); }
function remove(id){ const tx=db.transaction(STORE,"readwrite"); tx.objectStore(STORE).delete(id); }

/* ================= build zip ================= */
async function buildZipBlob(){
  const zip = new JSZip();
  const notes = await getAll();
  let html=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>å‚™å¿˜éŒ„</title></head><body>`;
  for(const n of notes){
    html+=`<h2>${n.title||"ï¼ˆç„¡æ¨™é¡Œï¼‰"}</h2><div>${n.content||""}</div><hr>`;
  }
  html+="</body></html>";
  zip.file("index.html",html);
  return zip.generateAsync({type:"blob"});
}

/* ================= CryptoJS åŠ å¯†/è§£å¯† ================= */
async function encryptBlob(blob,password){
  const arrayBuffer = await blob.arrayBuffer();
  const wordArray = CryptoJS.lib.WordArray.create(arrayBuffer);
  const encrypted = CryptoJS.AES.encrypt(wordArray,password).toString();
  return new Blob([encrypted],{type:"application/octet-stream"});
}

async function decryptBlobCryptoJS(data, password) {
  try {
    const text = new TextDecoder().decode(data);
    const decrypted = CryptoJS.AES.decrypt(text, password);

    if (!decrypted.sigBytes || decrypted.sigBytes <= 0) throw new Error("CryptoJS decrypt failed");

    const words = decrypted.words;
    const bytes = new Uint8Array(decrypted.sigBytes);
    let offset = 0;

    for (let i = 0; i < words.length && offset < bytes.length; i++) {
      const w = words[i];
      for (let b = 3; b >= 0 && offset < bytes.length; b--) {
        bytes[offset++] = (w >> (8 * b)) & 0xff;
      }
    }

    return new Blob([bytes], { type: "application/zip" });
  } catch (err) {
    console.error("è§£å¯†éç¨‹éŒ¯èª¤:", err);
    alert("âŒ è§£å¯†éç¨‹ä¸­å‡ºç¾éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥å¯†ç¢¼æˆ–æª”æ¡ˆæ ¼å¼ï¼");
    throw err;
  }
}

/* ================= exportSecure ================= */
async function exportSecure() {
  const password = prompt("è«‹è¼¸å…¥åŠ å¯†å¯†ç¢¼");
  if (!password) return;

  try {
    // å–å¾—æ‰€æœ‰å‚™å¿˜éŒ„
    const notes = await getAll();
    
    // å°‡å‚™å¿˜éŒ„è½‰æ›ç‚º JSON æ ¼å¼
    const notesData = JSON.stringify(notes);
    
    // åŠ å¯†å‚™å¿˜éŒ„è³‡æ–™
    const encryptedData = CryptoJS.AES.encrypt(notesData, password).toString();

    // å‰µå»ºåŠ å¯†çš„ JSON æª”æ¡ˆ
    const encryptedFile = new Blob([encryptedData], { type: "application/json" });
    
    // ä¸‹è¼‰åŠ å¯†æª”æ¡ˆ
    const file = new File([encryptedFile], "notes.secure.json", { type: "application/json" });

    // æª¢æŸ¥æ˜¯å¦æ”¯æ´åˆ†äº«åŠŸèƒ½
    if (navigator.canShare && navigator.canShare({ files: [file] }) && location.protocol !== "file:") {
      await navigator.share({ files: [file], title: "å‚™å¿˜éŒ„åŒ¯å‡º" });
    } else {
      downloadBlob(file, file.name); // ä¸‹è¼‰æª”æ¡ˆ
    }
  } catch (err) {
    console.error("åŒ¯å‡ºéŒ¯èª¤:", err);
    alert("âŒ åŒ¯å‡ºå¤±æ•—");
  }
}

function downloadBlob(blob, filename) {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(a.href);
  a.remove();
}


/* ================= importSecure ================= */
/* ================= importSecure ================= */
async function importSecure(file) {
  const password = prompt("è«‹è¼¸å…¥åŠ å¯†å¯†ç¢¼");
  if (!password) return;

  try {
    // è®€å–åŠ å¯†æª”æ¡ˆ
    const fileData = await file.arrayBuffer();
    const encryptedData = new TextDecoder().decode(fileData);
    
    // è§£å¯†è³‡æ–™
    const decryptedData = CryptoJS.AES.decrypt(encryptedData, password).toString(CryptoJS.enc.Utf8);

    // å¦‚æœè§£å¯†å¤±æ•—
    if (!decryptedData) {
      alert("âŒ è§£å¯†å¤±æ•—ï¼šå¯†ç¢¼éŒ¯èª¤æˆ–æª”æ¡ˆå·²ææ¯€");
      return;
    }

    // è§£æè§£å¯†å¾Œçš„ JSON è³‡æ–™
    const notes = JSON.parse(decryptedData);
    
    // ä¿å­˜è§£å¯†å¾Œçš„è³‡æ–™
    notes.forEach(note => {
      save({
        id: note.id || Date.now().toString(),
        title: note.title || "ï¼ˆç„¡æ¨™é¡Œï¼‰",
        content: note.content || "",
        timestamp: note.timestamp || Date.now()
      });
    });

    alert("âœ… åŒ¯å…¥å®Œæˆ");
    refresh(); // åˆ·æ–°å‚™å¿˜éŒ„åˆ—è¡¨
  } catch (err) {
    console.error("è§£å¯†éç¨‹éŒ¯èª¤:", err);
    alert("âŒ è§£å¯†å¤±æ•—ï¼šå¯†ç¢¼éŒ¯èª¤æˆ–æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º");
  }
}


async function refresh(){
  const list = document.getElementById("noteList");
  list.innerHTML = "";
  const notes = await getAll();

  const isMobile = window.innerWidth <= 768;

  notes.sort((a, b) => b.timestamp - a.timestamp).forEach(note => {
    const div = document.createElement("div");
    div.className = "note-item";

    const contentDisplay = isMobile ? decryptContent(note.content) : encryptContent(note.content);

    div.innerHTML = `
      <div>
        <div class="note-title">${note.title || "ï¼ˆç„¡æ¨™é¡Œï¼‰"}</div>
        <div class="note-sub">${new Date(note.timestamp).toLocaleString()}</div>
        <div class="note-content">${contentDisplay}</div>
      </div>
      <button class="delete-btn">åˆªé™¤</button>
    `;

    div.onclick = () => openEditor(note.id);

    div.querySelector(".delete-btn").onclick = e => {
      e.stopPropagation();
      if (confirm("ç¢ºå®šåˆªé™¤æ­¤å‚™å¿˜éŒ„ï¼Ÿ")) {
        remove(note.id);
        refresh();
      }
    };

    list.appendChild(div);
  });
}

function encryptContent(content) {
  const encrypted = CryptoJS.AES.encrypt(content, 'yourPassword').toString();
  return `<span class="encrypted-content">${encrypted}</span>`;
}

function decryptContent(encryptedContent) {
  const bytes = CryptoJS.AES.decrypt(encryptedContent, 'yourPassword');
  const decrypted = bytes.toString(CryptoJS.enc.Utf8);
  return `<span class="decrypted-content">${decrypted}</span>`;
}

/* ================= æ–°å¢ã€ç·¨è¼¯ ================= */
let currentId=null;
async function newNote(){ currentId=null; content.innerHTML=""; openEditor(null); }
async function openEditor(id){
  currentId=id;
  const notes = await getAll();
  const note = notes.find(n=>n.id===id);
  document.getElementById("content").innerHTML=note?.content||"";
  document.getElementById("editor").style.display="flex";
  document.getElementById("noteList").style.display="none";
  document.getElementById("fab").style.display="none";
}
function closeEditor(){
  editor.style.display="none";
  noteList.style.display="";
  fab.style.display="";
  currentId=null;
  refresh();
}
function saveEditor(){
  const text = content.innerText.trim();
  save({id:currentId||Date.now().toString(),title:text.slice(0,20),content:content.innerHTML,timestamp:Date.now()});
  closeEditor();
}

/* ================= åˆªé™¤å…¨éƒ¨ + Undo ================= */
let lastDeletedNotes=null;
let undoTimer=null;

async function deleteAllNotes(){
  if(!confirm("âš ï¸ ç¢ºå®šåˆªé™¤æ‰€æœ‰å‚™å¿˜éŒ„ï¼Ÿ")) return;
  lastDeletedNotes = await getAll();
  await removeAll();
  refresh();

  const undoBtn = document.getElementById("undoBtn");
  undoBtn.style.display="inline-block";

  clearTimeout(undoTimer);
  undoTimer = setTimeout(()=>{ lastDeletedNotes=null; undoBtn.style.display="none"; },10000);

  alert("ğŸ§¹ å·²åˆªé™¤ï¼Œå¯æ–¼ 10 ç§’å…§å¾©åŸ");
}

async function undoDeleteAll(){
  if(!lastDeletedNotes || !lastDeletedNotes.length) return;
  for(const note of lastDeletedNotes) save(note);
  lastDeletedNotes=null;
  document.getElementById("undoBtn").style.display="none";
  refresh();
  alert("â†©ï¸ å·²å¾©åŸ");
}

/* ================= å•Ÿå‹• ================= */
window.addEventListener("load",async()=>{
  await openDB();
  refresh();

  document.getElementById("exportBtn").addEventListener("click",exportSecure);
  const importBtn=document.getElementById("importBtn");
  const backupFile=document.getElementById("backupFile");

  importBtn.addEventListener("click",()=>{ backupFile.value=""; backupFile.click(); });
  backupFile.addEventListener("change",()=>{ if(backupFile.files.length) importSecure(backupFile.files[0]); });
});
</script>

</body>
</html>
