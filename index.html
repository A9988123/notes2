<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>備忘錄</title>

<style>
body {
    margin: 0;
    font-family: -apple-system, system-ui;
    background: #f5f5f5;
}
header {
    padding: 14px;
    font-size: 22px;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
}
#noteList { padding: 10px; }
.note-item {
    background: #fff;
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.note-title { font-size: 16px; font-weight: 500; }
.note-sub { font-size: 12px; color: #888; }
#fab {
    position: fixed;
    right: 18px;
    bottom: 18px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #4a90e2;
    color: #fff;
    font-size: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}
#editor {
    position: fixed;
    inset: 0;
    background: #f5f5f5;
    display: none;
    flex-direction: column;
}
#editorHeader {
    background: #4a90e2;
    color: #fff;
    padding: 10px;
    display: flex;
    justify-content: space-between;
}
#content {
    flex: 1;
    padding: 12px;
    background: #fff;
    margin: 10px;
    border-radius: 10px;
    border: 1px solid #ccc;
}
.panel {
    position: fixed;
    inset: 0;
    background: #f5f5f5;
    display: none;
    flex-direction: column;
    z-index: 9999;
}
.panel-header {
    padding: 10px;
    background: #4a90e2;
    color: #fff;
}
</style>
</head>

<body>

<header>
    <span>備忘錄</span>
    <div>
        <button id="exportBtn">加密匯出</button>
        <button id="importBtn">匯入</button>
        <button onclick="deleteAllNotes()">刪除全部</button>
    </div>
</header>

<div id="noteList"></div>
<div id="fab" onclick="newNote()">＋</div>

<div id="editor">
    <div id="editorHeader">
        <button onclick="closeEditor()">返回</button>
        <button onclick="saveEditor()">存檔</button>
    </div>
    <div id="content" contenteditable="true"></div>
</div>

<!-- 密碼輸入面板 -->
<div id="passwordPanel" class="panel">
    <div class="panel-header">
        <button onclick="closePassword()">返回</button>
        <span style="margin-left:10px;">輸入密碼</span>
    </div>
    <div style="padding:20px;">
        <input id="passwordInput" type="password"
            placeholder="請輸入密碼"
            style="width:100%;font-size:18px;padding:10px;">
        <button onclick="confirmExport()"
            style="margin-top:15px;width:100%;padding:12px;">
            確認加密匯出
        </button>
    </div>
</div>

<!-- 匯出結果面板 -->
<div id="exportPanel" class="panel">
    <div class="panel-header">
        <button onclick="closeExport()">返回</button>
        <span style="margin-left:10px;">加密匯出</span>
    </div>
    <p style="padding:10px;">
        請「全選 → 複製」，另存成 <b>notes.simple.txt</b>
    </p>
    <textarea id="exportText"
        style="flex:1;margin:10px;border-radius:8px;"></textarea>
</div>

<input type="file" id="backupFile" hidden>

<script>
/* IndexedDB */
const DB_NAME = "memoDB";
const STORE = "notes";
let db;

function openDB() {
    return new Promise(res => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = e =>
            e.target.result.createObjectStore(STORE, { keyPath: "id" });
        req.onsuccess = e => { db = e.target.result; res(); };
    });
}

function save(note) {
    db.transaction(STORE, "readwrite").objectStore(STORE).put(note);
}

function getAll() {
    return new Promise(res => {
        const r = db.transaction(STORE).objectStore(STORE).getAll();
        r.onsuccess = () => res(r.result || []);
    });
}

function removeAll() {
    db.transaction(STORE, "readwrite").objectStore(STORE).clear();
}

/* 匯出流程（手機安全） */
function openPassword() {
    passwordInput.value = "";
    passwordPanel.style.display = "flex";
}

async function confirmExport() {
    const pwd = passwordInput.value;
    if (!pwd) return alert("請輸入密碼");

    const notes = await getAll();
    exportText.value = simpleEncrypt(JSON.stringify(notes), pwd);

    passwordPanel.style.display = "none";
    exportPanel.style.display = "flex";
}

function closePassword() {
    passwordPanel.style.display = "none";
}

function closeExport() {
    exportPanel.style.display = "none";
}

/* 匯入 */
async function importSecure(file) {
    const pwd = prompt("請輸入密碼");
    if (!pwd) return;
    try {
        const json = simpleDecrypt(await file.text(), pwd);
        JSON.parse(json).forEach(n => save({ ...n, id: Date.now()+Math.random() }));
        refresh();
        alert("✅ 匯入完成");
    } catch {
        alert("❌ 匯入失敗");
    }
}

/* UI */
async function refresh() {
    noteList.innerHTML = "";
    (await getAll()).sort((a,b)=>b.timestamp-a.timestamp).forEach(n => {
        const d = document.createElement("div");
        d.className = "note-item";
        d.innerHTML = `<div><div class="note-title">${n.title}</div>
        <div class="note-sub">${new Date(n.timestamp).toLocaleString()}</div></div>`;
        d.onclick = () => openEditor(n.id);
        noteList.appendChild(d);
    });
}

let currentId = null;
function newNote(){ currentId=null; content.innerHTML=""; openEditor(); }

async function openEditor(id){
    currentId=id;
    if(id){
        const n=(await getAll()).find(x=>x.id===id);
        content.innerHTML=n?.content||"";
    }
    editor.style.display="flex";
    noteList.style.display=fab.style.display="none";
}
function closeEditor(){
    editor.style.display="none";
    noteList.style.display=fab.style.display="";
    refresh();
}
function saveEditor(){
    save({id:currentId||Date.now(),title:content.innerText.slice(0,20),
        content:content.innerHTML,timestamp:Date.now()});
    closeEditor();
}
function deleteAllNotes(){
    if(confirm("確定刪除全部？")){ removeAll(); refresh(); }
}

/* 簡單加解密 */
function simpleEncrypt(t,p){
    return btoa([...t].map((c,i)=>String.fromCharCode(
        c.charCodeAt(0)^p.charCodeAt(i%p.length))).join(""));
}
function simpleDecrypt(b,p){
    return [...atob(b)].map((c,i)=>String.fromCharCode(
        c.charCodeAt(0)^p.charCodeAt(i%p.length))).join("");
}

/* 啟動 */
window.onload = async ()=>{
    await openDB();
    refresh();
    exportBtn.onclick = openPassword;
    importBtn.onclick = ()=>backupFile.click();
    backupFile.onchange = ()=>importSecure(backupFile.files[0]);
};
</script>

</body>
</html>
