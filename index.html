<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>備忘錄</title>

<style>
body {
    margin: 0;
    font-family: -apple-system, system-ui;
    background: #f5f5f5;
}
header {
    padding: 14px;
    font-size: 22px;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
}
#noteList { padding: 10px; }
.note-item {
    background: #fff;
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.note-title { font-size: 16px; font-weight: 500; }
.note-sub { font-size: 12px; color: #888; }
.delete-btn {
    background: #ff4d4d;
    color: #fff;
    padding: 6px 12px;
    border: none;
    border-radius: 5px;
    font-size: 12px;
}
#fab {
    position: fixed;
    right: 18px;
    bottom: 18px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #4a90e2;
    color: #fff;
    font-size: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}
#editor {
    position: fixed;
    inset: 0;
    background: #f5f5f5;
    display: none;
    flex-direction: column;
}
#editorHeader {
    background: #4a90e2;
    color: #fff;
    padding: 10px;
    display: flex;
    justify-content: space-between;
}
#content {
    flex: 1;
    padding: 12px;
    background: #fff;
    margin: 10px;
    border-radius: 10px;
    border: 1px solid #ccc;
    overflow: auto;
}
</style>
</head>

<body>

<header>
    <span>備忘錄</span>
    <div>
        <button id="exportBtn">加密匯出</button>
        <button id="importBtn">匯入</button>
        <button onclick="deleteAllNotes()">刪除全部</button>
    </div>
</header>

<div id="noteList"></div>
<div id="fab" onclick="newNote()">＋</div>

<div id="editor">
    <div id="editorHeader">
        <button onclick="closeEditor()">返回</button>
        <button onclick="saveEditor()">存檔</button>
    </div>
    <div id="content" contenteditable="true"></div>
</div>

<input type="file" id="backupFile" accept=".secure.txt" hidden>

<script src="./jszip.min.js"></script>
<script src="./crypto-js.min.js"></script>

<script>
/* ================= IndexedDB ================= */
const DB_NAME = "memoDB";
const STORE = "notes";
let db;

function openDB() {
    return new Promise((res, rej) => {
        const req = indexedDB.open(DB_NAME, 1);
        req.onupgradeneeded = e => {
            const d = e.target.result;
            if (!d.objectStoreNames.contains(STORE)) {
                d.createObjectStore(STORE, { keyPath: "id" });
            }
        };
        req.onsuccess = e => { db = e.target.result; res(); };
        req.onerror = rej;
    });
}

function save(note) {
    db.transaction(STORE, "readwrite").objectStore(STORE).put(note);
}

function getAll() {
    return new Promise(res => {
        const r = db.transaction(STORE).objectStore(STORE).getAll();
        r.onsuccess = () => res(r.result || []);
    });
}

function removeAll() {
    return db.transaction(STORE, "readwrite").objectStore(STORE).clear();
}

/* ================= ZIP ================= */
async function buildZip() {
    const zip = new JSZip();
    const notes = await getAll();

    let html = `<!DOCTYPE html><html><meta charset="utf-8"><body>`;
    notes.forEach(n => {
        html += `<h2>${n.title}</h2><div>${n.content}</div><hr>`;
    });
    html += `</body></html>`;

    zip.file("index.html", html);
    return zip.generateAsync({ type: "uint8array" });
}

/* ================= Crypto (Safari-safe) ================= */
async function encryptZip(zipData, password) {
    const wordArray = CryptoJS.lib.WordArray.create(zipData);
    return CryptoJS.AES.encrypt(wordArray, password).toString(); // Base64
}

async function decryptZip(base64, password) {
    const decrypted = CryptoJS.AES.decrypt(base64, password);
    if (decrypted.sigBytes <= 0) throw "decrypt failed";

    const words = decrypted.words;
    const bytes = new Uint8Array(decrypted.sigBytes);
    let i = 0;
    for (let w of words) {
        for (let b = 3; b >= 0 && i < bytes.length; b--) {
            bytes[i++] = (w >> (8 * b)) & 0xff;
        }
    }
    return bytes;
}

/* ================= 匯出 ================= */
async function exportSecure() {
    const pwd = prompt("請輸入加密密碼");
    if (!pwd) return;

    try {
        const zipData = await buildZip();
        const encrypted = await encryptZip(zipData, pwd);
        const blob = new Blob([encrypted], { type: "text/plain" });

        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "notes.secure.txt";
        a.click();
        URL.revokeObjectURL(a.href);
    } catch {
        alert("❌ 匯出失敗");
    }
}

/* ================= 匯入 ================= */
async function importSecure(file) {
    const pwd = prompt("請輸入加密密碼");
    if (!pwd) return;

    try {
        const base64 = await file.text();
        const zipData = await decryptZip(base64, pwd);
        const zip = await JSZip.loadAsync(zipData);
        const html = await zip.file("index.html").async("text");

        const div = document.createElement("div");
        div.innerHTML = html;

        for (const h of div.querySelectorAll("h2")) {
            save({
                id: Date.now() + Math.random(),
                title: h.textContent,
                content: h.nextElementSibling?.innerHTML || "",
                timestamp: Date.now()
            });
        }
        refresh();
        alert("✅ 匯入完成");
    } catch {
        alert("❌ 解密失敗（密碼錯誤或檔案損毀）");
    }
}

/* ================= UI ================= */
async function refresh() {
    const list = document.getElementById("noteList");
    list.innerHTML = "";
    const notes = await getAll();

    notes.sort((a,b)=>b.timestamp-a.timestamp).forEach(n => {
        const d = document.createElement("div");
        d.className = "note-item";
        d.innerHTML = `<div>
            <div class="note-title">${n.title}</div>
            <div class="note-sub">${new Date(n.timestamp).toLocaleString()}</div>
        </div>`;
        d.onclick = () => openEditor(n.id);
        list.appendChild(d);
    });
}

let currentId = null;

function newNote() {
    currentId = null;
    content.innerHTML = "";
    openEditor();
}

async function openEditor(id) {
    currentId = id;
    if (id) {
        const n = (await getAll()).find(x => x.id === id);
        content.innerHTML = n?.content || "";
    }
    editor.style.display = "flex";
    noteList.style.display = "none";
    fab.style.display = "none";
}

function closeEditor() {
    editor.style.display = "none";
    noteList.style.display = "";
    fab.style.display = "";
    refresh();
}

function saveEditor() {
    save({
        id: currentId || Date.now(),
        title: content.innerText.slice(0,20),
        content: content.innerHTML,
        timestamp: Date.now()
    });
    closeEditor();
}

function deleteAllNotes() {
    if (confirm("確定刪除全部？")) {
        removeAll();
        refresh();
    }
}

/* ================= 啟動 ================= */
window.onload = async () => {
    await openDB();
    refresh();
    exportBtn.onclick = exportSecure;
    importBtn.onclick = () => backupFile.click();
    backupFile.onchange = () => backupFile.files[0] && importSecure(backupFile.files[0]);
};
</script>
</body>
</html>
