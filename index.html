<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Firebase 即時聊天</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
body { margin:0; font-family:-apple-system,system-ui; background:#f5f5f5; }
header { padding:14px; font-size:20px; font-weight:600; background:#4a90e2; color:#fff; }
#roomList { padding:10px; }
.room { background:#fff; border-radius:12px; padding:12px; margin-bottom:10px; cursor:pointer; }
#chatView { position:fixed; inset:0; background:#f5f5f5; display:none; flex-direction:column; }
#chatMessages { flex:1; padding:10px; overflow-y:auto; }
.msg { max-width:70%; padding:10px; margin:6px; border-radius:14px; }
.me { background:#4a90e2; color:#fff; margin-left:auto; }
.other { background:#e5e5ea; }
#chatInput { display:flex; padding:10px; background:#fff; }
#msgInput { flex:1; padding:10px; }
</style>
</head>

<body>
<header>Firebase 即時聊天</header>
<div id="roomList"></div>

<div id="chatView">
  <button onclick="closeChat()">← 返回</button>
  <div id="chatMessages"></div>
  <div id="chatInput">
    <input id="msgInput" placeholder="輸入訊息" />
    <button onclick="sendMsg()">送出</button>
  </div>
</div>

<script>
/* ========= Firebase ========= */
const firebaseConfig = {
  apiKey: "AIzaSyAqrxYREvkIor__6RrI_JrdP94jkfmw05M",
  authDomain: "multi-party-chat.firebaseapp.com",
  databaseURL: "https://multi-party-chat-default-rtdb.firebaseio.com",
  projectId: "multi-party-chat"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const auth = firebase.auth();

/* ========= State ========= */
let myId = null;
let currentRoomId = null;

/* ========= Auth ========= */
auth.signInAnonymously().then(res => {
  myId = res.user.uid;
  init();
});

/* ========= Init ========= */
function init(){
  ensurePublicRoom();
  loadRooms();
}

/* ========= Rooms ========= */
function ensurePublicRoom(){
  const roomRef = db.ref("rooms/public");
  roomRef.once("value", snap=>{
    if(!snap.exists()){
      roomRef.set({
        title: "公開聊天室",
        members: {}
      });
    }
  });

  roomRef.child("members/"+myId).set(true);
}

function loadRooms(){
  db.ref("rooms").on("value", snap=>{
    roomList.innerHTML="";
    snap.forEach(room=>{
      const data = room.val();
      const div = document.createElement("div");
      div.className="room";
      div.textContent = data.title || room.key;
      div.onclick = ()=>openRoom(room.key, data.title);
      roomList.appendChild(div);
    });
  });
}

function openRoom(roomId, title){
  currentRoomId = roomId;
  chatMessages.innerHTML="";
  chatView.style.display="flex";
  listenMessages(roomId);
}

/* ========= Chat ========= */
function sendMsg(){
  const text = msgInput.value.trim();
  if(!text || !currentRoomId) return;

  db.ref("messages/"+currentRoomId).push({
    from: myId,
    text,
    time: Date.now()
  });

  msgInput.value="";
}

function listenMessages(roomId){
  db.ref("messages/"+roomId).off();
  db.ref("messages/"+roomId).on("child_added", snap=>{
    const m = snap.val();
    const d = document.createElement("div");
    d.className="msg "+(m.from===myId?"me":"other");
    d.textContent = m.text;
    chatMessages.appendChild(d);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  });
}

function closeChat(){
  chatView.style.display="none";
  currentRoomId = null;
}
</script>
</body>
</html>
